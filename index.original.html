<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Verdant Atlas â€” interactive planting calendar for Zone 5b. 147 flower varieties with timelines, bloom dates, and garden planning tools.">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta property="og:title" content="Verdant Atlas">
    <meta property="og:description" content="Plan your flower garden with 147 heirloom varieties. Interactive timelines, bloom charts, and My Garden planning for Zone 5b.">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ±</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ±</text></svg>">
    <title>Verdant Atlas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
      body { background: #f8fafc; color: #1e293b; }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .species-card { transition: all 0.15s ease; }
      .species-card-collapsed { border-left: 3px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
      .species-card-expanded { border-left: 3px solid #6366f1; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .species-name-btn { border-radius: 4px; transition: background-color 0.1s ease; }
      .species-name-btn:hover { background-color: #f1f5f9; }
      .variety-chip { transition: all 0.15s ease; border-radius: 6px; }
      .variety-chip:hover { background-color: #f1f5f9 !important; }
      .filter-btn { transition: all 0.15s ease; border-radius: 4px; min-height: 44px; min-width: 44px; }
      select { min-height: 44px; }
      .species-name-btn { min-height: 44px; }
      .segment-group { display: inline-flex; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; }
      .segment-group button { border-radius: 0; border: none; margin: 0; }
      .segment-group button:not(:last-child) { border-right: 1px solid #e2e8f0; }
      .modal-enter { animation: modalIn 0.2s ease-out; }
      @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }
      .backdrop-enter { animation: fadeIn 0.15s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .year-bar-seg { transition: opacity 0.15s ease; }
      .year-bar-seg:hover { opacity: 0.75; }
      .year-bar-tooltip { position: absolute; bottom: calc(100% + 8px); transform: translateX(-50%); background: #1e293b; color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 11px; line-height: 1.4; white-space: nowrap; pointer-events: none; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
      .year-bar-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 5px solid transparent; border-top-color: #1e293b; }
      .card-expand-enter { animation: cardExpand 0.25s ease-out; overflow: hidden; }
      @keyframes cardExpand { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 2000px; } }
      @keyframes shimmer {
        0% { background-position: -200px 0; }
        100% { background-position: 200px 0; }
      }
      .img-skeleton {
        background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
        background-size: 200px 100%;
        animation: shimmer 1.5s infinite;
      }
      input:focus, select:focus { outline: none; border-color: #6366f1 !important; box-shadow: 0 0 0 2px rgba(99,102,241,0.15); }
      input, select { color: #1e293b; background: #fff; }
      input::placeholder { color: #94a3b8; }
      option { background: #fff; color: #1e293b; }
      a { color: #1e293b; }
      .gantt-row:hover { background-color: #f1f5f9 !important; }
      @media print {
        body { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body::before, body::after { display: none !important; }
        .sticky { position: relative !important; }
        .sticky.top-0 { display: none !important; }
        .species-card { break-inside: avoid; page-break-inside: avoid; border: 1px solid #ccc !important; margin-bottom: 8px !important; }
        .variety-chip { break-inside: avoid; }
        button[aria-label], .filter-btn { display: none !important; }
        .fixed.inset-0 { display: none !important; }
        .fixed.z-30 { display: none !important; }
        .year-bar-seg { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        [style*="backgroundColor: #f1f5f9"] { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .variety-chip .absolute.z-10 { display: none !important; }
        @page { margin: 0.75in; }
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useCallback } = React;
const IMG_BASE = 'https://res.cloudinary.com/rareseeds/image/upload/c_fit,w_400,h_400/f_auto,q_auto,dpr_auto/v1/';
const IMAGE_MAP = {
  "agastache-anise-hyssop": "media/catalog/product/h/y/hyssop2-dark-purple-anise-lss-dsc_9247.jpg",
  "agastache-apache-sunset": "media/catalog/product/a/g/agastache-apache-sunset-lss-dsc_3459.jpg",
  "agastache-apricot-sprite": "media/catalog/product/a/g/agastache-apricot-sprite-lss-dsc_2478.jpg",
  "agastache-seeds-astello-indigo": "media/catalog/product/a/g/agastache-astello-indigo-lss-dsc_9403.jpg",
  "agastache-fragrant-delight-mix": "media/catalog/product/a/g/agastache-fragrant-delight-mix-lss-dsc_6050.jpg",
  "agastache-lavender-martini": "media/catalog/product/a/g/agastache2-lavender-martini-lss-dsc_0278_1_.jpg",
  "agastache-seeds-liquorice-white": "media/catalog/product/a/g/agastache-licorice-white-w-butterfly-lss-dsc_3588.jpg",
  "agastache-navajo-sunset": "media/catalog/product/a/g/agastache-navajo-sunset-lah-_dsf1400.jpg",
  "agastache-raspberry-daiquiri": "media/catalog/product/a/g/agastache2-raspberry-daquiri-lss-dsc_8575.jpg",
  "agastache-rose-mint": "media/catalog/product/a/g/agastache-rose-mint-lss-dsc_8500_1.jpg",
  "agastache-sunset-yellow": "media/catalog/product/a/g/agastache-hyssop-sunset-yellow-lss-dsc_6368.jpg",
  "agastache-texas-hummingbird-mint-heather-queen": "media/catalog/product/a/g/agastache-mosquito-plant-or-texas-hummingbird-mint2-heather-queen-hb272-lss-dsc_5175.jpg",
  "ageratum-ball-mixed": "media/catalog/product/a/g/ageratum2-ball-mixed-lss-dsc_3405.jpg",
  "ageratum-leda": "media/catalog/product/p/i/pix_1080x1080-ageratum-seeds-leda.jpg",
  "ageratum-red-flint": "media/catalog/product/a/g/ageratum2-red-flint-lss-dsc_9996.jpg",
  "armeria-maritima-morning-star-deep-rose": "media/catalog/product/a/m/ameria-morning-star-deep-rose-lss-dsc_2920.jpg",
  "armeria-maritima-seeds-morning-star-white": "media/catalog/product/a/r/armeria-mantima-morning-star-white-lss-dsc_8714.jpg",
  "baby-s-breath-seeds-covent-garden": "media/catalog/product/b/a/babys-breath-covent-garden-lss-dsc_4028.jpg",
  "baby-s-breath-festival-star": "media/catalog/product/b/a/babys-breath-rosea-lss-dsc_3722.jpg",
  "babys-breath-kermesina": "media/catalog/product/b/a/babys-breath-carmine-from-applewood-lss-dsc_6717.jpg",
  "bachelor-s-button-seeds-black-ball": "media/catalog/product/b/a/bachelors3-button-black-boy-lss-dsc_4167.jpg",
  "bachelor-s-button-blue-boy": "media/catalog/product/b/a/bachelor3-button-blue-boy-lss-dsc_5525.jpg",
  "bachelor-s-button-classic-fantastic": "media/catalog/product/b/a/bachelor2-button-classic-fantastic-lss-dsc_5755.jpg",
  "bachelor-s-button-classic-romantic": "media/catalog/product/b/a/bachelor2-button-classic-romantic-lss-dsc_6066.jpg",
  "bachelor-s-button-double-blue": "media/catalog/product/b/a/bachelors3-button-classic-artistic-lss-dsc_1960.jpg",
  "bachelor-s-button-dwarf-blue-midget": "media/catalog/product/b/a/bachelors-button-classic-magic-lss-dsc_7374.jpg",
  "bachelors-button-emperor-william": "media/catalog/product/b/a/bachelors-button-fireworks-lss-dsc_7127.jpg",
  "bachelor-s-button-pinkie": "media/catalog/product/b/a/bachelor-button-tall-double-pinkie-lss-dsc_6129.jpg",
  "bachelor-s-button-polka-dot-mix": "media/catalog/product/b/a/bachelor-button-tall-double-lavender-lady-lss-dsc_5644.jpg",
  "bachelor-s-button-red-ball": "media/catalog/product/b/a/bachelors-button-red-boy-lss-dsc_7376.jpg",
  "balloon-flower-astra-blue": "media/catalog/product/b/a/balloon_flower_fuji_blue_lss_dsc_0327_1x1_1200x1200.jpg",
  "balloon-flower-astra-mix": "media/catalog/product/b/a/balloon_flower_fairy_snow_spots_removed_retouched_lss_dsc_0286_1x1_1400x1400.jpg",
  "balloon-flower-astra-pink": "media/catalog/product/b/a/balloon-flower-fuji-pink-lss-dsc_0181.jpg",
  "balloon-flower-astra-white": "media/catalog/product/b/a/balloon-flower-fuji-white-lss-dsc_0363.jpg",
  "balsam-peppermint-stick": "media/catalog/product/b/a/balsam-peppermint-stick-placeholder.jpg",
  "black-eyed-susan-vine-seeds-african-sunset-mix": "media/catalog/product/b/l/black-eyed-susan-vine-african-sunset-mix-lss-000_6929.jpg",
  "black-eyed-susan-vine-seeds-spanish-eyes": "media/catalog/product/b/l/black-eyed-susan-vine-spanish-eyes-lss-dsc_1360.jpg",
  "butterfly-pea-blue-queen": "media/catalog/product/b/u/butterfly_pea_thai_double_blue_lss_dsc_7174_1x1_850x850.jpg",
  "butterfly-pea-lavender-queen": "media/catalog/product/b/u/butterfly_pea_double_double_lavender_queen_lss_dsc_7743_1x1_850x850_1.jpg",
  "butterfly-pea-seeds-thai-double-blue": "media/catalog/product/s/e/seed-packet-butterfly-pea-thai-blue-lss-dsc_5511.jpg",
  "butterfly-pea-seeds-thai-double-sky-blue": "Butterfly_Pea_Thai_Double_Sky_Blue_mf3qk8.jpg",
  "butterfly-pea-white-queen": "media/catalog/product/p/e/pea_white_butterfly_dsc07799__1x1_1200x1200.jpg",
  "calendula-ball-s-improved-orange": "media/catalog/product/c/a/calendula_balls_improved_orange.jpg",
  "calendula-orange-king": "media/catalog/product/c/a/calendula-orange-king-lss-dsc_7661.jpg",
  "calendula-seeds-orange-porcupine": "media/catalog/product/c/a/calendula_orange_porcupine.jpg",
  "calendula-pacific-beauty-mix": "media/catalog/product/c/a/calendula_pacific_mix_lss_dsc_2459_1x1_1200x1200.jpg",
  "calendula-pink-surprise": "media/catalog/product/c/a/calendula_pink_surprise_lss_dsc_4738_1x1_1200x1200.jpg",
  "calendula-playtime-mix": "media/catalog/product/c/a/calendula_playtime_mix_lss_dsc_3430_1x1_1200x1200.jpg",
  "calendula-snow-princess": "media/catalog/product/c/a/calendula_snow_princess.jpg",
  "calendula-touch-of-red": "media/catalog/product/c/a/calendula-strawberry-blonde-lss-dsc_4306.jpg",
  "calendula-zeolights": "media/catalog/product/c/a/calendula_seeds_yellow_porcupine-lss-dsc_7628.jpg",
  "cockscomb-seeds-asian-garden": "media/catalog/product/c/e/celosia_asian_garden.jpg",
  "celosia-bombay-dark-red": "media/catalog/product/c/e/celosia-eternity-mix-lss-dsc_3010.jpg",
  "celosia-bombay-fireball": "media/catalog/product/c/e/celosia_flamingo_feathers_lss_dsc_0933_1x1_1200x1200.jpg",
  "celosia-bombay-mix": "media/catalog/product/c/e/celosia_higyoku_red_stem_lss_dsc_9450_1x1_1200x1200.jpg",
  "celosia-bombay-orange": "media/catalog/product/c/e/celosia_cockscomb_indiana_giant_lss_dsc_5524_1x1_1200x1200.jpg",
  "celosia-bombay-purple": "media/catalog/product/c/e/celosia_jessica_mix_cockscomb_zs016_1x1_1200x1200.jpg",
  "celosia-bombay-yellow": "media/catalog/product/c/e/celosia_kurume_kumquat_lss_dsc_3658_1x1_1200x1200.jpg",
  "celosia-celway-mix": "media/catalog/product/c/e/celosia-cockscomb-lightening-yellow-lss-file418.jpg",
  "celosia-chief-gold": "media/catalog/product/c/e/celosia-cockscomb-mad-magenta-lss-dsc_7012.jpg",
  "celosia-chief-mix": "media/catalog/product/c/e/celosia-cockscomb-orient-no-2-lss-dsc_8754.jpg",
  "celosia-chief-persimmon": "media/catalog/product/c/e/celosia2-plumosa-glorious-mix-kad-dscf2700.jpg",
  "celosia-chief-rose": "media/catalog/product/c/e/celosia-rainbow-sherbert-lss-dsc_3623_1.jpg",
  "cockscomb-seeds-coral-garden-mix": "media/catalog/product/c/e/celosia-cockscomb-raven-red-brianiac-mix-lss-file313.jpg",
  "cockscomb-cramers-burgundy": "media/catalog/product/c/e/celosia-cockscomb-think-pink-brianiac-lss-file360.jpg",
  "cockscomb-seeds-cramers-mix": "media/catalog/product/c/e/celosia_tornado_red_cockcomb.jpg",
  "celosia-dracula": "media/catalog/product/c/e/celosia-cockscomb-variegated-lss-dsc_5330.jpg",
  "celosia-intenz": "media/catalog/product/c/e/celosia2-yachiyo-hiryu-lss-dsc_3716.jpg",
  "celosia-kurume-new-red": "media/catalog/product/c/e/celosia2-yachiyo-karyu-lss-dsc_3766.jpg",
  "cockscomb-seeds-orange-queen": "media/catalog/product/c/e/celosia2-yachiyo-kinpou-lss-dsc_3614.jpg",
  "cockscomb-pampas-plume-mix": "media/catalog/product/c/e/celosia2-yellow-queen-lss-dsc_3648.jpg",
  "celosia-sunday-gold": "media/catalog/product/c/e/celosia_chinese_wool_flower_lss_dsc_4716_1x1_1200x1200.jpg",
  "celosia-sylphid": "media/catalog/product/c/e/celosia-green-sylphid-lss-dsc_3687.jpg",
  "celosia-toreador": "media/catalog/product/s/c/scenic-celosia-in-restaurant-garden-lss-dsc_8121.jpg",
  "crimson-clover-seeds": "media/catalog/product/g/r/grains-and-cover-crops-crimson-clover-lss-dsc_8134.jpg",
  "red-clover-seeds": "media/catalog/product/c/l/clover-red-feathers-lss-dsc_9933.jpg",
  "coleus-black-dragon": "media/catalog/product/c/o/coleus-seeds-colocha-chocolate-green-exp-lss-dsc_0024.jpg",
  "coleus-carefree-mix": "media/catalog/product/c/o/coleus-colocha-red-exp-lss-dsc_6656.jpg",
  "coleus-chocolate-mint": "media/catalog/product/c/o/coleus2-colocha-rose-zs004-_1_.jpg",
  "coleus-fairway-mix": "media/catalog/product/c/o/coleus2-colocha-scarlet_sunset-zs018_1_.jpg",
  "coleus-kong-mix": "media/catalog/product/c/o/coleus2-folia-mosaic-zs013.jpg",
  "coleus-premium-sun-mix": "media/catalog/product/c/o/coleus2-folia-picasso-zs011.jpg",
  "coleus-rainbow-mix": "media/catalog/product/c/o/coleus2-folia-sunset-zs004.jpg",
  "coleus-wizard-mix": "media/catalog/product/c/o/coleus2-folia-velvet-zs040.jpg",
  "coleus-wizard-velvet-red": "media/catalog/product/c/o/coleus2-pinto-mix-lss-dsc_8760.jpg",
  "columbine-barlow-mix": "media/catalog/product/c/o/columbine-double-mixed-lss-dsc_6830.jpg",
  "columbine-mckana-giant-mix": "media/catalog/product/c/o/columbine-leprechaun-gold-lss-dsc_1642_1.jpg",
  "columbine-winky-mix": "media/catalog/product/c/o/columbine-rose-barlow-lss-dsc_3960.jpg",
  "coreopsis-early-sunrise": "media/catalog/product/c/o/coreopsis-incredible-dwarf-mix-lss-dsc_5697.jpg",
  "coreopsis-mardi-gras": "media/catalog/product/c/o/coreopsis-incredible-sea-shells-mix-lss-dsc_2569.jpg",
  "coreopsis-plains": "media/catalog/product/c/o/coreopsis-incredible-swirl-lss-dsc_2018.jpg",
  "coreopsis-tall-mix": "media/catalog/product/c/o/coreopsis2-yellow-fluffy-double-lss-dsc_9229.jpg",
  "cosmos-apricot-lemonade": "media/catalog/product/c/o/cosmos-apricot-lemonade-lss-dsc_9223.jpg",
  "cosmos-apricotta": "media/catalog/product/c/o/cosmos-apricotta-lss-dsc_8636.jpg",
  "cosmos-black-magic-chocolate": "media/catalog/product/c/o/cosmos_black_magic.jpg",
  "cosmos-bright-lights": "media/catalog/product/c/o/cosmos_bright_lights.jpg",
  "cosmos-candyfloss-pink-sunrise": "media/catalog/product/c/o/cosmos_candyfloss_pink_sunrise.jpg",
  "cosmos-candyfloss-red": "media/catalog/product/c/o/cosmos-candyfloss-red-lss-dsc_7669.jpg",
  "cosmos-cosmic-orange": "media/catalog/product/c/o/cosmos2-cosmic-orange-zs002.jpg",
  "cosmos-cosmic-red": "media/catalog/product/c/o/cosmos2-cosmic-red-lss-dsc_4490.jpg",
  "cosmos-cosmic-yellow": "media/catalog/product/c/o/cosmos2-cosmic-yellow-lss-dsc_9030.jpg",
  "cosmos-double-dutch-rose": "media/catalog/product/c/o/cosmos-double-dutch-rose-lss-dsc_8765.jpg",
  "cosmos-fizzy-rose-picotee": "media/catalog/product/c/o/cosmos-fizzy-rose-picotee-op-lss--dsc_8544.jpg",
  "cosmos-japanese-kiiro": "media/catalog/product/c/o/cosmos_japanese_kiiro.jpg",
  "cosmos-rubenza": "media/catalog/product/c/o/cosmos--rubenza-zs026.jpg",
  "cosmos-sensation-mix": "media/catalog/product/c/o/cosmos-sea-shells-or-seashells-hand-dyed-yarn-lss-dsc_7064.jpg",
  "cosmos-xanthos": "media/catalog/product/c/o/cosmos-xanthos-lss-dsc_6980.jpg",
  "dahlia-bishops-children": "media/catalog/product/d/a/dahlia-seeds-black-beauty-zs006.jpg",
  "dahlia-cactus-hybrids-mix": "media/catalog/product/d/a/dahlia_cactus_flowered_mix_from_sahin_lss_dsc_8586_850x850.jpg",
  "dahlia-dandy-mix": "media/catalog/product/d/a/dahlia_dandy_improved_lss_dsc_1990_850x850.jpg",
  "dahlia-night-butterfly": "media/catalog/product/d/a/dahlia-seeds-black-forest-ruby-lss-dsc_9512.jpg",
  "dahlia-opera-mix": "media/catalog/product/d/a/dahlia_mignon_single_mix_lss_dsc_1402_850x850.jpg",
  "dahlia-unwins-dwarf-mix": "media/catalog/product/f/l/flower_dahlia_unwin_s_dsc05701_850x850.jpg",
  "daisy-bellissima-mix": "media/catalog/product/d/a/daisy_white_or_blue_disc_lss_dsc_9989_850x850.jpg",
  "daisy-crazy-daisy": "media/catalog/product/d/a/daisy_crazy_lss_dsc_7070_850x850.jpg",
  "daisy-pomponette-mix": "media/catalog/product/d/a/daisy_chocolate_lss_dsc_9876_850x850.jpg",
  "daisy-robinsons-mix": "media/catalog/product/d/a/daisy2-dahlberg-lss-dsc_5738.jpg",
  "daisy-rominette-mix": "media/catalog/product/s/e/seed-packet-chamomile-kelway-golden-lss-dsc_9847.jpg",
  "daisy-snow-lady": "media/catalog/product/d/a/daisy_livingstone_pastel_mixed_lss_dsc_7201_850x850.jpg",
  "daisy-super-enorma-mix": "media/catalog/product/d/a/daisy-hero2-paper-from-applewood-kad-l1040871.jpg",
  "daisy-tasso-mix": "media/catalog/product/d/a/daisy_swan_river_mix_lss_dsc_0327_850x850.jpg",
  "dandelion-ameliore": "media/catalog/product/s/e/seed-packet-chicory-imero-dandelion-zs006.jpg",
  "dandelion-clio": "media/catalog/product/c/h/chichory_dandelion_italiko_rosso_lss_dsc_0589-850x850.jpg",
  "dandelion-vert-de-montmagny": "media/catalog/product/d/a/dandelion_japanese_white_lss_dsc_3332_850x850.jpg",
  "dandelion-wild": "media/catalog/product/d/a/dandelion_pink_lss_dsc_5360_850x850.jpg",
  "dianthus-seeds-black-adder": "media/catalog/product/d/i/dianthus_black_adder.jpg",
  "dianthus-seeds-flora-mix": "FL647-Dianthus_Flora_Mix_2_vhf4s2.jpg",
  "dianthus-seeds-flora-pearl-appleblossom": "media/catalog/product/d/i/dianthus_floral_pearl_appleblossom.jpg",
  "dianthus-seeds-flora-pearl-salmon": "media/catalog/product/d/i/dianthus_floral_pearl_salmon.jpg",
  "dianthus-hollandia-purple-crown": "media/catalog/product/p/h/phlox_hollandia_purple_crown_lss_dsc_5305_850x850.jpg",
  "dianthus-raspberry-ripple": "media/catalog/product/d/i/dianthus_raspberry_ripple_lss_dsc_8586_850x850.jpg",
  "dianthus-spooky-mix": "media/catalog/product/d/i/dianthus_spooky_mix_lss_dsc_8297_850x850.jpg",
  "dianthus-zebra-crossing": "media/catalog/product/d/i/dianthus-zebra-crossing-lss-dsc_9550.jpg",
  "forget-me-not-seeds-bellamy-blue": "media/catalog/product/f/o/forget-me-not_bellamy_blue.jpg",
  "forget-me-not-seeds-bellamy-pink": "media/catalog/product/f/o/forget-me-not_bellamy_pink.jpg",
  "forget-me-not-seeds-bellamy-white": "media/catalog/product/s/e/seed-packet-forget-me-not-bellamy-white-lss-dsc_6667.jpg",
  "forget-me-not-seeds-blue-bird": "media/catalog/product/f/o/forget-me-not_blue_bird.jpg",
  "forget-me-not-seeds-sylva-rosylva": "media/catalog/product/f/o/forget-me-not-sylva-rosylva-lss-dsc_7812.jpg",
  "gaillardia-arizona-mix": "media/catalog/product/g/a/gaillardia-arizona-apricot-lss-dsc_0709.jpg",
  "gaillardia-lorenziana-double-mix": "media/catalog/product/g/a/gaillardia-seeds-arizona-red-shades-lss-dsc_5431.jpg",
  "gaillardia-sundance-bicolor": "media/catalog/product/g/a/galardia_double_sunset_lss_dsc_8689_850x850.jpg",
  "gaillardia-sundance-mix": "media/catalog/product/g/a/gaillardia-sundance-bicolor-placeholder.jpg",
  "gomphrena-atomic-purple": "media/catalog/product/g/o/gomphrena_atomic_purple_zs022_850x850.jpg",
  "gomphrena-buddy-mix": "media/catalog/product/g/o/gomphrena2-buddy-purple-zs012.jpg",
  "gomphrena-fireworks": "media/catalog/product/g/l/globosa_mixed_gomphrena_fl189_lss_000_6963_850x850.jpg",
  "gomphrena-qis-mix": "media/catalog/product/g/o/gomphrena2-lavender-lady-lss-dsc_7553.jpg",
  "gomphrena-qis-rose": "media/catalog/product/g/o/gomphrena_salmon_pastel_lss_dsc_8893_850x850.jpg",
  "gomphrena-strawberry-fields": "media/catalog/product/g/o/gomphrena_snow_white_zs006_850x850_1.jpg",
  "grass-frosted-explosion": "media/catalog/product/g/r/grass2-blue-buddy-zs001_1_.jpg",
  "grass-pampas": "media/catalog/product/g/r/grass2-bunny-tail-zs037.jpg",
  "grass-ruby-silk": "media/catalog/product/s/a/savannah2-melinis-nerviglumis-lss-dsc_5564.jpg",
  "hollyhock-halo-mix": "media/catalog/product/h/o/hollyhock_creme_de_cassis_lss_dsc_7983_850x850.jpg",
  "hollyhock-indian-spring": "media/catalog/product/h/o/hollyhock_jet_black_or_nigra_lss_dsc_6860_850x850.jpg",
  "hollyhock-the-watchman": "media/catalog/product/h/o/hollyhock_majorette_double_champagne_lss_dsc_0427_850x850.jpg",
  "iceplant-harlequin-mix": "media/catalog/product/i/c/iceplant_purple_stardust_zs005_850x850.jpg",
  "iceplant-sparkles-mix": "media/catalog/product/s/u/succulent_iceplant_fl919_lss_000_5351_850x850.jpg",
  "lace-flower-blue": "media/catalog/product/l/a/lace2-flower-blue-lss-dsc_0727.jpg",
  "lace-flower-dara": "media/catalog/product/l/a/lace2-flower-pink-lss-dsc_9464.jpg",
  "lace-flower-white": "media/catalog/product/l/a/lace2-flower-white-lss-dsc_9347.jpg",
  "lewisia-ashwood-carousel-mix": "media/catalog/product/l/e/lewisia-golden-yellow-lss-dsc_9566_1.jpg",
  "lewisia-seeds-elise-mix": "media/catalog/product/l/e/lewisia-mix-fs-goldmedal-lss-dsc_9827.jpg",
  "lewisia-little-peach": "media/catalog/product/l/e/lewisia-rosy-pink-lss-dsc_9536.jpg",
  "lewisia-little-plum": "media/catalog/product/l/e/lewisia-ruby-red-lss-dsc_9803.jpg",
  "lewisia-little-tutti-frutti": "media/catalog/product/l/e/lewisia-ultra-violet-or-ultraviolet-lss-dsc_9786.jpg",
  "love-in-a-mist-miss-jekyll-blue": "media/catalog/product/l/o/love-in-a-mist2-midnight-nigella-lss-dsc_7861.jpg",
  "love-in-a-mist-miss-jekyll-rose": "media/catalog/product/l/o/love-in-a-mist2-miss-jekyll-mix-lss-dsc_4484.jpg",
  "love-in-a-mist-persian-jewels": "media/catalog/product/l/o/love-in-a-mist-nigella-damascena2-mulberry-rose-lss-dsc_3716.jpg",
  "marigold-brocade-mix": "media/catalog/product/m/a/marigold_bambino.jpg",
  "marigold-crackerjack-mix": "media/catalog/product/m/a/marigold_crackerjack_mix_dsc03499_850x850.jpg",
  "marigold-french-vanilla": "media/catalog/product/m/a/marigold-disco-mix-zs019.jpg",
  "marigold-giant-orange": "media/catalog/product/m/a/marigold_colossus_red_gold_bicolor_lss_dsc_5324_850x850.jpg",
  "marigold-honeycomb": "media/catalog/product/m/a/marigold2-chica-flame-lss-dsc_5249.jpg",
  "marigold-jolly-jester": "FL669-Marigold_Dune_Yellow_3_huisue.jpg",
  "marigold-lemon-drop": "media/catalog/product/m/a/marigold_gypsy_sunshine_lss_dsc_6866_850x850.jpg",
  "marigold-sparky-mix": "media/catalog/product/m/a/marigold_kee_s_orange.jpg",
  "marigold-strawberry-blonde": "media/catalog/product/m/a/marigold_kilimanjaro_white_lss_dsc_7191_850x850.jpg",
  "marvel-of-peru-broken-colors-mix": "media/catalog/product/m/a/marvels-of-peru-four-o-clocks2-marbles-mixed-lss-dsc_8929.jpg",
  "marvel-of-peru-limelight": "media/catalog/product/f/o/four2-o-clocks-salmon-sunset-lss-dsc_6672.jpg",
  "marvel-of-peru-marvel-mix": "media/catalog/product/m/a/marigold_linnaeus_burning_embers_lss_dsc_6471_850x850.jpg",
  "marvel-of-peru-tea-time-mix": "media/catalog/product/m/a/marigold-little-hero-fire-lss-dsc_5655.jpg",
  "milkweed-common": "media/catalog/product/m/i/milkweed_butterfly_weed_zs002_850x850.jpg",
  "milkweed-butterfly-flower": "media/catalog/product/m/i/milkweed_gay_butterflies_lss_dsc_1267_850x850.jpg",
  "milkweed-gay-butterflies-mix": "media/catalog/product/m/i/milkweed_hello_yellow_lss_dsc_9723_850x850.jpg",
  "milkweed-hello-yellow": "media/catalog/product/m/i/milkweed_ice_ballet_lss_dsc_9786_850x850.jpg",
  "milkweed-oro": "media/catalog/product/m/i/milkweed_red_or_swamp.jpg",
  "milkweed-rose": "media/catalog/product/m/i/milkweed_showy_w_pollinators_lss_dsc_7083_850x850.jpg",
  "milkweed-showy": "media/catalog/product/m/i/milkweed_soul_mate_or_soulmate_lss_dsc_9713_850x850.jpg",
  "milkweed-swamp": "media/catalog/product/t/w/tweedia_heavenly_blue_zs013_850x850.jpg",
  "milkweed-tuberosa": "media/catalog/product/t/w/tweedia-seeds-white-lss-dsc_1087.jpg",
  "morning-glory-carnevale-di-venezia": "media/catalog/product/m/o/morning_glory_carnevale_di_venezia_lss_000_0416_850x850.jpg",
  "morning-glory-grandpa-ott": "media/catalog/product/f/l/flowers_morning_glory_moon_flower_img_0460_850x850.jpg",
  "morning-glory-heavenly-blue": "media/catalog/product/m/o/morning_glory_kanoko_red_speckled.jpg",
  "morning-glory-scarlett-ohara": "media/catalog/product/m/o/morning_glory_kikyozaki_mixed_lss_dsc_5463_850x850.jpg",
  "morning-glory-sunrise-serenade": "media/catalog/product/f/l/flower_morning_glory_split_second_1523_850x850.jpg",
  "nasturtium-alaska-mix": "media/catalog/product/n/a/nasturtium_alaska_mix_zs005_850x850.jpg",
  "nasturtium-black-velvet": "media/catalog/product/l/e/lettuce-ice-queen-with-nasturtium2-black-velvet-lss-dsc_9103.jpg",
  "nasturtium-bloody-mary": "media/catalog/product/n/a/nasturtium_bloody_mary_zs026_850x850.jpg",
  "nasturtium-cherry-rose-jewel": "media/catalog/product/n/a/nasturtium_cherry_rose_jewel_lss_dsc_5706_850x850.jpg",
  "nasturtium-cobra": "media/catalog/product/n/a/nasturtium_alaska_red_shades_lss_dsc_0286_850x850.jpg",
  "nasturtium-empress-of-india": "media/catalog/product/s/e/seed-packet-nasturtium-baby-orange-lss-dsc_5092.jpg",
  "nasturtium-fiesta-blend": "media/catalog/product/n/a/nasturtium_golden_jewel.jpg",
  "nasturtium-jewel-mix": "media/catalog/product/n/a/nasturtium_orchid_cream_lss_dsc_7219-2_850x850.jpg",
  "nasturtium-ladybird": "media/catalog/product/n/a/nasturtium2-orchid-flame-zs010.jpg",
  "nasturtium-moonlight": "media/catalog/product/n/a/nasturtium2-phoenix-lss-dsc_1087.jpg",
  "nasturtium-orchid-cream": "media/catalog/product/n/a/nasturtium_purple_emperor_lss_dsc_6447_850x850.jpg",
  "nasturtium-peach-melba": "media/catalog/product/n/a/nasturtium_tangerine_whirlybird1.jpg",
  "nasturtium-phoenix": "media/catalog/product/n/a/nastutium_tip_top_alaska_salmon_lss_dsc_5804_850x850.jpg",
  "nasturtium-purple-emperor": "media/catalog/product/n/a/nasturtium_tip_top_mahogany_w_nasturtium_pesto_recipe_lss_dsc_4822_850x850.jpg",
  "nasturtium-spitfire": "media/catalog/product/n/a/nasturtium_tip_top_pink_blush.jpg",
  "nasturtium-tall-trailing-mix": "media/catalog/product/n/a/nasturtium_tip_top_rose_lss_dsc_2786_850x850.jpg",
  "nasturtium-tip-top-mix": "FL533-Whirly_Bird_Rose_Nasturtium_2_hurdur.jpg",
  "nasturtium-vesuvius": "media/catalog/product/n/a/nasturtium_whirlybird_gold.jpg",
  "nicotiana-bronze-queen": "media/catalog/product/n/i/nicotiana_bronze_queen_lss_dsc_6380_850x850.jpg",
  "nicotiana-crimson-bedder": "media/catalog/product/n/i/nicotiana_crimson_bedder_lss_dsc_7382_850x850.jpg",
  "nicotiana-marshmallow": "media/catalog/product/n/i/nicotiana_marshmallow_lss_dsc_1963_850x850.jpg",
  "nicotiana-seeds-purple-perfume": "media/catalog/product/n/i/nicotiana_purple_perfume.jpg",
  "nicotiana-seeds-scentsation-mix": "media/catalog/product/n/i/nicotiana_scentsation_mix_lss_dsc_7416_850x850.jpg",
  "pansy-clear-crystal-mix": "media/catalog/product/p/a/pansy_viola_antique_laeta_lss_dsc_5839_850x850.jpg",
  "pansy-frizzle-sizzle-mix": "media/catalog/product/p/a/pansy_viola_arkwright_ruby_and_macaroons_lss_dsc_9586_850x850.jpg",
  "pansy-moulin-rouge": "media/catalog/product/p/a/pansy_viola_berna_velvet_blue_lss_dsc_5152_850x850.jpg",
  "pansy-swiss-giant-mix": "media/catalog/product/p/a/pansy_blue_perfection_viola_zs009_850x850.jpg",
  "pansy-tiger-eyes": "media/catalog/product/p/a/pansy_viola_bowles_black_w_colored_sugar_on_cookies_lss_dsc_5483_850x850_1.jpg",
  "petunia-balcony-mix": "media/catalog/product/p/e/petunia_balcony_mix_zs019_850x850.jpg",
  "petunia-seeds-copper-spotted": "media/catalog/product/p/e/petunia-copper-spotted-lss-dsc_5847.jpg",
  "petunia-greetings-from-jaromere": "media/catalog/product/p/e/petunia_prozdrav_z_jeromere_or_greetings_from_jaromere_lss_dsc_7257_gradient_850x850.jpg",
  "petunia-karkulka": "media/catalog/product/_/_/__petunia_karkulka_zs063_850x850.jpg",
  "petunia-lace-veil": "media/catalog/product/p/e/petunia_krakovy_zavoj_or_lace_veil_lss_dsc_7233_850x850.jpg",
  "petunia-seeds-peace": "media/catalog/product/p/e/petunia-peace--zs004.jpg",
  "petunia-seeds-purple-dwarf": "media/catalog/product/p/e/petunia-purple-dwarf-czerny-_3_.jpg",
  "petunia-seeds-rosa-bonheur": "media/catalog/product/p/e/petunia-rose-bonheur-lss-dsc_5798.jpg",
  "petunia-sparklers": "media/catalog/product/p/e/petunia_sparklers_or_sparkles_fl894_lss_dsc_2271_850x850.jpg",
  "petunia-superbissima-cerny-s-triumph-mix": "media/catalog/product/p/e/petunia_superbissima_cernys_triumph_cherry_flavored_waffle_syrup_lss_dsc_4800_850x850.jpg",
  "petunia-tidal-wave-purple": "media/catalog/product/p/e/petunia_superbissima_cosmic_cherry_lss_dsc_6320_850x850.jpg",
  "petunia-tidal-wave-red-velour": "media/catalog/product/p/e/petunia_superbissima_giant_alba_zs007_850x850.jpg",
  "petunia-tidal-wave-silver": "media/catalog/product/p/e/petunia_superbissma_giant_rose_lss_dsc_4935_850x850.jpg",
  "petunia-trailing-stars-mix": "media/catalog/product/p/e/petunia_white_double.jpg",
  "petunia-vanilla-ice": "media/catalog/product/p/e/petunia_violet_wild_lss_dsc_4416_850x850.jpg",
  "phlox-beauty-mix": "media/catalog/product/p/h/phlox_blueberry_swirl.jpg",
  "phlox-cherry-caramel": "media/catalog/product/p/h/phlox_cherry_caramel_lss_dsc_5166_850x850.jpg",
  "phlox-creme-brulee": "media/catalog/product/p/h/phlox_sugar_stars_lss_dsc_5225_850x850.jpg",
  "phlox-sugar-stars": "media/catalog/product/p/h/phlox_twinkles_dwarf_mix_lss_dsc_5075_850x850.jpg",
  "poppy-amazing-grey": "media/catalog/product/p/o/poppy_amazing_grey_lss_dsc_6882_850x850.jpg",
  "poppy-black-beauty": "media/catalog/product/p/o/poppy_american_legion_zs007_850x850.jpg",
  "poppy-bridal-silk": "media/catalog/product/p/o/poppy_black_peony_petals_falling_lss_3567_850x850.jpg",
  "poppy-burning-heart": "media/catalog/product/p/o/poppy_black_swan_zs004_850x850.jpg",
  "poppy-california-orange": "media/catalog/product/p/o/poppy_cream_peony_lss_dsc_3414_850x850.jpg",
  "poppy-champagne-bubbles": "media/catalog/product/p/o/poppy_crimson_feathers_lss_dsc_4950_850x850.jpg",
  "poppy-danish-flag": "media/catalog/product/_/p/_poppy_falling_in_love_zs018_850x850.jpg",
  "poppy-drama-queen": "media/catalog/product/p/o/poppy_flemish_antique_lss_dsc_5491_850x850.jpg",
  "poppy-flemish-antique": "media/catalog/product/p/o/poppy_florist_pepperbox_lss_dsc_1259_850x850.jpg",
  "poppy-frosted-salmon": "media/catalog/product/p/o/poppy_frosted_salmon_kad_l1050318_850x850.jpg",
  "poppy-hens-and-chicks": "media/catalog/product/p/o/poppy_giant_rattle_breadseed_from_florets_lss_dsc_1512_850x850.jpg",
  "poppy-hungarian-breadseed": "media/catalog/product/p/o/poppy_hungarian_blue_breadseed_lss_dsc_0817_850x850.jpg",
  "poppy-izmir-peony-mix": "media/catalog/product/p/o/poppy_hens_and_chickens_lss_dsc_8665_850x850.jpg",
  "poppy-jelly-bean-mix": "media/catalog/product/p/o/poppy_california_jelly_beans_lss_dsc_8890_850x850.jpg",
  "poppy-ladybird": "media/catalog/product/p/o/poppy_laurens_grape_lss_dsc_6893_850x850.jpg",
  "poppy-lauren-s-grape": "media/catalog/product/p/o/poppy_lilac_pom_pom_or_pompom_lss_dsc_5431_850x850.jpg",
  "poppy-mission-bells": "media/catalog/product/_/p/_poppy_pandora_zs006_850x850.jpg",
  "poppy-peony-mix": "media/catalog/product/p/o/poppy-pizzicato-lss-dsc_1407.jpg",
  "poppy-persian-blue": "media/catalog/product/p/o/poppy_purple_peony_lss_dsc_9613_850x850.jpg",
  "poppy-red-corn": "media/catalog/product/p/o/poppy_rose_feathers_lss_dsc_2755_850x850.jpg",
  "poppy-shirley-single-mix": "media/catalog/product/p/o/poppy_scarlet_peony.jpg",
  "poppy-swansdown": "media/catalog/product/p/o/poppy_sissinghurst_white_lss_dsc_4189_850x850.jpg",
  "poppy-thai-silk-mix": "media/catalog/product/p/o/poppy_strawberry_fields_california_zs003_850x850.jpg",
  "poppy-venus": "media/catalog/product/p/o/poppy_supreme_zs014_850x850.jpg",
  "primrose-cowslip": "media/catalog/product/p/r/primrose2-pink-evening-lss-dsc_5421.jpg",
  "primrose-drumstick": "media/catalog/product/p/r/primrose-primula-no-18-from-asahi-noen-lss-dsc_3209.jpg",
  "primrose-evening-scented": "media/catalog/product/p/r/primrose-primula-no-6-from-asahi-noen-lss-dsc_3042.jpg",
  "primrose-glacier-blue": "media/catalog/product/p/r/primrose-primula-no-5-from-asahi-noen-lss-dsc_6882.jpg",
  "primrose-pacific-giant-mix": "media/catalog/product/p/r/primrose_pink_beauty.jpg",
  "primrose-showy-evening": "media/catalog/product/p/r/primula2-cortusoides-lss-dsc_4062.jpg",
  "primrose-sunshine": "media/catalog/product/p/r/primula2-wanda-mixed-colors-zs019.jpg",
  "rudbeckia-autumn-colors": "media/catalog/product/r/u/rudbeckia2-caramel-lss-dsc_2404.jpg",
  "rudbeckia-cherry-brandy": "media/catalog/product/r/u/rudbeckia2-cherry-brandy-lss-dsc_5195.jpg",
  "rudbeckia-goldilocks": "media/catalog/product/r/u/rudbeckia2-chim-chiminee-lss-dsc_7557.jpg",
  "rudbeckia-indian-summer": "media/catalog/product/r/u/rudbeckia2-sahara-lss-dsc_5227.jpg",
  "rudbeckia-marmalade": "media/catalog/product/r/u/rudbeckia-viviani-lss-dsc_8688.jpg",
  "salpiglossis-black-trumpets": "media/catalog/product/s/a/salpiglossis_black_trumpet_lss_dsc_4604_850x850.jpg",
  "salpiglossis-bolero-mix": "media/catalog/product/s/a/salpiglossis_cafe_au_lait_lss_dsc_9595_850x850.jpg",
  "salpiglossis-kew-blue": "media/catalog/product/s/a/salpiglossis_kew_blue_lss_dsc_7318-2_850x850.jpg",
  "salpiglossis-royale-mix": "media/catalog/product/s/a/salpiglossis_grandiflora_mix_lss_dsc_3645_850x850.jpg",
  "salvia-blue-monday": "media/catalog/product/s/a/sage_salvia_pink_sunday_and_blue_monday_lss_dsc_5347_850x850.jpg",
  "salvia-coral-nymph": "media/catalog/product/s/a/salvia-nodding-sage-lss-dsc_3798.jpg",
  "salvia-merleau-blue": "media/catalog/product/s/a/salvia_rose_queen_and_violet_queen_mix_lss_000_6776_850x850.jpg",
  "salvia-mystic-spires": "media/catalog/product/s/a/salvia_sage_rose_rhapsody_lss_dsc_6149_850x850.jpg",
  "salvia-oxford-blue": "media/catalog/product/s/a/salvia-amore-scarlet-bicolor-lss-dsc_5435.jpg",
  "salvia-victoria-blue": "media/catalog/product/s/a/salvia_sirius_blue_lss_dsc_7594_850x850.jpg",
  "scabiosa-ace-of-spades": "media/catalog/product/s/c/scabiosa-seeds-black-knight-lss-dsc_0064.jpg",
  "scabiosa-seeds-black-knight": "media/catalog/product/s/c/scabiosa-seeds-blue-cockade-lss-dsc_0911.jpg",
  "scabiosa-seeds-blue-cockade": "media/catalog/product/s/c/scabiosa2-fama-deep-blue-lssdsc_3076.jpg",
  "scabiosa-fata-morgana": "media/catalog/product/s/c/scabiosa2-fama-white-lss-dsc_1115.jpg",
  "scabiosa-seeds-fire-king": "media/catalog/product/s/c/scabiosa-fire-king-lss-dsc_0907.jpg",
  "scabiosa-imperial-mix": "media/catalog/product/s/c/scabiosa2-formula-mix-lss-dsc_4201.jpg",
  "scabiosa-oxford-blue": "media/catalog/product/s/c/scabiosa2-paper-moon-fl610-lss-000_7943.jpg",
  "scabiosa-pincushion-mix": "media/catalog/product/s/c/scabiosa_ritz_blue.jpg",
  "scabiosa-qis-deep-red": "media/catalog/product/s/c/scabiosa_ritz_rose.jpg",
  "scabiosa-qis-mix": "media/catalog/product/s/c/scabiosa2-salmon-queen-lss-dsc_6739.jpg",
  "scabiosa-starball": "media/catalog/product/s/c/scabiosa2-summer-fruits-zs004.jpg",
  "snapdragon-seeds-apple-blossom": "media/catalog/product/s/n/snapdragon_apple_blossom_1.jpg",
  "snapdragon-black-prince": "media/catalog/product/s/n/snapdragon_black_prince_zs041_850x850.jpg",
  "snapdragon-seeds-bronze-dragon": "media/catalog/product/s/e/seed-packet-snapdragon-bronze-dragon-lss-dsc_6403.jpg",
  "snapdragon-chantilly-mix": "media/catalog/product/s/n/snapdragon_cherry_twist_lss_dsc_7328_850x850.jpg",
  "snapdragon-madame-butterfly-mix": "media/catalog/product/s/n/snapdragon_flames.jpg",
  "snapdragon-night-and-day": "media/catalog/product/s/n/snapdragon2-orange-wonder-lss-dsc_8334.jpg",
  "snapdragon-rocket-mix": "media/catalog/product/s/n/snapdragon-rembrandt-w-ryan-lss-dsc_8683.jpg",
  "snapdragon-snappy-mix": "media/catalog/product/s/n/snapdragon_tall_deluxe_mix_lss_dsc_3849_850x850.jpg",
  "snapdragon-seeds-tetra-mix": "media/catalog/product/s/n/snapdragon_tetra_mix_1_1.jpg",
  "snapdragon-tom-thumb-mix": "media/catalog/product/s/n/snapdragon-bizarre-mix-w-andrew-m-lss-dsc_6448.jpg",
  "stock-anytime-mix": "media/catalog/product/s/t/stock_anytime_mix_zs041_850x850.jpg",
  "stock-baby-blue": "media/catalog/product/s/t/stock-baby-blue-lss-dsc_8323.jpg",
  "stock-baby-high-double-cream": "media/catalog/product/s/t/stock-baby-high-double-cream-lss-dsc_8289.jpg",
  "stock-baby-rainbow": "media/catalog/product/s/t/stock-baby-rainbow-lss-dsc_8316.jpg",
  "stock-beauty-salmon-pink": "media/catalog/product/s/t/stock_beauty_salmon_pink_zs007_850x850.jpg",
  "stock-chanter-alto-light-pink": "media/catalog/product/s/t/stock_chanter_alto_light_pink_lss_dsc_3558_850x850.jpg",
  "stock-chanter-alto-red": "media/catalog/product/s/t/stock_chanter_alto_red_kad_l1080155_850x850.jpg",
  "stock-chanter-cedo-apricot": "media/catalog/product/s/t/stock2-chanter-cedo-apricot-zs004.jpg",
  "stock-haru-no-kagayaki": "media/catalog/product/s/t/stock_haru_no_kagayaki_lss_dsc_2081_850x850.jpg",
  "stock-infinity-snow": "media/catalog/product/s/t/stock2-infinity-snow-lss-dsc_8587.jpg",
  "stock-iron-blue": "media/catalog/product/s/t/stock-iron-blue-lss-dsc_8341.jpg",
  "stock-murasaki-no-uta": "media/catalog/product/s/t/stock_murasakino_no_uta_lss_dsc_0481_850x850.jpg",
  "stock-nami-no-mai": "media/catalog/product/s/t/stock_nami_no_mai_zs015_850x850.jpg",
  "stock-new-kabuki-light-pink": "media/catalog/product/s/e/seed_packet_stock_new_kobuki_or_kabuki_light_pink_lss_dsc_7694_850x850.jpg",
  "stock-spray-antique-pink": "media/catalog/product/s/t/stock_spray_antique_pink_lss_dsc_2018_850x850.jpg",
  "stock-spray-apricot": "media/catalog/product/s/t/stock2-venus-cherry-zs030.jpg",
  "stock-spray-purple": "media/catalog/product/s/t/stock2-venus-pink-zs042.jpg",
  "stock-spray-white": "media/catalog/product/s/t/stock_vintage_brown_w_stock_colored_pink_rice_and_salad_lss_dsc_5100_850x850.jpg",
  "stock-vintage-mix": "media/catalog/product/s/t/stock_white_surf_lss_dsc_0612_850x850.jpg",
  "strawflower-apricot-mix": "media/catalog/product/s/t/strawflower2-king-size-orange-lss-dsc_1069.jpg",
  "strawflower-bright-bikini-mix": "media/catalog/product/s/t/strawflower2-king-size-red-with-strawflower-tea-lss-dsc_6476.jpg",
  "strawflower-double-mix": "media/catalog/product/s/t/strawflower2-king-sized-silvery-rose-lss-dsc_6537.jpg",
  "strawflower-silvery-rose": "media/catalog/product/s/t/strawflower2-king-size-silvery-white-lss-dsc_6514.jpg",
  "strawflower-tom-thumb-mix": "media/catalog/product/s/t/strawflower2-tall-double-mix-fl640-lss-dsc_9488.jpg",
  "sunflower-autumn-beauty": "media/catalog/product/s/u/sunflower-autumn-beauty-lss-dsc_6555_1x1-850x850.jpg",
  "sunflower-evening-sun": "media/catalog/product/e/v/evening-sun-sunflower-jere_1x1-850x850.jpg",
  "sunflower-giant-grey-stripe": "media/catalog/product/s/u/sunflower-mammoth-grey-striped-lss-dsc_7598_1x1-850x850.jpg",
  "sunflower-hopi-black-dye": "media/catalog/product/s/u/sunflower-hopi-black-dye-lss-dsc_2736_1x1-850x850.jpg",
  "sunflower-italian-white": "media/catalog/product/s/u/sunflower-ice-cream-lss-dsc_3664_1x1-850x850.jpg",
  "sunflower-lemon-queen": "media/catalog/product/s/u/sunflower-lemon-queen-lss-dsc_9554-recovered_1x1-850x850.jpg",
  "sunflower-mammoth": "media/catalog/product/s/u/sunflower-mongolian-giant-lss-dsc_7855_1x1-850x850.jpg",
  "sunflower-music-box-mix": "media/catalog/product/s/u/sunflowe2r-musicbox-mix-lss-dsc_3918.jpg",
  "sunflower-pro-cut-orange": "FL758-Sunflower_Paquito_Yellow_and_Red_2_obyzhs.jpg",
  "sunflower-red-sun": "media/catalog/product/s/u/sunflower-seeds-ring-of-fire.jpg",
  "sunflower-seeds-ring-of-fire": "media/catalog/product/s/u/sunflower-short-stuff-lss-dsc_3605_1x1-850x850.jpg",
  "sunflower-rostov-giant": "media/catalog/product/s/u/sunflower-taiyo-lss-dsc_0214_1x1-850x850.jpg",
  "sunflower-schweintizs": "media/catalog/product/s/u/sunflower-henry-wilde-lss-dsc_6310_1x1-850x850.jpg",
  "sunflower-soraya": "media/catalog/product/s/u/sunflower-astra-gold-lss-dsc_5101_1x1-850x850.jpg",
  "sunflower-sunbright": "media/catalog/product/s/u/sunflower-astra-rose-cream-lss-dsc_8540_1x1-850x850_1.jpg",
  "sunflower-sungold": "media/catalog/product/s/u/sunflower-carousel-lss-dsc_6670.jpg",
  "sunflower-sunspot": "media/catalog/product/s/u/sunflower-chocolate-cherry-lss-dsc_6587_1x1-850x850.jpg",
  "sunflower-tarahumara-white": "media/catalog/product/s/u/sunflower-double-sunking-lss-dsc_3584_1x1-850x850.jpg",
  "sunflower-teddy-bear": "media/catalog/product/s/u/sunflower-teddy-bear-lss-dsc_5863_1x1-850x850.jpg",
  "sunflower-titan": "media/catalog/product/s/u/sunflower2-florenza-lss-dsc_1148.jpg",
  "sunflower-valentine": "FL760-Sunflower_Seeds_-_Floristan_1_mavwnt.jpg",
  "sunflower-van-gogh": "media/catalog/product/s/u/sunflower-mexican-arcadian2-blend-or-aracdian-blend-lss-dsc_4423.jpg",
  "sunflower-velvet-queen": "media/catalog/product/s/u/sunflower-mexican-red-torch-lss-dsc_0198_1x1-850x850.jpg",
  "sunflower-zohar": "media/catalog/product/s/u/sunflower-arikara-lss-dsc_2072_1x1-850x850.jpg",
  "sweet-pea-bijou-mix": "media/catalog/product/s/w/sweet_pea_high_scent.jpg",
  "sweet-pea-old-spice-mix": "media/catalog/product/f/l/flower-sweet-pea-old-spice-mix-lss-000_7567_1x1-850x850.jpg",
  "verbena-seeds-ideal-florist-mix": "media/catalog/product/v/e/verbena_ideal_florist_mix.jpg",
  "verbena-imagination": "media/catalog/product/v/e/verbena-sweetheart-kisses-from-applewood-lss-dsc_1860.jpg",
  "verbena-peaches-and-cream": "media/catalog/product/v/e/seed-packet-verbena-vanity-fsn-lss-dsc_0223.jpg",
  "vinca-mediterranean-mix": "media/catalog/product/v/i/vinca-heatwave-apricot-lss-dsc_9351_1x1-850x850.jpg",
  "vinca-pacifica-mix": "media/catalog/product/v/i/vinca-heatwave-blue-eye-lss-dsc_0181_1x1-1200x1200.jpg",
  "vinca-titan-mix": "media/catalog/product/v/i/vinca-heatwave-raspberry-lss-dsc_047_1x1-850x8504.jpg",
  "zinnia-aztec-burgundy-bicolor": "media/catalog/product/z/i/zinnia_aztec_burgundy_bicolor.jpg",
  "zinnia-seeds-benary-s-giant-bright-pink": "media/catalog/product/z/i/zinnia_benarys_giant_bright_pink.jpg",
  "zinnia-seeds-benary-s-giant-coral": "media/catalog/product/z/i/zinnia_benary_s_giant_coral.jpg",
  "zinnia-seeds-benary-s-giant-deep-red": "media/catalog/product/z/i/zinnia_benary_s_giant_deep_red.jpg",
  "zinnia-seeds-benary-s-giant-lime": "media/catalog/product/z/i/zinnia_benary_s_giant_lime.jpg",
  "zinnia-seeds-benary-s-giant-orange": "media/catalog/product/z/i/zinnia_benary_s_giant_orange.jpg",
  "zinnia-seeds-benary-s-giant-purple": "media/catalog/product/z/i/zinnia_benary_s_giant_purple.jpg",
  "zinnia-seeds-benary-s-giant-white": "media/catalog/product/z/i/zinnia_benarys_giant_white.jpg",
  "zinnia-canary-bird": "media/catalog/product/z/i/zinnia_canary_bird.jpg",
  "zinnia-seeds-dream-deep-rosy-lavender": "media/catalog/product/z/i/zinnia_dream_deep_rosy_lavender_1.jpg",
  "zinnia-exquisite": "media/catalog/product/z/i/zinnia_exquisite.jpg",
  "zinnia-lila-cactus": "media/catalog/product/z/i/zinnia_lila_cactus.jpg",
  "zinnia-macarenia": "media/catalog/product/z/i/zinnia_macarenia_1_1.jpg",
  "zinnia-mazurkia": "media/catalog/product/z/i/zinnia_mazurkia.jpg",
  "zinnia-seeds-oklahoma-carmine": "media/catalog/product/z/i/zinnia_oklahoma_carmine.jpg",
  "zinnia-seeds-oklahoma-golden-yellow": "media/catalog/product/z/i/zinnia_oklahoma_golden_yellow.jpg",
  "zinnia-seeds-oklahoma-pink": "media/catalog/product/z/i/zinnia_oklahoma_pink.jpg",
  "zinnia-seeds-oklahoma-scarlet": "media/catalog/product/z/i/zinnia_oklahoma_scarlet.jpg",
  "zinnia-seeds-oklahoma-white": "media/catalog/product/z/i/zinnia_oklahoma_white.jpg",
  "zinnia-orange-cactus": "media/catalog/product/z/i/zinnia_orange_cactus.jpg",
  "zinnia-orange-king": "media/catalog/product/z/i/zinnia_orange_king.jpg",
  "zinnia-peppermint-stick": "media/catalog/product/z/i/zinnia_peppermint_stick.jpg",
  "zinnia-persian-carpet": "media/catalog/product/z/i/zinnia_persian_carpet.jpg",
  "zinnia-peruviana": "media/catalog/product/z/i/zinnia_peruviana.jpg"
};
function getImageUrl(url, size = 'modal') {
  const slug = url.replace('https://www.rareseeds.com/', '');
  const suffix = IMAGE_MAP[slug];
  if (!suffix) return null;
  const sizes = { thumb: 'c_fill,w_80,h_80', chip: 'c_fill,w_160,h_120', modal: 'c_fit,w_400,h_400' };
  const transform = sizes[size] || sizes.modal;
  return `https://res.cloudinary.com/rareseeds/image/upload/${transform}/f_auto,q_auto,dpr_auto/v1/${suffix}`;
}

        // SVG Icon Components
        const ChevronDown = ({size = 24, className = ''}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );

        const ChevronUp = ({size = 24, className = ''}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>
        );

        const Search = ({size = 24, className = ''}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        );

        const ExternalLink = ({size = 24, className = ''}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
        );



// All 377 varieties from rareseeds.com organized by 48 species
const FLOWER_DATABASE = {
  Agastache: {
    type: 'perennial',
    germination: [7, 16],
    bloomDays: [80, 100],
    frostHardy: true,
    sun: [6, 12],
    sowMethod: ['startIndoors', 'directSow'],
    sowTiming: 'Start 6-8 weeks before last frost or direct sow after',
    bloomColor: '#8b6bb5', height: 'medium', companions: ['Rudbeckia', 'Zinnia'], bloomDuration: 90, firstYearBloom: true,
    deerResistant: true, soil: 'any', moisture: 'any', pollinators: ['bee', 'hummingbird', 'butterfly'],
    varieties: [
      { name: 'Anise Hyssop', url: 'https://www.rareseeds.com/agastache-anise-hyssop' },
      { name: 'Apache Sunset', url: 'https://www.rareseeds.com/agastache-apache-sunset' },
      { name: 'Apricot Sprite', url: 'https://www.rareseeds.com/agastache-apricot-sprite' },
      { name: 'Astello Indigo', url: 'https://www.rareseeds.com/agastache-seeds-astello-indigo' },
      { name: 'Fragrant Delight Mix', url: 'https://www.rareseeds.com/agastache-fragrant-delight-mix' },
      { name: 'Lavender Martini', url: 'https://www.rareseeds.com/agastache-lavender-martini' },
      { name: 'Liquorice White', url: 'https://www.rareseeds.com/agastache-seeds-liquorice-white' },
      { name: 'Navajo Sunset', url: 'https://www.rareseeds.com/agastache-navajo-sunset' },
      { name: 'Raspberry Daiquiri', url: 'https://www.rareseeds.com/agastache-raspberry-daiquiri' },
      { name: 'Rose Mint', url: 'https://www.rareseeds.com/agastache-rose-mint' },
      { name: 'Sunset Yellow', url: 'https://www.rareseeds.com/agastache-sunset-yellow' },
      { name: 'Texas Hummingbird Mint Heather Queen', url: 'https://www.rareseeds.com/agastache-texas-hummingbird-mint-heather-queen' }
]
  },
  Ageratum: {
    type: 'annual',
    germination: [7, 10],
    bloomDays: [60, 70],
    frostHardy: false,
    sun: [6, 8],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#4a7aad', height: 'short', companions: ['Calendula', 'Marigold', 'Zinnia'], bloomDuration: 75,
    deerResistant: true, soil: 'any', moisture: 'any', pollinators: ['butterfly'],
    varieties: [
      { name: 'Ball Mixed', url: 'https://www.rareseeds.com/ageratum-ball-mixed' },
      { name: 'Leda', url: 'https://www.rareseeds.com/ageratum-leda' },
      { name: 'Red Flint', url: 'https://www.rareseeds.com/ageratum-red-flint' }
]
  },
  'Armeria Maritima': {
    type: 'perennial',
    germination: [14, 21],
    bloomDays: [60, 90],
    frostHardy: true,
    zoneRange: [3, 9],
    sun: [6, 12],
    sowMethod: ['startIndoors', 'directSow'],
    sowTiming: 'Start indoors or direct sow',
    bloomColor: '#d4647a', height: 'ground', companions: ['Dianthus', 'Phlox'], bloomDuration: 45, firstYearBloom: false,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Morning Star Deep Rose', url: 'https://www.rareseeds.com/armeria-maritima-morning-star-deep-rose' },
      { name: 'Morning Star White', url: 'https://www.rareseeds.com/armeria-maritima-seeds-morning-star-white' }
]
  },
  "Baby's Breath": {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [45, 60],
    frostHardy: false,
    sun: [6, 8],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#e8e2d0', height: 'short', companions: ['Snapdragon', 'Stock', 'Sweet Pea'], bloomDuration: 40,
    deerResistant: true, soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Covent Garden', url: 'https://www.rareseeds.com/baby-s-breath-seeds-covent-garden' }
]
  },
  "Bachelor's Button": {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [60, 80],
    frostHardy: true,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow in early spring',
    bloomColor: '#4a7aad', height: 'medium', companions: ['Poppy', 'Calendula', 'Baby\'s Breath'], bloomDuration: 45,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Blue Boy', url: 'https://www.rareseeds.com/bachelor-s-button-blue-boy' },
      { name: 'Classic Fantastic', url: 'https://www.rareseeds.com/bachelor-s-button-classic-fantastic' },
      { name: 'Classic Romantic', url: 'https://www.rareseeds.com/bachelor-s-button-classic-romantic' },
      { name: 'Pinkie', url: 'https://www.rareseeds.com/bachelor-s-button-pinkie' }
]
  },
  'Black-Eyed Susan Vine': {
    type: 'annual',
    germination: [10, 21],
    bloomDays: [90, 100],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#f59e0b', height: 'vine', companions: ['Morning Glory', 'Nasturtium'], bloomDuration: 75,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'African Sunset Mix', url: 'https://www.rareseeds.com/black-eyed-susan-vine-seeds-african-sunset-mix' },
      { name: 'Spanish Eyes', url: 'https://www.rareseeds.com/black-eyed-susan-vine-seeds-spanish-eyes' }
]
  },
  'Butterfly Pea': {
    type: 'annual',
    germination: [7, 21],
    bloomDays: [75, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#3b82f6', height: 'vine', companions: ['Morning Glory', 'Sweet Pea'], bloomDuration: 70,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Blue Queen', url: 'https://www.rareseeds.com/butterfly-pea-blue-queen' },
      { name: 'Lavender Queen', url: 'https://www.rareseeds.com/butterfly-pea-lavender-queen' },
      { name: 'Thai Blue', url: 'https://www.rareseeds.com/butterfly-pea-seeds-thai-double-blue' },
      { name: 'Thai Double Sky Blue', url: 'https://www.rareseeds.com/butterfly-pea-seeds-thai-double-sky-blue' },
      { name: 'White Queen', url: 'https://www.rareseeds.com/butterfly-pea-white-queen' }
]
  },
  Calendula: {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [45, 60],
    frostHardy: true,
    sun: [6, 8],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow in spring or fall',
    bloomColor: '#f97316', height: 'short', companions: ['Nasturtium', 'Marigold', 'Bachelor\'s Button'], bloomDuration: 90,
    deerResistant: true, soil: 'any', moisture: 'any', pollinators: ['bee', 'butterfly'],
    varieties: [
      { name: "Ball's Improved Orange", url: 'https://www.rareseeds.com/calendula-ball-s-improved-orange' },
      { name: 'Orange King', url: 'https://www.rareseeds.com/calendula-orange-king' },
      { name: 'Orange Porcupine', url: 'https://www.rareseeds.com/calendula-seeds-orange-porcupine' },
      { name: 'Pacific Beauty Mix', url: 'https://www.rareseeds.com/calendula-pacific-beauty-mix' },
      { name: 'Pink Surprise', url: 'https://www.rareseeds.com/calendula-pink-surprise' },
      { name: 'Playtime Mix', url: 'https://www.rareseeds.com/calendula-playtime-mix' },
      { name: 'Snow Princess', url: 'https://www.rareseeds.com/calendula-snow-princess' }
]
  },
  Cosmos: {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [60, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#ec4899', height: 'tall', companions: ['Zinnia', 'Sunflower', 'Marigold'], bloomDuration: 90,
    deerResistant: true, soil: 'neutral', moisture: 'dry', pollinators: ['bee', 'butterfly'],
    varieties: [
      { name: 'Apricot Lemonade', url: 'https://www.rareseeds.com/cosmos-apricot-lemonade' },
      { name: 'Apricotta', url: 'https://www.rareseeds.com/cosmos-apricotta' },
      { name: 'Black Magic', url: 'https://www.rareseeds.com/cosmos-black-magic-chocolate' },
      { name: 'Bright Lights', url: 'https://www.rareseeds.com/cosmos-bright-lights' },
      { name: 'Candyfloss Pink Sunrise', url: 'https://www.rareseeds.com/cosmos-candyfloss-pink-sunrise' },
      { name: 'Candyfloss Red', url: 'https://www.rareseeds.com/cosmos-candyfloss-red' },
      { name: 'Cosmic Orange', url: 'https://www.rareseeds.com/cosmos-cosmic-orange' },
      { name: 'Cosmic Red', url: 'https://www.rareseeds.com/cosmos-cosmic-red' },
      { name: 'Cosmic Yellow', url: 'https://www.rareseeds.com/cosmos-cosmic-yellow' },
      { name: 'Double Dutch Rose', url: 'https://www.rareseeds.com/cosmos-double-dutch-rose' },
      { name: 'Fizzy Rose Picotee', url: 'https://www.rareseeds.com/cosmos-fizzy-rose-picotee' },
      { name: 'Japanese Kiiro', url: 'https://www.rareseeds.com/cosmos-japanese-kiiro' },
      { name: 'Pied Piper Red', url: 'https://www.rareseeds.com/cosmos-pied-piper-red' },
      { name: 'Psyche White', url: 'https://www.rareseeds.com/cosmos-psyche-white' },
      { name: 'Rubenza', url: 'https://www.rareseeds.com/cosmos-rubenza' },
      { name: 'Sensation Mix', url: 'https://www.rareseeds.com/cosmos-sensation-mix' },
      { name: 'Xanthos', url: 'https://www.rareseeds.com/cosmos-xanthos' }
]
  },
  Dianthus: {
    type: 'perennial',
    germination: [7, 14],
    bloomDays: [60, 90],
    frostHardy: true,
    zoneRange: [3, 9],
    sun: [6, 12],
    sowMethod: ['directSow', 'startIndoors'],
    sowTiming: 'Direct sow or start indoors',
    bloomColor: '#f472b6', height: 'short', companions: ['Armeria Maritima', 'Phlox', 'Snapdragon'], bloomDuration: 60, firstYearBloom: true,
    deerResistant: true, soil: 'alkaline', moisture: 'dry', pollinators: ['butterfly'],
    varieties: [
      { name: 'Black Adder', url: 'https://www.rareseeds.com/dianthus-seeds-black-adder' },
      { name: 'Flora Mix', url: 'https://www.rareseeds.com/dianthus-seeds-flora-mix' },
      { name: 'Flora Pearl Appleblossom', url: 'https://www.rareseeds.com/dianthus-seeds-flora-pearl-appleblossom' },
      { name: 'Flora Pearl Salmon', url: 'https://www.rareseeds.com/dianthus-seeds-flora-pearl-salmon' }
]
  },
  Gomphrena: {
    type: 'annual',
    germination: [5, 14],
    bloomDays: [90, 120],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#e879f9', height: 'medium', companions: ['Zinnia', 'Marigold'], bloomDuration: 90,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Atomic Purple', url: 'https://www.rareseeds.com/gomphrena-atomic-purple' }
]
  },
  'Lace Flower': {
    type: 'annual',
    germination: [10, 14],
    bloomDays: [60, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#4a7aad', height: 'medium', companions: ['Cosmos', 'Snapdragon', 'Scabiosa'], bloomDuration: 45,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Blue Lace', url: 'https://www.rareseeds.com/lace-flower-blue' },
      { name: 'White Lace', url: 'https://www.rareseeds.com/lace-flower-white' }
]
  },
  Lewisia: {
    type: 'perennial',
    germination: [21, 42],
    frostHardy: true,
    zoneRange: [4, 8],
    sun: [6, 8],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors, requires well-drained soil',
    bloomColor: '#f472b6', height: 'ground', companions: ['Armeria Maritima', 'Dianthus'], bloomDuration: 40, firstYearBloom: false,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Elise Mix', url: 'https://www.rareseeds.com/lewisia-seeds-elise-mix' }
]
  },
  Marigold: {
    type: 'annual',
    germination: [5, 10],
    bloomDays: [50, 70],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#f59e0b', height: 'medium', companions: ['Zinnia', 'Nasturtium', 'Calendula'], bloomDuration: 90,
    deerResistant: true, soil: 'neutral', moisture: 'average', pollinators: ['bee'],
    varieties: [
      { name: 'Crackerjack Mix', url: 'https://www.rareseeds.com/marigold-crackerjack-mix' }
]
  },
  'Morning Glory': {
    type: 'annual',
    germination: [5, 21],
    bloomDays: [60, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#3b82f6', height: 'vine', companions: ['Black-Eyed Susan Vine', 'Butterfly Pea'], bloomDuration: 75,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Carnevale di Venezia', url: 'https://www.rareseeds.com/morning-glory-carnevale-di-venezia' }
]
  },
  Nasturtium: {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [50, 60],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#f97316', height: 'short', companions: ['Calendula', 'Marigold', 'Sunflower'], bloomDuration: 75,
    deerResistant: true, soil: 'neutral', moisture: 'dry', pollinators: ['hummingbird'],
    varieties: [
      { name: 'Alaska Mix', url: 'https://www.rareseeds.com/nasturtium-alaska-mix' },
      { name: 'Black Velvet', url: 'https://www.rareseeds.com/nasturtium-black-velvet' },
      { name: 'Bloody Mary', url: 'https://www.rareseeds.com/nasturtium-bloody-mary' },
      { name: 'Cherry Rose Jewel', url: 'https://www.rareseeds.com/nasturtium-cherry-rose-jewel' },
      { name: 'Orchid Cream', url: 'https://www.rareseeds.com/nasturtium-orchid-cream' },
      { name: 'Phoenix', url: 'https://www.rareseeds.com/nasturtium-phoenix' },
      { name: 'Purple Emperor', url: 'https://www.rareseeds.com/nasturtium-purple-emperor' }
]
  },
  Nicotiana: {
    type: 'annual',
    germination: [10, 21],
    bloomDays: [60, 90],
    frostHardy: false,
    sun: [8, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#a78bfa', height: 'tall', companions: ['Petunia', 'Snapdragon'], bloomDuration: 70,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Bronze Queen', url: 'https://www.rareseeds.com/nicotiana-bronze-queen' },
      { name: 'Crimson Bedder', url: 'https://www.rareseeds.com/nicotiana-crimson-bedder' },
      { name: 'Marshmallow', url: 'https://www.rareseeds.com/nicotiana-marshmallow' },
      { name: 'Purple Perfume', url: 'https://www.rareseeds.com/nicotiana-seeds-purple-perfume' },
      { name: 'Scentsation Mix', url: 'https://www.rareseeds.com/nicotiana-seeds-scentsation-mix' }
]
  },
  Petunia: {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [70, 85],
    frostHardy: true,
    sun: [6, 8],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 8-10 weeks before last frost',
    bloomColor: '#ec4899', height: 'short', companions: ['Nicotiana', 'Verbena'], bloomDuration: 90,
    soil: 'any', moisture: 'any', pollinators: ['hummingbird'],
    varieties: [
      { name: 'Balcony Mix', url: 'https://www.rareseeds.com/petunia-balcony-mix' },
      { name: 'Copper Spotted', url: 'https://www.rareseeds.com/petunia-seeds-copper-spotted' },
      { name: 'Greetings from Jaromere', url: 'https://www.rareseeds.com/petunia-greetings-from-jaromere' },
      { name: 'Karkulka', url: 'https://www.rareseeds.com/petunia-karkulka' },
      { name: 'Lace Veil', url: 'https://www.rareseeds.com/petunia-lace-veil' },
      { name: 'Peace', url: 'https://www.rareseeds.com/petunia-seeds-peace' },
      { name: 'Purple Dwarf', url: 'https://www.rareseeds.com/petunia-seeds-purple-dwarf' },
      { name: 'Rosa Bonheur', url: 'https://www.rareseeds.com/petunia-seeds-rosa-bonheur' },
      { name: 'Sparklers', url: 'https://www.rareseeds.com/petunia-sparklers' },
      { name: "Superbissima Cernys Triumph Mix", url: 'https://www.rareseeds.com/petunia-superbissima-cerny-s-triumph-mix' }
]
  },
  Phlox: {
    type: 'annual',
    germination: [10, 21],
    bloomDays: [60, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#f472b6', height: 'short', companions: ['Dianthus', 'Snapdragon', 'Sweet Pea'], bloomDuration: 60,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Cherry Caramel', url: 'https://www.rareseeds.com/phlox-cherry-caramel' },
      { name: 'Sugar Stars', url: 'https://www.rareseeds.com/phlox-sugar-stars' }
]
  },
  Poppy: {
    type: 'annual',
    germination: [14, 21],
    bloomDays: [55, 65],
    frostHardy: true,
    sun: [8, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow in early spring',
    bloomColor: '#ef4444', height: 'medium', companions: ['Bachelor\'s Button', 'Calendula', 'Baby\'s Breath'], bloomDuration: 21,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Amazing Grey', url: 'https://www.rareseeds.com/poppy-amazing-grey' },
      { name: 'Flemish Antique', url: 'https://www.rareseeds.com/poppy-flemish-antique' },
      { name: 'Frosted Salmon', url: 'https://www.rareseeds.com/poppy-frosted-salmon' },
      { name: "Lauren's Grape", url: 'https://www.rareseeds.com/poppy-lauren-s-grape' }
]
  },
  Rudbeckia: {
    type: 'perennial',
    germination: [7, 14],
    bloomDays: [90, 120],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 8-10 weeks before last frost',
    bloomColor: '#fbbf24', height: 'medium', companions: ['Agastache', 'Sunflower'], bloomDuration: 75, firstYearBloom: true,
    deerResistant: true, soil: 'neutral', moisture: 'average', pollinators: ['bee', 'butterfly'],
    varieties: [
      { name: 'Cherry Brandy', url: 'https://www.rareseeds.com/rudbeckia-cherry-brandy' }
]
  },
  Salpiglossis: {
    type: 'annual',
    germination: [14, 30],
    bloomDays: [90, 100],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 8-10 weeks before last frost',
    bloomColor: '#7c3aed', height: 'medium', companions: ['Nicotiana', 'Petunia', 'Snapdragon'], bloomDuration: 50,
    soil: 'any', moisture: 'any', pollinators: [],
    varieties: [
      { name: 'Kew Blue', url: 'https://www.rareseeds.com/salpiglossis-kew-blue' }
]
  },
  Scabiosa: {
    type: 'annual',
    germination: [10, 14],
    bloomDays: [70, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#4a7aad', height: 'medium', companions: ['Cosmos', 'Lace Flower', 'Sweet Pea'], bloomDuration: 60, firstYearBloom: true,
    varieties: [
      { name: 'Black Knight', url: 'https://www.rareseeds.com/scabiosa-seeds-black-knight' },
      { name: 'Blue Cockade', url: 'https://www.rareseeds.com/scabiosa-seeds-blue-cockade' },
      { name: 'Fire King', url: 'https://www.rareseeds.com/scabiosa-seeds-fire-king' }
]
  },
  Snapdragon: {
    type: 'annual',
    germination: [10, 14],
    bloomDays: [80, 100],
    frostHardy: true,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors early, 8-10 weeks before last frost',
    bloomColor: '#f472b6', height: 'medium', companions: ['Dianthus', 'Phlox', 'Nicotiana'], bloomDuration: 70,
    varieties: [
      { name: 'Apple Blossom', url: 'https://www.rareseeds.com/snapdragon-seeds-apple-blossom' },
      { name: 'Black Prince', url: 'https://www.rareseeds.com/snapdragon-black-prince' },
      { name: 'Bronze Dragon', url: 'https://www.rareseeds.com/snapdragon-seeds-bronze-dragon' },
      { name: 'Tetra Mix', url: 'https://www.rareseeds.com/snapdragon-seeds-tetra-mix' }
]
  },
  Stock: {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [60, 80],
    frostHardy: true,
    sun: [8, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 6-8 weeks before last frost',
    bloomColor: '#a78bfa', height: 'short', companions: ['Snapdragon', 'Sweet Pea', 'Baby\'s Breath'], bloomDuration: 40,
    varieties: [
      { name: 'Anytime Mix', url: 'https://www.rareseeds.com/stock-anytime-mix' },
      { name: 'Baby Blue', url: 'https://www.rareseeds.com/stock-baby-blue' },
      { name: 'Baby High Double Cream', url: 'https://www.rareseeds.com/stock-baby-high-double-cream' },
      { name: 'Baby Rainbow', url: 'https://www.rareseeds.com/stock-baby-rainbow' },
      { name: 'Beauty Salmon Pink', url: 'https://www.rareseeds.com/stock-beauty-salmon-pink' },
      { name: 'Chanter Alto Light Pink', url: 'https://www.rareseeds.com/stock-chanter-alto-light-pink' },
      { name: 'Chanter Alto Red', url: 'https://www.rareseeds.com/stock-chanter-alto-red' },
      { name: 'Chanter Cedo Apricot', url: 'https://www.rareseeds.com/stock-chanter-cedo-apricot' },
      { name: 'Haru No Kagayaki', url: 'https://www.rareseeds.com/stock-haru-no-kagayaki' },
      { name: 'Infinity Snow', url: 'https://www.rareseeds.com/stock-infinity-snow' },
      { name: 'Iron Blue', url: 'https://www.rareseeds.com/stock-iron-blue' },
      { name: 'Murasaki No Uta', url: 'https://www.rareseeds.com/stock-murasaki-no-uta' },
      { name: 'Nami No Mai', url: 'https://www.rareseeds.com/stock-nami-no-mai' },
      { name: 'New Kabuki Light Pink', url: 'https://www.rareseeds.com/stock-new-kabuki-light-pink' },
      { name: 'Spray Antique Pink', url: 'https://www.rareseeds.com/stock-spray-antique-pink' }
]
  },
  Sunflower: {
    type: 'annual',
    germination: [7, 14],
    bloomDays: [70, 100],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#fbbf24', height: 'tall', companions: ['Cosmos', 'Zinnia', 'Nasturtium'], bloomDuration: 30,
    varieties: [
      { name: 'Autumn Beauty', url: 'https://www.rareseeds.com/sunflower-autumn-beauty' },
      { name: 'Evening Sun', url: 'https://www.rareseeds.com/sunflower-evening-sun' },
      { name: 'Hopi Black Dye', url: 'https://www.rareseeds.com/sunflower-hopi-black-dye' },
      { name: 'Lemon Queen', url: 'https://www.rareseeds.com/sunflower-lemon-queen' },
      { name: 'Ring of Fire', url: 'https://www.rareseeds.com/sunflower-seeds-ring-of-fire' },
      { name: 'Teddy Bear', url: 'https://www.rareseeds.com/sunflower-teddy-bear' }
]
  },
  'Sweet Pea': {
    type: 'annual',
    germination: [10, 14],
    bloomDays: [50, 65],
    frostHardy: true,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow in early spring',
    bloomColor: '#ec4899', height: 'vine', companions: ['Phlox', 'Stock', 'Baby\'s Breath'], bloomDuration: 45, varieties: [
      { name: 'Old Spice Mix', url: 'https://www.rareseeds.com/sweet-pea-old-spice-mix' }
]
  },
  Verbena: {
    type: 'annual',
    germination: [14, 28],
    bloomDays: [70, 90],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['startIndoors'],
    sowTiming: 'Start indoors 8-10 weeks before last frost',
    bloomColor: '#a855f7', height: 'short', companions: ['Petunia', 'Zinnia'], bloomDuration: 75,
    varieties: [
      { name: 'Ideal Florist Mix', url: 'https://www.rareseeds.com/verbena-seeds-ideal-florist-mix' }
]
  },
  Zinnia: {
    type: 'annual',
    germination: [4, 6],
    bloomDays: [60, 70],
    frostHardy: false,
    sun: [6, 12],
    sowMethod: ['directSow'],
    sowTiming: 'Direct sow after last frost',
    bloomColor: '#ef4444', height: 'medium', companions: ['Cosmos', 'Marigold', 'Sunflower'], bloomDuration: 90,
    varieties: [
      { name: 'Aztec Burgundy Bicolor', url: 'https://www.rareseeds.com/zinnia-aztec-burgundy-bicolor' },
      { name: "Benary's Giant Bright Pink", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-bright-pink' },
      { name: "Benary's Giant Coral", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-coral' },
      { name: "Benary's Giant Deep Red", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-deep-red' },
      { name: "Benary's Giant Lime", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-lime' },
      { name: "Benary's Giant Orange", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-orange' },
      { name: "Benary's Giant Purple", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-purple' },
      { name: "Benary's Giant White", url: 'https://www.rareseeds.com/zinnia-seeds-benary-s-giant-white' },
      { name: 'Canary Bird', url: 'https://www.rareseeds.com/zinnia-canary-bird' },
      { name: 'Dream Deep Rosy Lavender', url: 'https://www.rareseeds.com/zinnia-seeds-dream-deep-rosy-lavender' },
      { name: 'Exquisite', url: 'https://www.rareseeds.com/zinnia-exquisite' },
      { name: 'Lila Cactus', url: 'https://www.rareseeds.com/zinnia-lila-cactus' },
      { name: 'Macarenia', url: 'https://www.rareseeds.com/zinnia-macarenia' },
      { name: 'Mazurkia', url: 'https://www.rareseeds.com/zinnia-mazurkia' },
      { name: 'Oklahoma Carmine', url: 'https://www.rareseeds.com/zinnia-seeds-oklahoma-carmine' },
      { name: 'Oklahoma Golden Yellow', url: 'https://www.rareseeds.com/zinnia-seeds-oklahoma-golden-yellow' },
      { name: 'Oklahoma Pink', url: 'https://www.rareseeds.com/zinnia-seeds-oklahoma-pink' },
      { name: 'Oklahoma Scarlet', url: 'https://www.rareseeds.com/zinnia-seeds-oklahoma-scarlet' },
      { name: 'Oklahoma White', url: 'https://www.rareseeds.com/zinnia-seeds-oklahoma-white' },
      { name: 'Orange Cactus', url: 'https://www.rareseeds.com/zinnia-orange-cactus' },
      { name: 'Orange King', url: 'https://www.rareseeds.com/zinnia-orange-king' },
      { name: 'Peppermint Stick', url: 'https://www.rareseeds.com/zinnia-peppermint-stick' },
      { name: 'Persian Carpet', url: 'https://www.rareseeds.com/zinnia-persian-carpet' },
      { name: 'Peruviana', url: 'https://www.rareseeds.com/zinnia-peruviana' }
]
  }
};

// Midcoast Maine (Zone 5b) growing parameters
const MIDCOAST = { lastFrost: 135, firstFrost: 274 }; // Day of year: May 15 = 135, Oct 1 = 274
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const MONTH_DAYS = [31,28,31,30,31,30,31,31,30,31,30,31];
const MONTH_START_DOY = [0,31,59,90,120,151,181,212,243,273,304,334];
const TOTAL_DAYS = 365;

function doy(month, day) { return MONTH_START_DOY[month - 1] + day; }
function doyToDate(d) {
  let m = 0;
  while (m < 11 && d > MONTH_START_DOY[m + 1]) m++;
  return { month: m, day: d - MONTH_START_DOY[m] };
}
function formatDoy(d) {
  const dt = doyToDate(Math.max(1, Math.min(365, d)));
  return `${MONTHS[dt.month]} ${dt.day}`;
}

function calcTimeline(sd, midcoast) {
  const germDays = Math.round((sd.germination[0] + sd.germination[1]) / 2);
  const bloomDays = sd.bloomDays ? Math.round((sd.bloomDays[0] + sd.bloomDays[1]) / 2) : 75;
  const t = {};
  if (sd.sowMethod.includes('startIndoors')) {
    t.indoorStart = midcoast.lastFrost - 56; // 8 weeks before
    t.indoorEnd = midcoast.lastFrost - 14;
    t.hardenStart = t.indoorEnd;
    t.hardenEnd = midcoast.lastFrost + (sd.frostHardy ? -14 : 7);
    t.transplant = midcoast.lastFrost + (sd.frostHardy ? -14 : 7);
  }
  if (sd.sowMethod.includes('directSow')) {
    if (sd.frostHardy) {
      t.sowStart = midcoast.lastFrost - 42; // 6 weeks before last frost
      t.sowEnd = midcoast.lastFrost + 30;
    } else {
      t.sowStart = midcoast.lastFrost + 1;
      t.sowEnd = midcoast.lastFrost + 42;
    }
  }
  const effectiveSow = t.transplant || t.sowStart || midcoast.lastFrost;
  t.germStart = effectiveSow;
  t.germEnd = effectiveSow + germDays;
  t.bloomStart = effectiveSow + bloomDays;
  const duration = sd.bloomDuration || 60;
  t.bloomEnd = Math.min(effectiveSow + bloomDays + duration, sd.type === 'annual' ? midcoast.firstFrost : midcoast.firstFrost + 14);
  t.seasonEnd = sd.type === 'annual' ? midcoast.firstFrost : 334;
  return t;
}

function getPhaseAtDoy(tl, dayOfYear) {
  // Indoor phase: from indoorStart until harden start
  if (tl.indoorStart && tl.hardenStart && dayOfYear >= tl.indoorStart && dayOfYear < tl.hardenStart) return 'indoor';
  // Indoor-only (no transplant): use indoorEnd
  if (tl.indoorStart && !tl.hardenStart && dayOfYear >= tl.indoorStart && dayOfYear <= (tl.indoorEnd || tl.indoorStart + 42)) return 'indoor';
  // Hardening off phase
  if (tl.hardenStart && tl.hardenEnd && dayOfYear >= tl.hardenStart && dayOfYear < tl.hardenEnd) return 'harden';
  // Transplant until germination ends
  if (tl.transplant && dayOfYear >= tl.transplant && dayOfYear < tl.germEnd) return 'transplant';
  // Direct sow window (only for species without indoor start, or overlapping sow window)
  if (tl.sowStart && !tl.transplant && dayOfYear >= tl.sowStart && dayOfYear < tl.germEnd) return 'sow';
  if (tl.sowStart && tl.transplant && dayOfYear >= tl.sowStart && dayOfYear <= tl.sowEnd) return 'sow';
  // Germination (fallback if not covered by transplant/sow above)
  if (dayOfYear >= tl.germStart && dayOfYear < tl.germEnd) return 'germination';
  // Vegetative growth: germination done, waiting for bloom
  if (dayOfYear >= tl.germEnd && dayOfYear < tl.bloomStart) return 'growing';
  // Bloom
  if (dayOfYear >= tl.bloomStart && dayOfYear <= tl.bloomEnd) return 'bloom';
  // Decline / frost kill
  if (dayOfYear > tl.bloomEnd && dayOfYear <= tl.seasonEnd) return 'decline';
  return 'dormant';
}

const PHASE_COLORS = {
  indoor: { bg: '#7c3aed', label: 'Start Indoors' },
  harden: { bg: '#0891b2', label: 'Harden Off' },
  transplant: { bg: '#2563eb', label: 'Transplant' },
  sow: { bg: '#16a34a', label: 'Direct Sow' },
  germination: { bg: '#84cc16', label: 'Germination' },
  growing: { bg: '#a3e635', label: 'Growing' },
  bloom: { bg: '#ec4899', label: 'Bloom' },
  decline: { bg: '#f59e0b', label: 'Decline/Frost Kill' },
  dormant: { bg: '#f1f5f9', label: 'Dormant' }
};
  const HEIGHT_LABELS = {
    ground: '0â€“6" groundcover',
    short: '6â€“18"',
    medium: '18â€“36"',
    tall: '36â€“60"',
    vine: 'Climbing/Trailing'
  };

  const SPACING_DATA = {
    ground: { spacing: 6, label: '6" apart' },
    short: { spacing: 12, label: '12" apart' },
    medium: { spacing: 18, label: '18" apart' },
    tall: { spacing: 24, label: '24" apart' },
    vine: { spacing: 36, label: '36" apart' }
  };

const getCountdown = (tl, todayDoy) => {
  const actions = [
    tl.indoorStart && { doy: tl.indoorStart, label: 'Start indoors' },
    tl.transplant && { doy: tl.transplant, label: 'Transplant' },
    tl.sowStart && { doy: tl.sowStart, label: 'Sow' },
    { doy: tl.bloomStart, label: 'Bloom' }
  ].filter(Boolean);
  // Find the nearest future action
  const future = actions.filter(a => a.doy > todayDoy).sort((a, b) => a.doy - b.doy);
  if (future.length === 0) return null;
  const next = future[0];
  const days = next.doy - todayDoy;
  if (days > 60) return null;
  return { label: next.label, days };
};

function doyToICSDate(dayOfYear) {
  const d = new Date(2026, 0, dayOfYear);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}${m}${day}`;
}

const ZIP_FROST_DATA = {
  '04101': { lastFrost: 125, firstFrost: 284 },
  '04005': { lastFrost: 128, firstFrost: 280 },
  '04841': { lastFrost: 135, firstFrost: 274 },
  '04843': { lastFrost: 135, firstFrost: 274 },
  '04011': { lastFrost: 130, firstFrost: 278 },
  '04609': { lastFrost: 140, firstFrost: 268 },
  '04401': { lastFrost: 138, firstFrost: 270 },
  '04330': { lastFrost: 140, firstFrost: 265 },
  '04210': { lastFrost: 142, firstFrost: 262 },
  '04901': { lastFrost: 145, firstFrost: 258 }
};

function getColorFamily(hex) {
  if (!hex) return 'other';
  const r = parseInt(hex.slice(1,3), 16) / 255;
  const g = parseInt(hex.slice(3,5), 16) / 255;
  const b = parseInt(hex.slice(5,7), 16) / 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  const l = (max + min) / 2;
  if (max - min < 0.1) return 'white';
  let h = 0;
  const d = max - min;
  if (max === r) h = ((g - b) / d + (g < b ? 6 : 0)) * 60;
  else if (max === g) h = ((b - r) / d + 2) * 60;
  else h = ((r - g) / d + 4) * 60;
  if (h >= 330 || h < 15) return 'red';
  if (h >= 15 && h < 45) return 'orange';
  if (h >= 45 && h < 70) return 'yellow';
  if (h >= 70 && h < 170) return 'green';
  if (h >= 170 && h < 260) return 'blue';
  if (h >= 260 && h < 330) return 'purple';
  return 'other';
}

const COLOR_FAMILIES = {
  all: 'All colors',
  'red': 'Red / Pink',
  'orange': 'Orange',
  'yellow': 'Yellow / Gold',
  'blue': 'Blue / Indigo',
  'purple': 'Purple / Violet',
  'white': 'White / Neutral'
};

function LazyCard({ children }) {
  const ref = React.useRef(null);
  const [visible, setVisible] = React.useState(false);
  React.useEffect(() => {
    if (!ref.current) return;
    const obs = new IntersectionObserver(([entry]) => {
      if (entry.isIntersecting) { setVisible(true); }
    }, { rootMargin: '200px' });
    obs.observe(ref.current);
    return () => obs.disconnect();
  }, []);
  return (
    <div ref={ref} style={{ minHeight: visible ? 'auto' : '120px' }}>
      {visible ? children : null}
    </div>
  );
}

function PlantingCalendar() {
  const [selectedVariety, setSelectedVariety] = useState(null);
  const [expandedSpecies, setExpandedSpecies] = useState({});
  const [myGarden, setMyGarden] = useState(() => {
    try { return JSON.parse(localStorage.getItem('myGarden') || '{}'); } catch { return {}; }
  });
  const [gardenNotes, setGardenNotes] = useState(() => {
    try { return JSON.parse(localStorage.getItem('gardenNotes') || '{}'); } catch { return {}; }
  });
  const [copiedList, setCopiedList] = useState(false);
  const [copiedLink, setCopiedLink] = useState(false);
  const [filterMyGarden, setFilterMyGarden] = useState(false);
  const [gardenOrder, setGardenOrder] = useState(() => {
    try { return JSON.parse(localStorage.getItem('gardenOrder') || '[]'); } catch { return []; }
  });
  const [draggedSpecies, setDraggedSpecies] = useState(null);
  const [sortBy, setSortBy] = useState('alpha');
  const [filterHeight, setFilterHeight] = useState('all');
  const [filterColorFamily, setFilterColorFamily] = useState('all');
  const [viewMode, setViewMode] = useState('list');
  const [allExpanded, setAllExpanded] = useState(false);
  const [lastFrostOffset, setLastFrostOffset] = useState(0);
  const [firstFrostOffset, setFirstFrostOffset] = useState(0);
  const [customMidcoast, setCustomMidcoast] = useState(MIDCOAST);
  const [mobileFiltersOpen, setMobileFiltersOpen] = useState(false);
  const [filtersOpen, setFiltersOpen] = useState(() => window.innerWidth >= 640);
  const [showOnboarding, setShowOnboarding] = useState(() => {
    try { return !localStorage.getItem('onboardingDismissed'); } catch { return true; }
  });
  const [tipIndex, setTipIndex] = useState(0);
  const [showZipInput, setShowZipInput] = useState(false);
  const [zipCode, setZipCode] = useState('');
  const [zipResult, setZipResult] = useState(null);
  const [compareMode, setCompareMode] = useState(false);
  const [compareSpecies, setCompareSpecies] = useState([]);
  const [darkMode, setDarkMode] = useState(() => {
    try { return localStorage.getItem('darkMode') === '1'; } catch { return false; }
  });
  const [showShortcuts, setShowShortcuts] = useState(false);
  const [notificationsEnabled, setNotificationsEnabled] = useState(() => {
    try { return localStorage.getItem('notificationsEnabled') === '1'; } catch { return false; }
  });
  const [focusedCardIndex, setFocusedCardIndex] = useState(-1);
  const [modalTab, setModalTab] = useState('details');
  const [showPresets, setShowPresets] = useState(false);
  const [footerDismissed, setFooterDismissed] = useState(false);
  const [filterHintDismissed, setFilterHintDismissed] = useState(() => {
    try { return !!localStorage.getItem('filterHintDismissed'); } catch { return false; }
  });
  const [toastMsg, setToastMsg] = useState(null);
  const [walkStep, setWalkStep] = useState(() => {
    try { return localStorage.getItem('onboardingDismissed') ? null : 0; } catch { return 0; }
  });

  React.useEffect(() => {
    localStorage.setItem('myGarden', JSON.stringify(myGarden));
  }, [myGarden]);

  React.useEffect(() => {
    localStorage.setItem('gardenNotes', JSON.stringify(gardenNotes));
  }, [gardenNotes]);

  React.useEffect(() => {
    localStorage.setItem('gardenOrder', JSON.stringify(gardenOrder));
  }, [gardenOrder]);

  React.useEffect(() => {
    setCustomMidcoast({
      lastFrost: MIDCOAST.lastFrost + (lastFrostOffset * 7),
      firstFrost: MIDCOAST.firstFrost + (firstFrostOffset * 7)
    });
  }, [lastFrostOffset, firstFrostOffset]);

  React.useEffect(() => {
    localStorage.setItem('darkMode', darkMode ? '1' : '0');
    document.body.style.backgroundColor = darkMode ? '#0f172a' : '#f8fafc';
    document.body.style.color = darkMode ? '#e2e8f0' : '#1e293b';
  }, [darkMode]);

  const [isMobile, setIsMobile] = useState(() => window.innerWidth < 640);
  React.useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 640);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const [scrolledPast, setScrolledPast] = useState(false);
  const headerRef = React.useRef(null);
  React.useEffect(() => {
    const handleScroll = () => {
      if (headerRef.current) {
        const past = headerRef.current.getBoundingClientRect().bottom < 0;
        setScrolledPast(past);
        if (past && window.innerWidth < 640) {
          setFiltersOpen(false);
        }
      }
    };
    window.addEventListener('scroll', handleScroll, { passive: true });
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Modal body scroll lock
  React.useEffect(() => {
    document.body.style.overflow = selectedVariety ? 'hidden' : '';
    if (selectedVariety) setModalTab('details');
    return () => { document.body.style.overflow = ''; };
  }, [selectedVariety]);

  // Reset focused card when filters change
  React.useEffect(() => { setFocusedCardIndex(-1); }, [searchTerm, filterType, filterHeight, filterColorFamily, filterMyGarden, filterPlantNow, filterBloomNow, sortBy]);

  React.useEffect(() => {
    const handleGlobal = (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
      if (e.key === '?') { setShowShortcuts(prev => !prev); e.preventDefault(); return; }
      if (selectedVariety || showShortcuts || showPresets) return;
      if (viewMode !== 'list') return;
      if (e.key === 'j' || e.key === 'ArrowDown') {
        e.preventDefault();
        setFocusedCardIndex(prev => {
          const next = Math.min(prev + 1, (document.querySelectorAll('[data-species]').length || 1) - 1);
          requestAnimationFrame(() => {
            const cards = document.querySelectorAll('[data-species]');
            if (cards[next]) cards[next].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          });
          return next;
        });
      } else if (e.key === 'k' || e.key === 'ArrowUp') {
        e.preventDefault();
        setFocusedCardIndex(prev => {
          const next = Math.max(prev - 1, 0);
          requestAnimationFrame(() => {
            const cards = document.querySelectorAll('[data-species]');
            if (cards[next]) cards[next].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          });
          return next;
        });
      } else if (e.key === 'Enter') {
        setFocusedCardIndex(prev => {
          if (prev >= 0) {
            const cards = document.querySelectorAll('[data-species]');
            if (cards[prev]) {
              const sp = cards[prev].getAttribute('data-species');
              toggleSpecies(sp);
            }
          }
          return prev;
        });
      } else if (e.key === 'Escape') {
        setFocusedCardIndex(-1);
      }
    };
    document.addEventListener('keydown', handleGlobal);
    return () => document.removeEventListener('keydown', handleGlobal);
  }, [selectedVariety, showShortcuts, showPresets, viewMode, toggleSpecies]);

  // Read initial state from URL hash
  React.useEffect(() => {
    const hash = window.location.hash.slice(1);
    if (!hash) return;
    const params = new URLSearchParams(hash);
    if (params.get('view')) setViewMode(params.get('view'));
    if (params.get('sow')) setFilterSow(params.get('sow'));
    if (params.get('type')) setFilterType(params.get('type'));
    if (params.get('height')) setFilterHeight(params.get('height'));
    if (params.get('colorFamily')) setFilterColorFamily(params.get('colorFamily'));
    if (params.get('sort')) setSortBy(params.get('sort'));
    if (params.get('search')) setSearchTerm(params.get('search'));
    if (params.get('color') === '1') setBloomColorMode(true);
    if (params.get('garden') === '1') setFilterMyGarden(true);
    if (params.get('frostL')) setLastFrostOffset(parseInt(params.get('frostL')) || 0);
    if (params.get('frostF')) setFirstFrostOffset(parseInt(params.get('frostF')) || 0);
    if (params.get('deer')) setFilterDeer(params.get('deer'));
    if (params.get('poll')) setFilterPollinator(params.get('poll'));
  }, []);  // nextAction sort option will round-trip through this effect

  // Write state to URL hash
  React.useEffect(() => {
    const params = new URLSearchParams();
    if (viewMode !== 'list') params.set('view', viewMode);
    if (filterSow !== 'all') params.set('sow', filterSow);
    if (filterType !== 'all') params.set('type', filterType);
    if (filterHeight !== 'all') params.set('height', filterHeight);
    if (filterColorFamily !== 'all') params.set('colorFamily', filterColorFamily);
    if (sortBy !== 'alpha') params.set('sort', sortBy);
    if (searchTerm) params.set('search', searchTerm);
    if (filterMyGarden) params.set('garden', '1');
    if (lastFrostOffset !== 0) params.set('frostL', String(lastFrostOffset));
    if (firstFrostOffset !== 0) params.set('frostF', String(firstFrostOffset));
    if (filterDeer !== 'all') params.set('deer', filterDeer);
    if (filterPollinator !== 'all') params.set('poll', filterPollinator);
    const hash = params.toString();
    window.history.replaceState(null, '', hash ? '#' + hash : window.location.pathname);
  }, [viewMode, filterSow, filterType, filterHeight, filterColorFamily, sortBy, searchTerm, filterMyGarden, lastFrostOffset, firstFrostOffset, filterDeer, filterPollinator]);

  React.useEffect(() => {
    const handleKey = (e) => {
      if (e.key === 'Escape') { setSelectedVariety(null); return; }
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        const sd = speciesData.find(s => s.species === selectedVariety.species);
        if (!sd) return;
        const currentIdx = sd.varieties.findIndex(v => v.name === selectedVariety.name);
        if (currentIdx === -1) return;
        const newIdx = e.key === 'ArrowLeft'
          ? (currentIdx - 1 + sd.varieties.length) % sd.varieties.length
          : (currentIdx + 1) % sd.varieties.length;
        const v = sd.varieties[newIdx];
        setSelectedVariety({ ...v, species: sd.species, type: sd.type, germination: sd.germination, bloomDays: sd.bloomDays || [60,90], frostHardy: sd.frostHardy, sowMethod: sd.sowMethod, sowTiming: sd.sowTiming, sun: sd.sun, bloomColor: sd.bloomColor, height: sd.height, companions: sd.companions, flag: sd.flag, zoneRange: sd.zoneRange, bloomDuration: sd.bloomDuration, firstYearBloom: sd.firstYearBloom, tl: sd.tl });
      }
    };
    if (selectedVariety) {
      document.addEventListener('keydown', handleKey);
      return () => document.removeEventListener('keydown', handleKey);
    }
  }, [selectedVariety, speciesData]);

  const toggleGarden = useCallback((species, varietyName, e) => {
    if (e) { e.stopPropagation(); e.preventDefault(); }
    setMyGarden(prev => {
      const key = species + '||' + varietyName;
      const next = { ...prev };
      if (next[key]) delete next[key]; else next[key] = true;
      return next;
    });
  }, []);

  const copyShoppingList = useCallback(() => {
    const items = [];
    Object.keys(myGarden).forEach(key => {
      const [species, variety] = key.split('||');
      const sd = Object.entries(FLOWER_DATABASE).find(([s]) => s === species);
      if (!sd) return;
      const v = sd[1].varieties.find(vr => vr.name === variety);
      if (!v) return;
      items.push({ species, variety, url: v.url });
    });
    items.sort((a, b) => a.species.localeCompare(b.species) || a.variety.localeCompare(b.variety));
    const text = items.map(i => `${i.species} - ${i.variety}\n  ${i.url}`).join('\n\n');
    const header = `Verdant Atlas Garden Plan (${items.length} varieties)\n${'='.repeat(45)}\n\n`;
    navigator.clipboard.writeText(header + text).then(() => {
      setCopiedList(true);
      setTimeout(() => setCopiedList(false), 2000);
    });
  }, [myGarden]);

  const exportCSV = useCallback(() => {
    const headers = ['Species', 'Variety', 'Type', 'Height', 'Indoor Start', 'Transplant', 'Direct Sow', 'Bloom Start', 'Bloom End', 'Deer Resistant', 'Pollinators', 'URL'];
    const rows = [];
    Object.keys(myGarden).sort().forEach(key => {
      const [species, variety] = key.split('||');
      const dbEntry = Object.entries(FLOWER_DATABASE).find(([s]) => s === species);
      if (!dbEntry) return;
      const sd = dbEntry[1];
      const v = sd.varieties.find(vr => vr.name === variety);
      if (!v) return;
      const tl = calcTimeline(sd, customMidcoast);
      rows.push([
        species,
        variety,
        sd.type,
        HEIGHT_LABELS[sd.height] || '',
        tl.indoorStart ? formatDoy(tl.indoorStart) : '',
        tl.transplant ? formatDoy(tl.transplant) : '',
        tl.sowStart ? formatDoy(tl.sowStart) : '',
        formatDoy(tl.bloomStart),
        formatDoy(tl.bloomEnd),
        sd.deerResistant ? 'Yes' : 'No',
        (sd.pollinators || []).join('; '),
        v.url
      ]);
    });
    const csvContent = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'midcoast-maine-garden-plan.csv';
    link.click();
    URL.revokeObjectURL(link.href);
  }, [myGarden, customMidcoast]);

  const downloadICSCalendar = useCallback(() => {
    const events = [];
    Object.keys(myGarden).forEach(key => {
      const [species, variety] = key.split('||');
      const sd = speciesData.find(s => s.species === species);
      if (!sd) return;
      const tl = sd.tl;
      if (tl.indoorStart) {
        const date = doyToICSDate(tl.indoorStart);
        events.push({
          summary: `Start Indoors: ${species}`,
          description: `Start ${species} seeds indoors in trays`,
          date: date
        });
      }
      if (tl.transplant) {
        const date = doyToICSDate(tl.transplant);
        events.push({
          summary: `Transplant: ${species}`,
          description: `Transplant ${species} seedlings outdoors`,
          date: date
        });
      }
      if (tl.sowStart) {
        const date = doyToICSDate(tl.sowStart);
        events.push({
          summary: `Direct Sow: ${species}`,
          description: `Direct sow ${species} seeds outdoors`,
          date: date
        });
      }
      if (tl.bloomStart) {
        const date = doyToICSDate(tl.bloomStart);
        events.push({
          summary: `Expected Bloom: ${species}`,
          description: `${species} should begin blooming`,
          date: date
        });
      }
    });
    let ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Verdant Atlas//EN\nCALSCALE:GREGORIAN\n`;
    events.forEach(e => {
      const nextDay = String(parseInt(e.date) + 1).padStart(8, '0');
      ics += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${e.date}\nDTEND;VALUE=DATE:${nextDay}\nSUMMARY:${e.summary}\nDESCRIPTION:${e.description}\nEND:VEVENT\n`;
    });
    ics += `END:VCALENDAR`;
    const blob = new Blob([ics], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'garden-plan.ics';
    a.click();
    URL.revokeObjectURL(url);
  }, [myGarden, speciesData]);

  const [searchTerm, setSearchTerm] = useState('');
  const [searchFocused, setSearchFocused] = useState(false);
  const [filterSow, setFilterSow] = useState('all');
  const [filterType, setFilterType] = useState('all');
  const [filterPlantNow, setFilterPlantNow] = useState(false);
  const [filterBloomNow, setFilterBloomNow] = useState(false);
  const [filterDeer, setFilterDeer] = useState('all');
  const [filterPollinator, setFilterPollinator] = useState('all');

  const today = new Date();
  const todayDoy = doy(today.getMonth() + 1, today.getDate());
  const todayPct = ((todayDoy - 1) / 365) * 100;

  const hasActiveFilters = searchTerm || filterSow !== 'all' || filterType !== 'all' || filterHeight !== 'all' || filterColorFamily !== 'all' || filterPlantNow || filterBloomNow || filterMyGarden || sortBy !== 'alpha' || filterDeer !== 'all' || filterPollinator !== 'all';

  const activeFilterCount = [
    searchTerm, filterSow !== 'all', filterType !== 'all', filterHeight !== 'all',
    filterColorFamily !== 'all', filterPlantNow, filterBloomNow, filterMyGarden, filterDeer !== 'all', filterPollinator !== 'all'
  ].filter(Boolean).length;

  const clearAllFilters = useCallback(() => {
    setSearchTerm('');
    setFilterSow('all');
    setFilterType('all');
    setFilterHeight('all');
    setFilterColorFamily('all');
    setFilterPlantNow(false);
    setFilterBloomNow(false);
    setFilterMyGarden(false);
    setSortBy('alpha');
    setFilterDeer('all');
    setFilterPollinator('all');
  }, []);

  // Build species-level data with timeline + varieties
  const speciesData = useMemo(() => {
    const result = [];
    Object.entries(FLOWER_DATABASE).forEach(([species, sd]) => {
      const tl = calcTimeline(sd, customMidcoast);
      const varieties = sd.varieties.map(v => ({
        name: v.name, url: v.url, img: getImageUrl(v.url)
      }));
      result.push({
        species, type: sd.type, germination: sd.germination,
        bloomDays: sd.bloomDays || [60, 90], frostHardy: sd.frostHardy,
        sowMethod: sd.sowMethod, sowTiming: sd.sowTiming, sun: sd.sun, bloomColor: sd.bloomColor, height: sd.height,
        flag: sd.flag, zoneRange: sd.zoneRange, companions: sd.companions || [], bloomDuration: sd.bloomDuration, firstYearBloom: sd.firstYearBloom, tl, varieties
      });
    });
    // Compute bi-directional companions
    const speciesNames = new Set(result.map(s => s.species));
    result.forEach(sd => {
      sd.companions.forEach(comp => {
        if (!speciesNames.has(comp)) return; // skip companions not in database
        const target = result.find(s => s.species === comp);
        if (target && !target.companions.includes(sd.species)) {
          target.companions = [...target.companions, sd.species];
        }
      });
    });
    return result;
  }, [customMidcoast]);

  const enableNotifications = useCallback(() => {
    if (!('Notification' in window)) { alert('Your browser does not support notifications.'); return; }
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') {
        setNotificationsEnabled(true);
        localStorage.setItem('notificationsEnabled', '1');
        checkAndNotify();
      }
    });
  }, []);

  const checkAndNotify = useCallback(() => {
    if (!notificationsEnabled || Notification.permission !== 'granted') return;
    const today = new Date();
    const tdoy = doy(today.getMonth() + 1, today.getDate());
    const notified = JSON.parse(localStorage.getItem('notifiedEvents') || '{}');

    Object.keys(myGarden).forEach(key => {
      const [species] = key.split('||');
      const sd = speciesData.find(s => s.species === species);
      if (!sd) return;
      const events = [
        sd.tl.indoorStart && { doy: sd.tl.indoorStart, label: 'Start indoors' },
        sd.tl.transplant && { doy: sd.tl.transplant, label: 'Transplant' },
        sd.tl.sowStart && { doy: sd.tl.sowStart, label: 'Direct sow' },
      ].filter(Boolean);

      events.forEach(evt => {
        const daysUntil = evt.doy - tdoy;
        const notifKey = `${species}-${evt.label}-${evt.doy}`;
        if (daysUntil >= 0 && daysUntil <= 3 && !notified[notifKey]) {
          new Notification(`ðŸŒ± ${evt.label}: ${species}`, {
            body: daysUntil === 0 ? 'Today!' : `In ${daysUntil} day${daysUntil > 1 ? 's' : ''}. ${formatDoy(evt.doy)}`,
            icon: 'ðŸŒ¿'
          });
          notified[notifKey] = true;
          localStorage.setItem('notifiedEvents', JSON.stringify(notified));
        }
      });
    });
  }, [notificationsEnabled, myGarden, speciesData]);

  React.useEffect(() => {
    if (!notificationsEnabled) return;
    checkAndNotify();
    const interval = setInterval(checkAndNotify, 3600000);
    return () => clearInterval(interval);
  }, [notificationsEnabled, checkAndNotify]);

  const filtered = useMemo(() => {
    return speciesData.filter(sd => {
      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        const nameMatch = sd.species.toLowerCase().includes(q);
        const varMatch = sd.varieties.some(v => v.name.toLowerCase().includes(q));
        if (!nameMatch && !varMatch) return false;
      }
      if (filterSow === 'indoor' && !sd.sowMethod.includes('startIndoors')) return false;
      if (filterSow === 'direct' && !sd.sowMethod.includes('directSow')) return false;
      if (filterType !== 'all' && sd.type !== filterType) return false;
      if (filterPlantNow) {
        const tl = sd.tl;
        const inSow = (tl.sowStart && todayDoy >= tl.sowStart && todayDoy <= tl.sowEnd) ||
          (tl.indoorStart && todayDoy >= tl.indoorStart && todayDoy <= (tl.indoorEnd || tl.indoorStart + 42));
        if (!inSow) return false;
      }
      if (filterBloomNow) {
        if (!(todayDoy >= sd.tl.bloomStart && todayDoy <= sd.tl.bloomEnd)) return false;
      }
      if (filterMyGarden) {
        const hasSelected = sd.varieties.some(v => myGarden[sd.species + '||' + v.name]);
        if (!hasSelected) return false;
      }
      if (filterHeight !== 'all' && sd.height !== filterHeight) return false;
      if (filterColorFamily !== 'all' && getColorFamily(sd.bloomColor) !== filterColorFamily) return false;
      if (filterDeer === 'resistant' && !sd.deerResistant) return false;
      if (filterDeer === 'vulnerable' && sd.deerResistant) return false;
      if (filterPollinator !== 'all' && (!sd.pollinators || !sd.pollinators.includes(filterPollinator))) return false;
      return true;
    });
  }, [speciesData, searchTerm, filterSow, filterType, filterPlantNow, filterBloomNow, filterMyGarden, myGarden, filterHeight, filterColorFamily, todayDoy, filterDeer, filterPollinator]);

  const totalVarieties = useMemo(() => filtered.reduce((sum, sd) => sum + sd.varieties.length, 0), [filtered]);

  const sortedFiltered = useMemo(() => {
    const arr = [...filtered];
    arr.sort((a, b) => {
      switch (sortBy) {
        case 'sowDate': return (a.tl.indoorStart || a.tl.sowStart || 999) - (b.tl.indoorStart || b.tl.sowStart || 999);
        case 'bloomDate': return (a.tl.bloomStart || 999) - (b.tl.bloomStart || 999);
        case 'varieties': return b.varieties.length - a.varieties.length;
        case 'type': {
          const ta = a.type === 'annual' ? 0 : 1;
          const tb = b.type === 'annual' ? 0 : 1;
          return ta !== tb ? ta - tb : a.species.localeCompare(b.species);
        }
        case 'nextAction': {
          const getNext = (sd) => {
            const todayDoy = doy(new Date().getMonth() + 1, new Date().getDate());
            const actions = [
              sd.tl.indoorStart, sd.tl.transplant, sd.tl.sowStart, sd.tl.bloomStart
            ].filter(d => d && d > todayDoy);
            return actions.length > 0 ? Math.min(...actions) : 999;
          };
          return getNext(a) - getNext(b);
        }
        default: return a.species.localeCompare(b.species);
      }
    });
    // Apply custom garden order if in My Garden mode
    if (filterMyGarden && gardenOrder.length > 0) {
      arr.sort((a, b) => {
        const ai = gardenOrder.indexOf(a.species);
        const bi = gardenOrder.indexOf(b.species);
        if (ai === -1 && bi === -1) return 0;
        if (ai === -1) return 1;
        if (bi === -1) return -1;
        return ai - bi;
      });
    }
    return arr;
  }, [filtered, sortBy, filterMyGarden, gardenOrder]);

  const dashboardItems = useMemo(() => {
    const window = 14;
    const items = { indoors: [], transplant: [], directSow: [], blooming: [], nextUp: null };
    let nearestFuture = Infinity;
    let nearestLabel = '';
    
    speciesData.forEach(sd => {
      const tl = sd.tl;
      // Indoor start
      if (tl.indoorStart) {
        if (todayDoy >= tl.indoorStart && todayDoy <= (tl.indoorEnd || tl.indoorStart + 42)) {
          items.indoors.push({ species: sd.species, varCount: sd.varieties.length, date: formatDoy(tl.indoorStart), active: true });
        } else if (tl.indoorStart > todayDoy && tl.indoorStart <= todayDoy + window) {
          items.indoors.push({ species: sd.species, varCount: sd.varieties.length, date: formatDoy(tl.indoorStart), active: false });
        }
        if (tl.indoorStart > todayDoy && tl.indoorStart < nearestFuture) {
          nearestFuture = tl.indoorStart;
          nearestLabel = 'Indoor starting (' + sd.species + ') begins ' + formatDoy(tl.indoorStart);
        }
      }
      // Transplant
      if (tl.transplant) {
        if (todayDoy >= tl.transplant - 3 && todayDoy <= tl.transplant + 7) {
          items.transplant.push({ species: sd.species, varCount: sd.varieties.length, date: formatDoy(tl.transplant) });
        }
        if (tl.transplant > todayDoy && tl.transplant < nearestFuture) {
          nearestFuture = tl.transplant;
          nearestLabel = 'Transplant (' + sd.species + ') begins ' + formatDoy(tl.transplant);
        }
      }
      // Direct sow
      if (tl.sowStart) {
        if (todayDoy >= tl.sowStart && todayDoy <= tl.sowEnd) {
          items.directSow.push({ species: sd.species, varCount: sd.varieties.length, date: formatDoy(tl.sowStart) });
        } else if (tl.sowStart > todayDoy && tl.sowStart <= todayDoy + window) {
          items.directSow.push({ species: sd.species, varCount: sd.varieties.length, date: formatDoy(tl.sowStart), upcoming: true });
        }
        if (tl.sowStart > todayDoy && tl.sowStart < nearestFuture) {
          nearestFuture = tl.sowStart;
          nearestLabel = 'Direct sow (' + sd.species + ') begins ' + formatDoy(tl.sowStart);
        }
      }
      // Blooming
      if (todayDoy >= tl.bloomStart && todayDoy <= tl.bloomEnd) {
        items.blooming.push({ species: sd.species, varCount: sd.varieties.length });
      }
    });
    
    if (nearestFuture < Infinity) {
      items.nextUp = { label: nearestLabel, daysAway: nearestFuture - todayDoy };
    }
    return items;
  }, [speciesData, todayDoy]);

  const toggleSpecies = useCallback((sp, shouldScroll) => {
    setExpandedSpecies(prev => {
      const wasExpanded = prev[sp];
      if (!wasExpanded && shouldScroll !== false) {
        requestAnimationFrame(() => {
          const el = document.querySelector(`[data-species="${sp}"]`);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
      }
      return { ...prev, [sp]: !wasExpanded };
    });
  }, []);

  const dismissOnboarding = useCallback(() => {
    setShowOnboarding(false);
    setWalkStep(null);
    localStorage.setItem('onboardingDismissed', '1');
  }, []);

  const toggleAllSpecies = useCallback(() => {
    if (allExpanded) {
      setExpandedSpecies({});
      setAllExpanded(false);
    } else {
      const all = {};
      sortedFiltered.forEach(sd => { all[sd.species] = true; });
      setExpandedSpecies(all);
      setAllExpanded(true);
    }
  }, [allExpanded, sortedFiltered]);

  // Full-year timeline bar with month gridlines
  const YearBar = ({ tl, height = 20, showGridlines = true, bloomColor = null }) => {
    const [tooltip, setTooltip] = React.useState(null);
    const barRef = React.useRef(null);
    const segments = [];
    let prevPhase = null;
    let segStart = 1;
    for (let d = 1; d <= 366; d++) {
      const phase = d <= 365 ? getPhaseAtDoy(tl, d) : null;
      if (phase !== prevPhase) {
        if (prevPhase && prevPhase !== 'dormant') {
          segments.push({
            phase: prevPhase,
            left: ((segStart - 1) / 365) * 100,
            width: ((d - segStart) / 365) * 100,
            startDoy: segStart,
            endDoy: d - 1
          });
        }
        segStart = d;
        prevPhase = phase;
      }
    }
    const PHASE_TIPS = {
      indoor: 'Sow seeds in trays under grow lights.',
      harden: 'Gradually expose seedlings outdoors.',
      transplant: 'Move seedlings outdoors after frost.',
      sow: 'Plant seeds directly in garden soil.',
      germination: 'Seeds sprouting. Keep soil moist.',
      growing: 'Plants establishing. Water & feed.',
      bloom: 'Flowers open. Deadhead to extend.',
      decline: 'Season ending. Collect seeds.'
    };
    return (
      <div style={{ position: 'relative' }}>
        {/* Month labels above bar */}
        {showGridlines && (
          <div className="relative" style={{ height: '14px' }}>
            {MONTHS.map((m, mi) => {
              const left = (MONTH_START_DOY[mi] / 365) * 100;
              const width = (MONTH_DAYS[mi] / 365) * 100;
              return <span key={m} className="absolute text-center" style={{ left: left + '%', width: width + '%', fontSize: '9px', fontWeight: 400, color: '#999', letterSpacing: '0.05em', textTransform: 'uppercase' }}>{m}</span>;
            })}
          </div>
        )}
        <div ref={barRef} className="relative overflow-visible" style={{ height: height + 'px', backgroundColor: '#e8e2d0', borderRadius: 0, border: '1px solid #ccc' }}>
          {/* Month gridlines */}
          {showGridlines && MONTH_START_DOY.slice(1).map((md, i) => (
            <div key={i} className="absolute top-0 bottom-0" style={{ left: (md / 365 * 100) + '%', width: '1px', backgroundColor: 'rgba(0,0,0,0.08)' }} />
          ))}
          {/* Phase segments */}
          {segments.map((seg, i) => (
            <div key={i} className="absolute top-0 bottom-0 year-bar-seg"
              onMouseEnter={(e) => {
                const rect = barRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                setTooltip({ text: PHASE_COLORS[seg.phase].label, dates: `${formatDoy(seg.startDoy)} â€“ ${formatDoy(seg.endDoy)}`, tip: PHASE_TIPS[seg.phase] || '', left: (x / rect.width) * 100 });
              }}
              onMouseLeave={() => setTooltip(null)}
              onClick={() => setTooltip(prev => prev ? null : { text: PHASE_COLORS[seg.phase].label, dates: `${formatDoy(seg.startDoy)} â€“ ${formatDoy(seg.endDoy)}`, tip: PHASE_TIPS[seg.phase] || '', left: seg.left + seg.width / 2 })}
              style={{ left: seg.left + '%', width: Math.max(seg.width, 0.3) + '%', backgroundColor: PHASE_COLORS[seg.phase].bg, cursor: 'pointer' }} />
          ))}
          {/* Today marker */}
          <div className="absolute" style={{ left: 'calc(' + todayPct + '% - 1px)', top: '-2px', bottom: '-2px', width: '2px', backgroundColor: '#c00', zIndex: 2 }} />
          {/* Styled tooltip */}
          {tooltip && (
            <div className="year-bar-tooltip" style={{ left: tooltip.left + '%' }}>
              <div style={{ fontWeight: 700 }}>{tooltip.text}</div>
              <div style={{ opacity: 0.85, fontSize: '10px' }}>{tooltip.dates}</div>
              {tooltip.tip && <div style={{ opacity: 0.7, fontSize: '10px', marginTop: '2px' }}>{tooltip.tip}</div>}
            </div>
          )}
        </div>
      </div>
    );
  };

  // Current phase badge (hide dormant)
  const PhaseBadge = ({ tl, bloomColor }) => {
    const phase = getPhaseAtDoy(tl, todayDoy);
    if (phase === 'dormant') return null;
    const c = PHASE_COLORS[phase];
    const bgColor = c.bg;
    return <span className="text-xs px-2 py-0.5 font-bold uppercase" style={{ backgroundColor: bgColor, color: '#fff', letterSpacing: '0.08em', fontSize: '10px' }}>{c.label}</span>;
  };

  // Key dates summary (compact text)
  const KeyDates = ({ tl, type }) => {
    const parts = [];
    if (tl.indoorStart) parts.push({ label: 'Indoor', date: formatDoy(tl.indoorStart), color: PHASE_COLORS.indoor.bg });
    if (tl.transplant) parts.push({ label: 'Transplant', date: formatDoy(tl.transplant), color: PHASE_COLORS.transplant.bg });
    if (tl.sowStart) parts.push({ label: 'Sow', date: formatDoy(tl.sowStart), color: PHASE_COLORS.sow.bg });
    parts.push({ label: 'Bloom', date: formatDoy(tl.bloomStart), color: PHASE_COLORS.bloom.bg });
    return (
      <div className="flex flex-wrap gap-x-3.5 gap-y-0.5 text-xs text-stone-500">
        {parts.map((p, i) => (
          <span key={i} className="flex items-center gap-1.5">
            <span className="inline-block w-1.5 h-1.5 rounded-full" style={{ backgroundColor: p.color }} />
            <span className="font-medium text-stone-600">{p.label}</span> <span className="tabular-nums">{p.date}</span>
          </span>
        ))}
      </div>
    );
  };

  const dm = useMemo(() => ({
    bg: darkMode ? '#0f172a' : '#f8fafc',
    cardBg: darkMode ? '#1e293b' : '#fff',
    border: darkMode ? '#334155' : '#e2e8f0',
    text: darkMode ? '#e2e8f0' : '#1e293b',
    textMuted: darkMode ? '#94a3b8' : '#64748b',
    textFaint: darkMode ? '#64748b' : '#94a3b8',
    headerBg: darkMode ? '#1e293b' : '#1e293b',
    toolbarBg: darkMode ? 'rgba(30,41,59,0.97)' : 'rgba(241,245,249,0.98)',
    inputBg: darkMode ? '#334155' : '#fff',
    chipBg: darkMode ? '#1e293b' : '#fff',
    altRow: darkMode ? '#1e293b' : '#f8fafc',
  }), [darkMode]);

  return (
    <div className="min-h-screen" style={{ backgroundColor: dm.bg }}>
      {/* Header */}
      <div ref={headerRef} style={{ borderBottom: '2px solid #334155', backgroundColor: dm.headerBg }}>
        <div className="max-w-6xl mx-auto px-5 py-3" style={{ paddingLeft: '20px', paddingRight: '20px' }}>
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <div>
              <h1 className="font-bold" style={{ fontSize: '20px', letterSpacing: '4px', textTransform: 'uppercase', color: '#fff' }}>VERDANT ATLAS</h1>
              <p style={{ fontWeight: 400, color: '#94a3b8', letterSpacing: '3px', fontSize: '11px', textTransform: 'uppercase' }}>Planting Calendar</p>
              <p className="mt-1" style={{ fontWeight: 400, color: '#64748b', letterSpacing: '1px', fontSize: '11px' }}>Zone 5b Â· {totalVarieties} varieties, {filtered.length} species</p>
              <div className="mt-1 flex flex-wrap items-center gap-x-4 gap-y-1" style={{ fontSize: '11px' }}>
                <div className="flex items-center gap-2">
                  <span style={{ color: '#94a3b8' }}>Last frost:</span>
                  <button onClick={() => setLastFrostOffset(f => f - 1)} title="Shift last frost date earlier by 1 week" style={{ width: '32px', height: '32px', border: '1px solid #475569', backgroundColor: '#334155', color: '#e2e8f0', cursor: 'pointer', fontSize: '14px', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>âˆ’</button>
                  <span style={{ color: lastFrostOffset === 0 ? '#94a3b8' : '#e2e8f0', fontWeight: lastFrostOffset !== 0 ? 700 : 400, minWidth: '50px', textAlign: 'center' }}>
                    {formatDoy(customMidcoast.lastFrost)}
                  </span>
                  <button onClick={() => setLastFrostOffset(f => f + 1)} title="Shift last frost date later by 1 week" style={{ width: '32px', height: '32px', border: '1px solid #475569', backgroundColor: '#334155', color: '#e2e8f0', cursor: 'pointer', fontSize: '14px', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>+</button>
                  {lastFrostOffset !== 0 && <span style={{ color: '#94a3b8', fontSize: '10px' }}>({lastFrostOffset > 0 ? '+' : ''}{lastFrostOffset}w)</span>}
                  <button onClick={() => setShowZipInput(!showZipInput)} title="Look up frost dates by ZIP code" style={{ fontSize: '12px', border: '1px solid #475569', backgroundColor: '#334155', color: '#e2e8f0', cursor: 'pointer', borderRadius: '4px', padding: '2px 6px', marginLeft: '8px' }}>ðŸ“</button>
                </div>
                <div className="flex items-center gap-2">
                  <span style={{ color: '#94a3b8' }}>First frost:</span>
                  <button onClick={() => setFirstFrostOffset(f => f - 1)} title="Shift first frost date earlier by 1 week" style={{ width: '32px', height: '32px', border: '1px solid #475569', backgroundColor: '#334155', color: '#e2e8f0', cursor: 'pointer', fontSize: '14px', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>âˆ’</button>
                  <span style={{ color: firstFrostOffset === 0 ? '#94a3b8' : '#e2e8f0', fontWeight: firstFrostOffset !== 0 ? 700 : 400, minWidth: '50px', textAlign: 'center' }}>
                    {formatDoy(customMidcoast.firstFrost)}
                  </span>
                  <button onClick={() => setFirstFrostOffset(f => f + 1)} title="Shift first frost date later by 1 week" style={{ width: '32px', height: '32px', border: '1px solid #475569', backgroundColor: '#334155', color: '#e2e8f0', cursor: 'pointer', fontSize: '14px', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>+</button>
                  {firstFrostOffset !== 0 && <span style={{ color: '#94a3b8', fontSize: '10px' }}>({firstFrostOffset > 0 ? '+' : ''}{firstFrostOffset}w)</span>}
                </div>
                {(lastFrostOffset !== 0 || firstFrostOffset !== 0) && (
                  <button onClick={() => { setLastFrostOffset(0); setFirstFrostOffset(0); }} style={{ color: '#94a3b8', background: 'none', border: 'none', cursor: 'pointer', fontSize: '10px', textDecoration: 'underline' }}>reset</button>
                )}
                <span style={{ color: '#94a3b8', fontSize: '10px' }}>({Math.round((customMidcoast.firstFrost - customMidcoast.lastFrost) / 7)} week season)</span>
                <div style={{ width: '100%', marginTop: '6px' }}>
                  <div style={{ height: '4px', backgroundColor: '#334155', borderRadius: '2px', position: 'relative', overflow: 'hidden' }}>
                    {/* Growing season fill */}
                    <div style={{
                      position: 'absolute',
                      left: ((customMidcoast.lastFrost / 365) * 100) + '%',
                      width: (((customMidcoast.firstFrost - customMidcoast.lastFrost) / 365) * 100) + '%',
                      height: '100%',
                      backgroundColor: '#16a34a',
                      opacity: 0.4
                    }} />
                    {/* Today marker */}
                    <div style={{
                      position: 'absolute',
                      left: ((todayDoy / 365) * 100) + '%',
                      width: '3px',
                      height: '100%',
                      backgroundColor: todayDoy >= customMidcoast.lastFrost && todayDoy <= customMidcoast.firstFrost ? '#fff' : '#ef4444',
                      borderRadius: '1px',
                      transform: 'translateX(-1px)'
                    }} />
                  </div>
                  <div className="flex justify-between" style={{ fontSize: '9px', color: '#64748b', marginTop: '2px' }}>
                    <span>Jan</span>
                    <span>Apr</span>
                    <span>Jul</span>
                    <span>Oct</span>
                    <span>Dec</span>
                  </div>
                </div>
                {showZipInput && (
                  <div className="flex items-center gap-2" style={{ marginTop: '8px', padding: '8px', backgroundColor: '#f8fafc', borderRadius: '4px', border: '1px solid #e2e8f0' }}>
                    <input
                      type="text"
                      placeholder="Enter ZIP code"
                      value={zipCode}
                      onChange={(e) => setZipCode(e.target.value.trim())}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          const data = ZIP_FROST_DATA[zipCode];
                          if (data) {
                            const lastFrostWeekDiff = Math.round((data.lastFrost - MIDCOAST.lastFrost) / 7);
                            const firstFrostWeekDiff = Math.round((data.firstFrost - MIDCOAST.firstFrost) / 7);
                            setLastFrostOffset(lastFrostWeekDiff);
                            setFirstFrostOffset(firstFrostWeekDiff);
                            setZipResult(zipCode);
                            setZipCode('');
                          } else {
                            setZipResult(null);
                          }
                        }
                      }}
                      style={{ padding: '4px 6px', fontSize: '12px', border: '1px solid #e2e8f0', borderRadius: '4px', width: '80px' }}
                    />
                    {zipResult && <span style={{ fontSize: '11px', color: '#16a34a', fontWeight: 600 }}>âœ“ {zipResult}</span>}
                    {zipResult === false && <span style={{ fontSize: '11px', color: '#ef4444' }}>ZIP not found</span>}
                    {!zipResult && zipCode && <span style={{ fontSize: '10px', color: '#94a3b8' }}>Press Enter</span>}
                  </div>
                )}
              </div>
              {/* Dashboard summary */}
              <div className="mt-2 flex flex-wrap gap-2" style={{ fontSize: '11px' }}>
                {dashboardItems.indoors.length > 0 && (
                  <div style={{ borderLeft: '3px solid ' + PHASE_COLORS.indoor.bg, backgroundColor: 'rgba(124,58,237,0.15)', padding: '4px 10px', borderRadius: '0 4px 4px 0' }}>
                    <span style={{ fontWeight: 700, color: PHASE_COLORS.indoor.bg, textTransform: 'uppercase', fontSize: '9px', letterSpacing: '0.5px' }}>Start indoors</span>
                    <span style={{ color: '#cbd5e1', marginLeft: '6px' }}>
                      {dashboardItems.indoors.map((i, idx) => (
                        <React.Fragment key={idx}>
                          {idx > 0 && ', '}
                          <button
                            onClick={() => { setSearchTerm(i.species); if (viewMode !== 'list') setViewMode('list'); window.scrollTo(0, 0); }}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'inherit', fontWeight: 600, textDecoration: 'underline', textDecorationStyle: 'dotted', padding: 0 }}>
                            {i.species}
                          </button>
                        </React.Fragment>
                      ))}
                    </span>
                  </div>
                )}
                {dashboardItems.transplant.length > 0 && (
                  <div style={{ borderLeft: '3px solid ' + PHASE_COLORS.transplant.bg, backgroundColor: 'rgba(37,99,235,0.15)', padding: '4px 10px', borderRadius: '0 4px 4px 0' }}>
                    <span style={{ fontWeight: 700, color: PHASE_COLORS.transplant.bg, textTransform: 'uppercase', fontSize: '9px', letterSpacing: '0.5px' }}>Transplant</span>
                    <span style={{ color: '#cbd5e1', marginLeft: '6px' }}>
                      {dashboardItems.transplant.map((i, idx) => (
                        <React.Fragment key={idx}>
                          {idx > 0 && ', '}
                          <button
                            onClick={() => { setSearchTerm(i.species); if (viewMode !== 'list') setViewMode('list'); window.scrollTo(0, 0); }}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'inherit', fontWeight: 600, textDecoration: 'underline', textDecorationStyle: 'dotted', padding: 0 }}>
                            {i.species}
                          </button>
                        </React.Fragment>
                      ))}
                    </span>
                  </div>
                )}
                {dashboardItems.directSow.length > 0 && (
                  <div style={{ borderLeft: '3px solid ' + PHASE_COLORS.sow.bg, backgroundColor: 'rgba(22,163,106,0.15)', padding: '4px 10px', borderRadius: '0 4px 4px 0' }}>
                    <span style={{ fontWeight: 700, color: PHASE_COLORS.sow.bg, textTransform: 'uppercase', fontSize: '9px', letterSpacing: '0.5px' }}>Direct sow</span>
                    <span style={{ color: '#cbd5e1', marginLeft: '6px' }}>
                      {dashboardItems.directSow.map((i, idx) => (
                        <React.Fragment key={idx}>
                          {idx > 0 && ', '}
                          <button
                            onClick={() => { setSearchTerm(i.species); if (viewMode !== 'list') setViewMode('list'); window.scrollTo(0, 0); }}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'inherit', fontWeight: 600, textDecoration: 'underline', textDecorationStyle: 'dotted', padding: 0 }}>
                            {i.species}
                          </button>
                        </React.Fragment>
                      ))}
                    </span>
                  </div>
                )}
                {dashboardItems.blooming.length > 0 && (
                  <div style={{ borderLeft: '3px solid ' + PHASE_COLORS.bloom.bg, backgroundColor: 'rgba(236,72,153,0.15)', padding: '4px 10px', borderRadius: '0 4px 4px 0' }}>
                    <span style={{ fontWeight: 700, color: PHASE_COLORS.bloom.bg, textTransform: 'uppercase', fontSize: '9px', letterSpacing: '0.5px' }}>Blooming</span>
                    <span style={{ color: '#cbd5e1', marginLeft: '6px' }}>
                      {dashboardItems.blooming.map((i, idx) => (
                        <React.Fragment key={idx}>
                          {idx > 0 && ', '}
                          <button
                            onClick={() => { setSearchTerm(i.species); if (viewMode !== 'list') setViewMode('list'); window.scrollTo(0, 0); }}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'inherit', fontWeight: 600, textDecoration: 'underline', textDecorationStyle: 'dotted', padding: 0 }}>
                            {i.species}
                          </button>
                        </React.Fragment>
                      ))}
                    </span>
                  </div>
                )}
                {dashboardItems.indoors.length === 0 && dashboardItems.transplant.length === 0 && dashboardItems.directSow.length === 0 && dashboardItems.blooming.length === 0 && dashboardItems.nextUp && (
                  <div style={{ borderLeft: '3px solid #475569', backgroundColor: 'rgba(100,116,139,0.15)', padding: '4px 10px', borderRadius: '0 4px 4px 0' }}>
                    <span style={{ color: '#94a3b8' }}>Next: <strong style={{ color: '#e2e8f0' }}>{dashboardItems.nextUp.label}</strong> ({dashboardItems.nextUp.daysAway}d)</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Guided walkthrough overlay */}
      {walkStep !== null && walkStep >= 0 && walkStep <= 3 && (() => {
        const WALK_STEPS = [
          { selector: 'input[placeholder*="Search"]', title: 'Search Varieties', text: 'Search 147 flower varieties by name. Try "sun" or "purple".' },
          { selector: '[data-species]', title: 'Explore Species', text: 'Tap any card to expand it and see varieties, dates, and growing details.' },
          { selector: '.variety-chip', title: 'Star Your Favorites', text: 'Click the star on any variety to add it to your garden plan.' },
          { selector: '[title="Show only your starred varieties"]', title: 'View My Garden', text: 'See all your starred varieties in one place. Your selections save automatically.' },
        ];
        const step = WALK_STEPS[walkStep];
        const el = document.querySelector(step.selector);
        const rect = el ? el.getBoundingClientRect() : { top: 200, left: 100, width: 200, height: 40 };
        const pad = 8;
        return (
          <div className="fixed inset-0 z-50" style={{ pointerEvents: 'auto' }}>
            <svg className="absolute inset-0" width="100%" height="100%" style={{ pointerEvents: 'none' }}>
              <defs>
                <mask id="walk-mask">
                  <rect width="100%" height="100%" fill="white" />
                  <rect x={rect.left - pad} y={rect.top - pad} width={rect.width + pad * 2} height={rect.height + pad * 2} rx="8" fill="black" />
                </mask>
              </defs>
              <rect width="100%" height="100%" fill="rgba(0,0,0,0.5)" mask="url(#walk-mask)" />
            </svg>
            <div style={{
              position: 'absolute',
              top: Math.min(rect.top + rect.height + pad + 12, window.innerHeight - 160),
              left: Math.max(16, Math.min(rect.left, window.innerWidth - 300)),
              width: '280px',
              backgroundColor: '#fff',
              borderRadius: '12px',
              padding: '16px 20px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.25)',
              zIndex: 51
            }}>
              <p style={{ fontSize: '10px', color: '#6366f1', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1.5px', marginBottom: '4px' }}>Step {walkStep + 1} of 4</p>
              <p style={{ fontSize: '15px', fontWeight: 700, color: '#1e293b', marginBottom: '6px' }}>{step.title}</p>
              <p style={{ fontSize: '13px', color: '#64748b', lineHeight: 1.5, marginBottom: '14px' }}>{step.text}</p>
              <div className="flex gap-2 justify-end">
                <button onClick={dismissOnboarding} style={{ fontSize: '12px', color: '#94a3b8', background: 'none', border: 'none', cursor: 'pointer', padding: '6px 12px' }}>Skip</button>
                <button onClick={() => { if (walkStep >= 3) { dismissOnboarding(); } else { setWalkStep(walkStep + 1); } }}
                  style={{ fontSize: '12px', fontWeight: 700, color: '#fff', backgroundColor: '#6366f1', border: 'none', borderRadius: '6px', cursor: 'pointer', padding: '6px 16px' }}>
                  {walkStep >= 3 ? 'Done' : 'Next'}
                </button>
              </div>
            </div>
          </div>
        );
      })()}

      {/* Sticky toolbar */}
      <div role="navigation" aria-label="Planting calendar filters" className="sticky top-0 z-20" style={{ backgroundColor: dm.toolbarBg, borderBottom: '2px solid ' + dm.border, boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
        {(() => {
          const weekActions = [];
          speciesData.forEach(sd => {
            const tl = sd.tl;
            if (tl.indoorStart && todayDoy >= tl.indoorStart && todayDoy <= tl.indoorStart + 7) {
              weekActions.push({ action: 'Start indoors', species: sd.species, phase: 'indoor' });
            }
            if (tl.transplant && todayDoy >= tl.transplant - 3 && todayDoy <= tl.transplant + 3) {
              weekActions.push({ action: 'Transplant', species: sd.species, phase: 'transplant' });
            }
            if (tl.sowStart && todayDoy >= tl.sowStart && todayDoy <= tl.sowStart + 7) {
              weekActions.push({ action: 'Direct sow', species: sd.species, phase: 'sow' });
            }
          });
          if (weekActions.length === 0) {
            // Off-season: find the nearest upcoming activity across all species
            let nearestEvent = null;
            speciesData.forEach(sd => {
              const tl = sd.tl;
              const events = [];
              if (tl.indoorStart && tl.indoorStart > todayDoy) events.push({ doy: tl.indoorStart, label: 'Indoor starting', species: sd.species, phase: 'indoor' });
              if (tl.sowStart && tl.sowStart > todayDoy) events.push({ doy: tl.sowStart, label: 'Direct sowing', species: sd.species, phase: 'sow' });
              if (tl.transplant && tl.transplant > todayDoy) events.push({ doy: tl.transplant, label: 'Transplanting', species: sd.species, phase: 'transplant' });
              events.forEach(ev => {
                if (!nearestEvent || ev.doy < nearestEvent.doy) nearestEvent = ev;
              });
            });
            if (!nearestEvent) return null;
            const daysAway = nearestEvent.doy - todayDoy;
            const weeksAway = Math.ceil(daysAway / 7);
            return (
              <div style={{ padding: '8px 20px', backgroundColor: darkMode ? '#1e293b' : '#f8fafc', borderBottom: '1px solid ' + dm.border, fontSize: '12px', display: 'flex', alignItems: 'center', gap: '10px', flexWrap: 'wrap' }}>
                <span style={{ fontWeight: 700, color: '#94a3b8', textTransform: 'uppercase', fontSize: '10px', letterSpacing: '1px' }}>Off season</span>
                <span style={{ color: dm.textMuted }}>Growing season starts in <strong style={{ color: '#6366f1', fontWeight: 700 }}>{weeksAway} week{weeksAway !== 1 ? 's' : ''}</strong></span>
                <span style={{ color: dm.textFaint, fontSize: '11px' }}>Next up: {nearestEvent.label} {nearestEvent.species} ({formatDoy(nearestEvent.doy)})</span>
                  {Object.keys(myGarden).length > 0 && (
                    <div style={{ marginTop: '12px', padding: '12px 16px', backgroundColor: dm.altRow, borderRadius: '8px', border: '1px solid ' + dm.border }}>
                      <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                        <div style={{ flex: 1 }}>
                          <p style={{ fontSize: '13px', fontWeight: 700, color: dm.text, marginBottom: '4px' }}>Garden Planning</p>
                          <p style={{ fontSize: '12px', color: dm.textMuted }}>
                            You have <strong>{Object.keys(myGarden).length}</strong> varieties saved. Order seeds now so you're ready for spring.
                          </p>
                        </div>
                        <div className="flex gap-2 flex-wrap">
                          <button onClick={() => { setFilterMyGarden(true); setViewMode('list'); }}
                            style={{ fontSize: '11px', padding: '6px 14px', backgroundColor: '#6366f1', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 700 }}>
                            View My Garden
                          </button>
                          <button onClick={() => { setFilterMyGarden(true); copyShoppingList(); }}
                            style={{ fontSize: '11px', padding: '6px 14px', backgroundColor: dm.chipBg, color: dm.text, border: '1px solid ' + dm.border, borderRadius: '6px', cursor: 'pointer', fontWeight: 600 }}>
                            Copy Seed List
                          </button>
                        </div>
                      </div>
                      {(() => {
                        const gardenSpecies = [...new Set(Object.keys(myGarden).map(k => k.split('||')[0]))];
                        const companions = [];
                        gardenSpecies.forEach(sp => {
                          const sd = speciesData.find(s => s.species === sp);
                          if (sd && sd.companions) {
                            sd.companions.forEach(c => {
                              if (!gardenSpecies.includes(c) && !companions.includes(c)) companions.push(c);
                            });
                          }
                        });
                        if (companions.length === 0) return null;
                        return (
                          <div style={{ marginTop: '10px', paddingTop: '10px', borderTop: '1px solid ' + dm.border }}>
                            <p style={{ fontSize: '11px', color: dm.textMuted, marginBottom: '6px' }}>Consider adding companions:</p>
                            <div className="flex gap-1.5 flex-wrap">
                              {companions.slice(0, 6).map(c => (
                                <button key={c} onClick={() => { setFilterMyGarden(false); setSearchTerm(c); }}
                                  style={{ fontSize: '10px', padding: '3px 10px', backgroundColor: darkMode ? '#312e81' : '#eef2ff', color: darkMode ? '#c7d2fe' : '#4338ca', border: '1px solid ' + (darkMode ? '#4338ca' : '#c7d2fe'), borderRadius: '12px', cursor: 'pointer', fontWeight: 600 }}>
                                  + {c}
                                </button>
                              ))}
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  )}

              </div>
            );
          }
          return (
            <div style={{ padding: '6px 20px', backgroundColor: '#eef2ff', borderBottom: '1px solid #c7d2fe', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
              <span style={{ fontWeight: 700, color: '#6366f1', textTransform: 'uppercase', fontSize: '10px', letterSpacing: '1px' }}>This week</span>
              {weekActions.map((a, i) => (
                <span key={i} style={{ display: 'inline-flex', alignItems: 'center', gap: '4px' }}>
                  <span style={{ width: '6px', height: '6px', borderRadius: '2px', backgroundColor: PHASE_COLORS[a.phase].bg, display: 'inline-block' }} />
                  <span style={{ color: '#475569' }}>{a.action} <strong style={{ color: dm.text }}>{a.species}</strong></span>
                  {i < weekActions.length - 1 && <span style={{ color: '#cbd5e1', margin: '0 2px' }}>Â·</span>}
                </span>
              ))}
            </div>
          );
        })()}
        <div className="max-w-6xl mx-auto" style={{ paddingLeft: scrolledPast ? '12px' : '20px', paddingRight: scrolledPast ? '12px' : '20px' }}>
          <div className="flex flex-col sm:flex-row gap-3 py-3 flex-wrap items-center">
            {/* GROUP A: Filters (Search + dropdowns) */}
            <div>
              <p className="hidden sm:block" style={{ fontSize: '8px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1.5px', color: '#94a3b8', marginBottom: '2px' }}>Filter</p>
              <div className="flex gap-2 flex-wrap items-center flex-1 min-w-0">
                <div className="relative flex-1 min-w-[200px]">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2" size={15} style={{ color: '#94a3b8' }} />
                <input type="text" aria-label="Search species or varieties" placeholder="Search species or varieties..." value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                  onFocus={() => setSearchFocused(true)}
                  onBlur={() => setTimeout(() => setSearchFocused(false), 200)}
                  className="w-full pl-9 pr-8 py-2 text-sm transition-all" style={{ fontWeight: 400, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '6px' }} />
                {searchTerm && (
                  <button onClick={() => setSearchTerm('')}
                    className="absolute right-2 top-1/2 -translate-y-1/2 flex items-center justify-center"
                    style={{ width: '18px', height: '18px', borderRadius: '50%', backgroundColor: dm.border, border: 'none', cursor: 'pointer', fontSize: '12px', color: dm.textMuted, lineHeight: 1 }}>
                    Ã—
                  </button>
                )}
                {searchFocused && !searchTerm && (
                  <div className="absolute z-30 mt-1 flex flex-wrap gap-1.5" style={{ top: '100%', left: 0 }}>
                    {['Zinnia', 'Cosmos', 'Sunflower', 'Petunia', 'Snapdragon'].map(s => (
                      <button key={s} onMouseDown={(e) => { e.preventDefault(); setSearchTerm(s); }}
                        style={{ fontSize: '11px', padding: '3px 10px', backgroundColor: darkMode ? '#312e81' : '#eef2ff', color: darkMode ? '#c7d2fe' : '#4338ca', border: '1px solid ' + (darkMode ? '#4338ca' : '#c7d2fe'), borderRadius: '12px', cursor: 'pointer', fontWeight: 600 }}>
                        {s}
                      </button>
                    ))}
                    <span style={{ fontSize: '10px', color: '#94a3b8', padding: '4px 4px', alignSelf: 'center' }}>Try a species name</span>
                  </div>
                )}
              </div>
              {/* Filter collapse toggle + dark mode - always visible */}
              <button onClick={() => setFiltersOpen(!filtersOpen)}
                className="filter-btn px-3 py-2 text-sm font-bold"
                style={{ backgroundColor: filtersOpen ? '#1e293b' : dm.chipBg, color: filtersOpen ? '#fff' : dm.textMuted, border: '1px solid ' + dm.border, borderRadius: '4px', minHeight: '44px' }}>
                Filters {filtersOpen ? 'â–´' : 'â–¾'}
              </button>
              <button onClick={() => setDarkMode(!darkMode)}
                title={darkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                className="filter-btn text-sm"
                style={{ backgroundColor: darkMode ? '#334155' : '#fff', color: darkMode ? '#f1f5f9' : '#94a3b8', border: '1px solid ' + (darkMode ? '#475569' : '#e2e8f0'), borderRadius: '4px', fontSize: '16px', padding: '8px 12px', minHeight: '44px' }}>
                {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
              </button>
              {/* Dropdowns - collapsible */}
              <div className="flex gap-2 flex-wrap items-center w-full sm:w-auto" style={{ display: filtersOpen ? 'flex' : 'none' }}>
                <select value={filterSow} onChange={e => setFilterSow(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  <option value="all">All methods</option>
                  <option value="indoor">Indoor start</option>
                  <option value="direct">Direct sow</option>
                </select>
                <select value={filterType} onChange={e => setFilterType(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  <option value="all">All types</option>
                  <option value="annual">Annual</option>
                  <option value="perennial">Perennial</option>
                </select>
                <select value={filterHeight} onChange={e => setFilterHeight(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  <option value="all">All heights</option>
                  <option value="ground">Ground (0-6")</option>
                  <option value="short">Short (6-18")</option>
                  <option value="medium">Medium (18-36")</option>
                  <option value="tall">Tall (36-60")</option>
                  <option value="vine">Vine</option>
                </select>
                <select value={filterColorFamily} onChange={e => setFilterColorFamily(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  {Object.entries(COLOR_FAMILIES).map(([k, v]) => (
                    <option key={k} value={k}>{v}</option>
                  ))}
                </select>
                <select value={filterDeer} onChange={e => setFilterDeer(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  <option value="all">All deer</option>
                  <option value="resistant">Deer resistant</option>
                  <option value="vulnerable">Deer vulnerable</option>
                </select>
                <select value={filterPollinator} onChange={e => setFilterPollinator(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  <option value="all">All pollinators</option>
                  <option value="bee">Bee friendly</option>
                  <option value="butterfly">Butterfly</option>
                  <option value="hummingbird">Hummingbird</option>
                </select>
                <select value={sortBy} onChange={e => setSortBy(e.target.value)}
                  className="px-3 py-2 text-sm cursor-pointer" style={{ fontWeight: 700, backgroundColor: dm.inputBg, border: '1px solid ' + dm.border, color: dm.text, borderRadius: '4px' }}>
                  <option value="alpha">Sort: A-Z</option>
                  <option value="sowDate">Sort: Sow date</option>
                  <option value="bloomDate">Sort: Bloom date</option>
                  <option value="varieties">Sort: Most varieties</option>
                  <option value="type">Sort: Type</option>
                  <option value="nextAction">Sort: Next action</option>
                </select>
              </div>
              </div>
            </div>

            {/* Separator */}
            {filtersOpen && <div className="hidden sm:block" style={{ width: '1px', height: '28px', backgroundColor: dm.border }} />}

            {/* GROUP B: Quick Filters */}
            {filtersOpen && <div>
              <p className="hidden sm:block" style={{ fontSize: '8px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1.5px', color: '#94a3b8', marginBottom: '2px' }}>Status</p>
              <div className="flex gap-2 flex-wrap items-center">
              <button onClick={() => setFilterPlantNow(!filterPlantNow)}
                title="Show only species you can plant or start this week"
                className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                style={filterPlantNow ? { backgroundColor: '#f0fdf4', color: '#16a34a', border: '1px solid #bbf7d0', borderLeft: '3px solid #16a34a', fontWeight: 700 } : { backgroundColor: dm.chipBg, color: dm.textMuted, border: '1px solid ' + dm.border }}>
                Plant Now
              </button>
              <button onClick={() => setFilterBloomNow(!filterBloomNow)}
                title="Show only species currently in bloom"
                className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                style={filterBloomNow ? { backgroundColor: '#f0fdf4', color: '#16a34a', border: '1px solid #bbf7d0', borderLeft: '3px solid #16a34a', fontWeight: 700 } : { backgroundColor: dm.chipBg, color: dm.textMuted, border: '1px solid ' + dm.border }}>
                Blooming
              </button>
              <button onClick={() => setFilterMyGarden(!filterMyGarden)}
                title="Show only your starred varieties"
                className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                style={filterMyGarden ? { backgroundColor: '#f0fdf4', color: '#16a34a', border: '1px solid #bbf7d0', borderLeft: '3px solid #16a34a', fontWeight: 700 } : { backgroundColor: dm.chipBg, color: dm.textMuted, border: '1px solid ' + dm.border }}>
                My Garden{Object.keys(myGarden).length > 0 ? ` (${Object.keys(myGarden).length})` : ''}
              </button>
              <button onClick={() => setShowPresets(true)}
                title="Browse curated garden collections"
                className="filter-btn px-3 py-2 text-sm font-bold whitespace-nowrap"
                style={{ backgroundColor: dm.chipBg, color: '#6366f1', border: '1px solid #c7d2fe', fontSize: '11px' }}>
                Garden Ideas
              </button>
              {Object.keys(myGarden).length > 0 && (
                <>
                  <button onClick={copyShoppingList}
                    title="Copy your garden selections as a shopping list to clipboard"
                    className="filter-btn px-2.5 py-2 text-sm font-bold whitespace-nowrap"
                    style={{ backgroundColor: copiedList ? '#16a34a' : '#fff', color: copiedList ? '#fff' : '#94a3b8', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px' }}>
                    {copiedList ? 'âœ“ Copied!' : 'ðŸ“‹ Copy List'}
                  </button>
                  <button onClick={() => {
                      if (!filterMyGarden) setFilterMyGarden(true);
                      setTimeout(() => window.print(), 300);
                    }}
                    title="Print your garden plan"
                    className="filter-btn px-2.5 py-2 text-sm font-bold whitespace-nowrap"
                    style={{ backgroundColor: dm.chipBg, color: dm.textMuted, border: '1px solid ' + dm.border, borderRadius: '4px', fontSize: '11px' }}>
                    ðŸ–¨ Print
                  </button>
                  <button onClick={notificationsEnabled ? () => { setNotificationsEnabled(false); localStorage.setItem('notificationsEnabled', '0'); } : enableNotifications}
                    title={notificationsEnabled ? 'Disable planting reminders' : 'Get browser notifications 3 days before planting events'}
                    className="filter-btn px-2.5 py-2 text-sm font-bold whitespace-nowrap"
                    style={{ backgroundColor: notificationsEnabled ? '#16a34a' : '#fff', color: notificationsEnabled ? '#fff' : '#94a3b8', border: '1px solid ' + (notificationsEnabled ? '#16a34a' : '#e2e8f0'), borderRadius: '4px', fontSize: '11px' }}>
                    {notificationsEnabled ? 'ðŸ”” On' : 'ðŸ”” Remind'}
                  </button>
                  <button onClick={downloadICSCalendar}
                    title="Download calendar events for your garden plan"
                    className="filter-btn px-2.5 py-2 text-sm font-bold whitespace-nowrap"
                    style={{ backgroundColor: dm.chipBg, color: dm.textMuted, border: '1px solid ' + dm.border, borderRadius: '4px', fontSize: '11px' }}>
                    ðŸ“… Calendar
                  </button>
                  <button onClick={exportCSV}
                    title="Download your garden plan as a CSV spreadsheet"
                    className="filter-btn px-2.5 py-2 text-sm font-bold whitespace-nowrap"
                    style={{ backgroundColor: dm.chipBg, color: dm.textMuted, border: '1px solid ' + dm.border, borderRadius: '4px', fontSize: '11px' }}>
                    ðŸ“Š CSV
                  </button>
                  <button onClick={() => {
                    if (window.confirm('Remove all varieties from My Garden? This cannot be undone.')) {
                      setMyGarden({});
                    }
                  }}
                    title="Remove all varieties from your garden plan"
                    className="filter-btn px-2.5 py-2 text-sm font-bold whitespace-nowrap"
                    style={{ backgroundColor: dm.chipBg, color: '#ef4444', border: '1px solid #fecaca', borderRadius: '4px', fontSize: '11px' }}>
                    âœ• Unstar All
                  </button>
                  {hasActiveFilters && (
                    <button onClick={clearAllFilters}
                      title="Reset all filters and search to defaults"
                      className="filter-btn px-2.5 py-2 text-sm whitespace-nowrap"
                      style={{ backgroundColor: dm.chipBg, color: '#ef4444', border: '1px solid #fecaca', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>
                      âœ• Clear all
                    </button>
                  )}
                </>
              )}
              </div>
            </div>}

            {/* Separator */}
            <div className="hidden sm:block" style={{ width: '1px', height: '28px', backgroundColor: dm.border }} />

            {/* GROUP C: Display */}
            <div>
              <p className="hidden sm:block" style={{ fontSize: '8px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1.5px', color: dm.textFaint, marginBottom: '2px' }}>View</p>
              <div className="flex gap-2 flex-wrap items-center">
              <div className="segment-group">
                <button onClick={() => setViewMode(viewMode === 'overview' ? 'list' : 'overview')}
                  title="Month-by-month summary of all planting actions"
                  className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                  style={viewMode === 'overview' ? { backgroundColor: '#1e293b', color: '#fff' } : { backgroundColor: dm.chipBg, color: dm.textMuted }}>
                  Overview
                </button>
                <button onClick={() => setViewMode(viewMode === 'gantt' ? 'list' : 'gantt')}
                  title="See when each species blooms across the year"
                  className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                  style={viewMode === 'gantt' ? { backgroundColor: '#1e293b', color: '#fff' } : { backgroundColor: dm.chipBg, color: dm.textMuted }}>
                  Bloom Chart
                </button>
                <button onClick={() => setViewMode(viewMode === 'planting' ? 'list' : 'planting')}
                  title="See indoor start, transplant, and sow windows"
                  className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                  style={viewMode === 'planting' ? { backgroundColor: '#1e293b', color: '#fff' } : { backgroundColor: dm.chipBg, color: dm.textMuted }}>
                  Planting Chart
                </button>
                <button onClick={() => setViewMode(viewMode === 'weekly' ? 'list' : 'weekly')}
                  title="Tasks organized by calendar week"
                  className="filter-btn px-3.5 py-2 text-sm font-bold whitespace-nowrap"
                  style={viewMode === 'weekly' ? { backgroundColor: '#1e293b', color: '#fff' } : { backgroundColor: dm.chipBg, color: dm.textMuted }}>
                  Weekly
                </button>
              </div>
              <button onClick={() => {
                  navigator.clipboard.writeText(window.location.href).then(() => {
                    setCopiedLink(true);
                    setTimeout(() => setCopiedLink(false), 2000);
                  });
                }}
                title="Copy a shareable link with your current filters"
                className="filter-btn px-2.5 py-1.5 text-sm whitespace-nowrap"
                style={{ backgroundColor: copiedLink ? '#16a34a' : dm.chipBg, color: copiedLink ? '#fff' : '#94a3b8', border: '1px solid #e2e8f0', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>
                {copiedLink ? 'âœ“ Copied!' : 'ðŸ”— Share'}
              </button>
              <button onClick={() => { setCompareMode(!compareMode); setCompareSpecies([]); }}
                title="Select two species to compare side-by-side"
                className="filter-btn px-2.5 py-1.5 text-sm whitespace-nowrap"
                style={{ backgroundColor: compareMode ? '#6366f1' : dm.chipBg, color: compareMode ? '#fff' : dm.textMuted, border: '1px solid ' + dm.border, borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>
                {compareMode ? 'âœ• Cancel' : 'âš–ï¸ Compare'}
              </button>
              </div>
          </div>

        </div>
      </div>
      </div>

      {/* Species list */}
      <main role="main" aria-label="Species list" className="max-w-6xl mx-auto py-5" style={{ paddingLeft: '20px', paddingRight: '20px' }}>
        {viewMode === 'overview' ? (
          <div style={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', padding: '20px', borderRadius: '8px' }}>
            <h3 style={{ fontSize: '12px', fontWeight: 700, letterSpacing: '2px', textTransform: 'uppercase', marginBottom: '16px', color: '#1e293b' }}>Seasonal Overview</h3>
            {(() => {
              const months = {};
              sortedFiltered.forEach(sd => {
                const tl = sd.tl;
                const actions = [
                  tl.indoorStart && { doy: tl.indoorStart, action: 'Start indoors', species: sd.species },
                  tl.transplant && { doy: tl.transplant, action: 'Transplant', species: sd.species },
                  tl.sowStart && { doy: tl.sowStart, action: 'Direct sow', species: sd.species },
                  tl.bloomStart && { doy: tl.bloomStart, action: 'Blooming begins', species: sd.species },
                ].filter(Boolean);
                actions.forEach(a => {
                  const monthKey = Math.floor((a.doy - 1) / 30.44);
                  if (!months[monthKey]) months[monthKey] = { doy: a.doy, actions: {} };
                  if (!months[monthKey].actions[a.action]) months[monthKey].actions[a.action] = [];
                  months[monthKey].actions[a.action].push(a.species);
                });
              });
              const sortedMonths = Object.entries(months).map(([k, v]) => ({ month: parseInt(k), ...v })).sort((a, b) => a.month - b.month);
              if (sortedMonths.length === 0) return <p style={{ color: '#94a3b8', fontSize: '12px' }}>No actions for filtered species.</p>;
              return (
                <div className="space-y-5">
                  {sortedMonths.map((m) => {
                    const monthName = MONTHS[m.month];
                    const isPast = m.month < (new Date().getMonth());
                    const isCurrent = m.month === (new Date().getMonth());
                    return (
                      <div key={m.month} style={{ opacity: isPast ? 0.5 : 1, borderLeft: isCurrent ? '3px solid #6366f1' : '3px solid #e2e8f0', paddingLeft: '12px' }}>
                        <div className="flex items-center gap-2 mb-2">
                          <span style={{ fontSize: '13px', fontWeight: 700, color: isCurrent ? '#6366f1' : '#1e293b' }}>{monthName}</span>
                          {isCurrent && <span style={{ fontSize: '9px', fontWeight: 700, color: '#fff', backgroundColor: '#6366f1', padding: '1px 6px', borderRadius: '3px', textTransform: 'uppercase' }}>Current</span>}
                          {isPast && <span style={{ fontSize: '9px', color: '#94a3b8' }}>past</span>}
                        </div>
                        <div className="space-y-1">
                          {Object.entries(m.actions).map(([action, species]) => (
                            <div key={action} style={{ fontSize: '12px', color: '#475569' }}>
                              <span style={{ fontWeight: 600 }}>{action}: </span>
                              <span style={{ color: '#1e293b' }}>{species.join(', ')}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })()}
          </div>
        ) : viewMode === 'gantt' ? (
          <div style={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', padding: '20px', borderRadius: '8px' }}>
              <h3 style={{ fontSize: '12px', fontWeight: 700, letterSpacing: '2px', textTransform: 'uppercase', marginBottom: '16px', color: '#1e293b' }}>Bloom Calendar</h3>
              {/* Month labels */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                <span style={{ width: '140px', flexShrink: 0 }}></span>
                <div className="relative flex-1" style={{ height: '14px' }}>
                  {MONTHS.map((m, mi) => {
                    const left = (MONTH_START_DOY[mi] / 365) * 100;
                    const width = (MONTH_DAYS[mi] / 365) * 100;
                    return <span key={m} className="absolute text-center" style={{ left: left + '%', width: width + '%', fontSize: '9px', fontWeight: 400, color: '#94a3b8', letterSpacing: '0.05em', textTransform: 'uppercase' }}>{m}</span>;
                  })}
                </div>
              </div>
              {/* Gantt rows */}
              <div className="space-y-1">
                {sortedFiltered.slice().sort((a, b) => (a.tl.bloomStart || 999) - (b.tl.bloomStart || 999)).map((sd, rowIdx) => {
                  const bloomLeft = ((sd.tl.bloomStart - 1) / 365) * 100;
                  const bloomWidth = ((sd.tl.bloomEnd - sd.tl.bloomStart) / 365) * 100;
                  const color = PHASE_COLORS.bloom.bg;
                  return (
                    <div key={sd.species} className="gantt-row" style={{ display: 'flex', alignItems: 'center', gap: '8px', backgroundColor: rowIdx % 2 === 0 ? 'transparent' : '#f8fafc', padding: '1px 4px', borderRadius: '2px' }}>
                      <button onClick={() => { setViewMode('list'); setExpandedSpecies(prev => ({ ...prev, [sd.species]: true })); }}
                        className="truncate text-left"
                        style={{ width: '140px', flexShrink: 0, fontSize: '10px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px', color: '#475569', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}
                        title={'View ' + sd.species}>
                        {sd.species}
                      </button>
                      <div style={{ flex: 1, height: '16px', position: 'relative', backgroundColor: '#f1f5f9', border: '1px solid #e2e8f0' }}>
                        {/* Month gridlines */}
                        {MONTH_START_DOY.slice(1).map((md, i) => (
                          <div key={i} className="absolute top-0 bottom-0" style={{ left: (md / 365 * 100) + '%', width: '1px', backgroundColor: 'rgba(0,0,0,0.06)' }} />
                        ))}
                        <div style={{ position: 'absolute', left: bloomLeft + '%', width: Math.max(bloomWidth, 0.5) + '%', height: '100%', backgroundColor: color, top: 0 }} />
                        {/* Today marker */}
                        <div className="absolute" style={{ left: 'calc(' + todayPct + '% - 1px)', top: '-1px', bottom: '-1px', width: '2px', backgroundColor: '#c00', zIndex: 2 }} />
                      </div>
                    </div>
                  );
                })}
              </div>
              {/* Gap analysis */}
              {(() => {
                const sorted = sortedFiltered.slice().sort((a, b) => (a.tl.bloomStart || 999) - (b.tl.bloomStart || 999));
                const start = Math.min(...sorted.map(s => s.tl.bloomStart).filter(Boolean));
                const end = Math.max(...sorted.map(s => s.tl.bloomEnd).filter(Boolean));
                const gaps = [];
                for (let d = start; d <= end; d++) {
                  const anyBlooming = sorted.some(s => d >= s.tl.bloomStart && d <= s.tl.bloomEnd);
                  if (!anyBlooming) {
                    if (gaps.length === 0 || gaps[gaps.length-1].end !== d - 1) {
                      gaps.push({ start: d, end: d });
                    } else {
                      gaps[gaps.length-1].end = d;
                    }
                  }
                }
                if (gaps.length === 0) return (
                  <div style={{ marginTop: '12px', padding: '8px 12px', backgroundColor: '#f1f5f9', border: '1px solid #e2e8f0', fontSize: '11px', color: '#64748b' }}>
                    Continuous bloom coverage from {formatDoy(start)} to {formatDoy(end)}.
                  </div>
                );
                return (
                  <div style={{ marginTop: '12px', padding: '8px 12px', backgroundColor: '#f1f5f9', border: '1px solid #fca5a5', fontSize: '11px', color: '#64748b' }}>
                    <p style={{ fontWeight: 700, color: '#c00', textTransform: 'uppercase', letterSpacing: '1px', fontSize: '10px', marginBottom: '4px' }}>Bloom Gaps</p>
                    {gaps.map((gap, i) => (
                      <p key={i}>{formatDoy(gap.start)} to {formatDoy(gap.end)} ({gap.end - gap.start + 1} days)</p>
                    ))}
                  </div>
                );
              })()}
          </div>
        ) : viewMode === 'planting' ? (
          <div style={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', padding: '20px', borderRadius: '8px' }}>
            <h3 style={{ fontSize: '12px', fontWeight: 700, letterSpacing: '2px', textTransform: 'uppercase', marginBottom: '16px', color: '#1e293b' }}>Planting Calendar</h3>
            {/* Month labels */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
              <span style={{ width: '140px', flexShrink: 0 }}></span>
              <div className="relative flex-1" style={{ height: '14px' }}>
                {MONTHS.map((m, mi) => {
                  const left = (MONTH_START_DOY[mi] / 365) * 100;
                  const width = (MONTH_DAYS[mi] / 365) * 100;
                  return <span key={m} className="absolute text-center" style={{ left: left + '%', width: width + '%', fontSize: '9px', fontWeight: 400, color: '#94a3b8', letterSpacing: '0.05em', textTransform: 'uppercase' }}>{m}</span>;
                })}
              </div>
            </div>
            {/* Gantt rows */}
            <div className="space-y-1">
              {sortedFiltered.slice().sort((a, b) => {
                const aStart = a.tl.indoorStart || a.tl.sowStart || 999;
                const bStart = b.tl.indoorStart || b.tl.sowStart || 999;
                return aStart - bStart;
              }).map((sd, rowIdx) => {
                const tl = sd.tl;
                const phases = [];
                if (tl.indoorStart && tl.indoorEnd) phases.push({ start: tl.indoorStart, end: tl.indoorEnd, color: PHASE_COLORS.indoor.bg, label: 'Indoor' });
                if (tl.transplant) phases.push({ start: tl.transplant - 3, end: tl.transplant + 3, color: PHASE_COLORS.transplant.bg, label: 'Transplant' });
                if (tl.sowStart && tl.sowEnd) phases.push({ start: tl.sowStart, end: tl.sowEnd, color: PHASE_COLORS.sow.bg, label: 'Direct Sow' });
                if (tl.germStart && tl.germEnd) phases.push({ start: tl.germStart, end: tl.germEnd, color: PHASE_COLORS.germination.bg, label: 'Germination' });
                if (tl.bloomStart && tl.bloomEnd) phases.push({ start: tl.bloomStart, end: tl.bloomEnd, color: PHASE_COLORS.bloom.bg + '40', label: 'Bloom' });
                return (
                  <div key={sd.species} className="gantt-row" style={{ display: 'flex', alignItems: 'center', gap: '8px', backgroundColor: rowIdx % 2 === 0 ? 'transparent' : '#f8fafc', padding: '1px 4px', borderRadius: '2px' }}>
                    <button onClick={() => { setViewMode('list'); setExpandedSpecies(prev => ({ ...prev, [sd.species]: true })); }}
                      className="truncate text-left"
                      style={{ width: '140px', flexShrink: 0, fontSize: '10px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px', color: '#475569', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}
                      title={'View ' + sd.species}>
                      {sd.species}
                    </button>
                    <div style={{ flex: 1, height: '16px', position: 'relative', backgroundColor: '#f1f5f9', border: '1px solid #e2e8f0' }}>
                      {MONTH_START_DOY.slice(1).map((md, i) => (
                        <div key={i} className="absolute top-0 bottom-0" style={{ left: (md / 365 * 100) + '%', width: '1px', backgroundColor: 'rgba(0,0,0,0.06)' }} />
                      ))}
                      {phases.map((p, pi) => (
                        <div key={pi} title={p.label + ': ' + formatDoy(p.start) + ' â€“ ' + formatDoy(p.end)}
                          style={{ position: 'absolute', left: ((p.start - 1) / 365 * 100) + '%', width: Math.max(((p.end - p.start) / 365 * 100), 0.5) + '%', height: '100%', backgroundColor: p.color, top: 0 }} />
                      ))}
                      <div className="absolute" style={{ left: 'calc(' + todayPct + '% - 1px)', top: '-1px', bottom: '-1px', width: '2px', backgroundColor: '#c00', zIndex: 2 }} />
                    </div>
                  </div>
                );
              })}
            </div>
            {/* Legend */}
            <div className="flex gap-4 mt-4" style={{ fontSize: '10px', color: '#64748b' }}>
              <span className="flex items-center gap-1"><span style={{ display: 'inline-block', width: '10px', height: '10px', backgroundColor: PHASE_COLORS.indoor.bg }} /> Indoor Start</span>
              <span className="flex items-center gap-1"><span style={{ display: 'inline-block', width: '10px', height: '10px', backgroundColor: PHASE_COLORS.transplant.bg }} /> Transplant</span>
              <span className="flex items-center gap-1"><span style={{ display: 'inline-block', width: '10px', height: '10px', backgroundColor: PHASE_COLORS.sow.bg }} /> Direct Sow</span>
              <span className="flex items-center gap-1"><span style={{ display: 'inline-block', width: '10px', height: '10px', backgroundColor: PHASE_COLORS.germination.bg }} /> Germination</span>
              <span className="flex items-center gap-1"><span style={{ display: 'inline-block', width: '10px', height: '10px', backgroundColor: PHASE_COLORS.bloom.bg + '40' }} /> Bloom (faded)</span>
              <span className="flex items-center gap-1"><span style={{ display: 'inline-block', width: '2px', height: '10px', backgroundColor: '#c00' }} /> Today</span>
            </div>
          </div>
        ) : viewMode === 'weekly' ? (
          <div style={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', padding: '20px', borderRadius: '8px' }}>
            <h3 style={{ fontSize: '12px', fontWeight: 700, letterSpacing: '2px', textTransform: 'uppercase', marginBottom: '16px', color: '#1e293b' }}>Weekly Planting Schedule</h3>
            {(() => {
              const weeks = {};
              sortedFiltered.forEach(sd => {
                const tl = sd.tl;
                const actions = [
                  tl.indoorStart && { doy: tl.indoorStart, action: 'Start indoors', phase: 'indoor' },
                  tl.transplant && { doy: tl.transplant, action: 'Transplant outdoors', phase: 'transplant' },
                  tl.sowStart && { doy: tl.sowStart, action: 'Direct sow', phase: 'sow' },
                ].filter(Boolean);
                actions.forEach(a => {
                  const weekKey = Math.floor(a.doy / 7);
                  if (!weeks[weekKey]) weeks[weekKey] = { doy: a.doy - ((a.doy + 5) % 7), items: [] };
                  weeks[weekKey].items.push({ species: sd.species, action: a.action, phase: a.phase, doy: a.doy, varieties: sd.varieties.length });
                });
              });
              const sortedWeeks = Object.values(weeks).sort((a, b) => a.doy - b.doy);
              if (sortedWeeks.length === 0) return <p style={{ color: '#94a3b8', fontSize: '12px' }}>No planting actions for filtered species.</p>;
              return (
                <div className="space-y-4">
                  {sortedWeeks.map((week, wi) => {
                    const weekLabel = formatDoy(week.doy);
                    const isPast = week.doy + 7 < todayDoy;
                    const isCurrent = todayDoy >= week.doy && todayDoy < week.doy + 7;
                    return (
                      <div key={wi} style={{ opacity: isPast ? 0.5 : 1, borderLeft: isCurrent ? '3px solid #6366f1' : '3px solid #e2e8f0', paddingLeft: '12px' }}>
                        <div className="flex items-center gap-2 mb-1.5">
                          <span style={{ fontSize: '12px', fontWeight: 700, color: isCurrent ? '#6366f1' : '#1e293b' }}>Week of {weekLabel}</span>
                          {isCurrent && <span style={{ fontSize: '9px', fontWeight: 700, color: '#fff', backgroundColor: '#6366f1', padding: '1px 6px', borderRadius: '3px', textTransform: 'uppercase' }}>This week</span>}
                          {isPast && <span style={{ fontSize: '9px', color: '#94a3b8' }}>past</span>}
                        </div>
                        <div className="space-y-1">
                          {week.items.sort((a, b) => a.doy - b.doy).map((item, ii) => (
                            <div key={ii} className="flex items-center gap-2" style={{ fontSize: '12px' }}>
                              <span style={{ width: '8px', height: '8px', borderRadius: '2px', backgroundColor: PHASE_COLORS[item.phase].bg, flexShrink: 0 }} />
                              <span style={{ color: '#475569' }}>{item.action}</span>
                              <span style={{ fontWeight: 700, color: '#1e293b' }}>{item.species}</span>
                              <span style={{ color: '#94a3b8', fontSize: '11px' }}>({item.varieties} var)</span>
                              <span style={{ color: '#94a3b8', fontSize: '10px' }}>{formatDoy(item.doy)}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })()}
          </div>
        ) : (
          <div className="space-y-2">
            {/* Expand/Collapse all and info line */}
            <div className="flex justify-between items-center mb-3">
              <span style={{ fontSize: '12px', color: '#94a3b8' }}>
                {sortedFiltered.length} species Â· {totalVarieties} varieties
                {activeFilterCount > 0 && (
                  <span style={{ color: '#6366f1', fontWeight: 600 }}> Â· {activeFilterCount} filter{activeFilterCount > 1 ? 's' : ''} active</span>
                )}
              </span>
              <button onClick={toggleAllSpecies} style={{ fontSize: '11px', color: '#64748b', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline' }}>
                {allExpanded ? 'Collapse all' : 'Expand all'}
              </button>
            </div>

            {/* My Garden summary banner */}
            {filterMyGarden && Object.keys(myGarden).length > 0 && (
              <div style={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px', padding: '16px 20px', marginBottom: '12px' }}>
                <div className="flex flex-wrap gap-x-6 gap-y-1" style={{ fontSize: '12px', color: '#475569' }}>
                  <span><strong style={{ color: '#1e293b' }}>{Object.keys(myGarden).length}</strong> varieties across <strong style={{ color: '#1e293b' }}>{sortedFiltered.length}</strong> species</span>
                  {sortedFiltered.length > 0 && (() => {
                    const starts = sortedFiltered.map(s => s.tl.indoorStart || s.tl.sowStart).filter(Boolean);
                    const blooms = sortedFiltered.map(s => s.tl.bloomEnd).filter(Boolean);
                    if (starts.length === 0) return null;

                    // Bloom gap analysis
                    const sorted = sortedFiltered.slice().sort((a, b) => (a.tl.bloomStart || 999) - (b.tl.bloomStart || 999));
                    const bloomStart = Math.min(...sorted.map(s => s.tl.bloomStart).filter(Boolean));
                    const bloomEnd = Math.max(...sorted.map(s => s.tl.bloomEnd).filter(Boolean));
                    const gaps = [];
                    for (let d = bloomStart; d <= bloomEnd; d++) {
                      const anyBlooming = sorted.some(s => d >= s.tl.bloomStart && d <= s.tl.bloomEnd);
                      if (!anyBlooming) {
                        if (gaps.length === 0 || gaps[gaps.length-1].end !== d - 1) {
                          gaps.push({ start: d, end: d });
                        } else {
                          gaps[gaps.length-1].end = d;
                        }
                      }
                    }
                    const gapText = gaps.length === 0 ? 'Continuous bloom coverage âœ“' : `Bloom gaps: ${gaps.map(g => `${formatDoy(g.start)} â€“ ${formatDoy(g.end)} (${g.end - g.start + 1} days)`).join(', ')}`;

                    return (
                      <>
                        <span>First planting: <strong style={{ color: '#1e293b' }}>{formatDoy(Math.min(...starts))}</strong></span>
                        <span>Bloom season: <strong style={{ color: '#1e293b' }}>{formatDoy(Math.min(...sortedFiltered.map(s => s.tl.bloomStart)))} â€“ {formatDoy(Math.max(...blooms))}</strong></span>
                        <span style={{ color: gaps.length === 0 ? '#16a34a' : '#f59e0b' }}>
                          <strong style={{ color: gaps.length === 0 ? '#16a34a' : '#d97706' }}>{gapText}</strong>
                        </span>
                      </>
                    );
                  })()}
                </div>

                {/* Height layering guide */}
                {(() => {
                  const tiers = { ground: [], short: [], medium: [], tall: [], vine: [] };
                  sortedFiltered.forEach(sd => {
                    if (sd.height && tiers[sd.height]) tiers[sd.height].push(sd.species);
                  });
                  const activeTiers = Object.entries(tiers).filter(([, species]) => species.length > 0);
                  if (activeTiers.length <= 1) return null;
                  const TIER_LABELS = { ground: 'Front Â· 0â€“6"', short: 'Low Â· 6â€“18"', medium: 'Mid Â· 18â€“36"', tall: 'Back Â· 36â€“60"', vine: 'Trellis' };
                  const TIER_COLORS = { ground: '#a3e635', short: '#84cc16', medium: '#16a34a', tall: '#15803d', vine: '#6366f1' };
                  return (
                    <div style={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px', padding: '12px 20px', marginBottom: '12px' }}>
                      <p style={{ fontSize: '10px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', color: '#94a3b8', marginBottom: '8px' }}>Height Layering Guide</p>
                      <div className="space-y-1">
                        {['vine', 'tall', 'medium', 'short', 'ground'].filter(t => tiers[t].length > 0).map(tier => (
                          <div key={tier} className="flex items-center gap-3" style={{ fontSize: '12px' }}>
                            <span style={{ width: '10px', height: '10px', borderRadius: '2px', backgroundColor: TIER_COLORS[tier], flexShrink: 0 }} />
                            <span style={{ color: '#94a3b8', fontSize: '10px', fontWeight: 700, minWidth: '90px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{TIER_LABELS[tier]}</span>
                            <span style={{ color: '#475569', fontWeight: 600 }}>{tiers[tier].join(', ')}</span>
                          </div>
                        ))}
                      </div>
                      <p style={{ fontSize: '10px', color: '#94a3b8', marginTop: '6px', fontStyle: 'italic' }}>Arrange tallest at back, shortest in front for visibility.</p>
                    </div>
                  );
                })()}

                {/* Bloom color palette */}
                {(() => {
                  const gardenSpecies = sortedFiltered.slice().sort((a, b) => (a.tl.bloomStart || 999) - (b.tl.bloomStart || 999));
                  if (gardenSpecies.length < 2) return null;
                  const totalDays = gardenSpecies.reduce((sum, s) => sum + (s.tl.bloomEnd - s.tl.bloomStart), 0);
                  return (
                    <div style={{ backgroundColor: dm.cardBg, border: '1px solid ' + dm.border, borderRadius: '8px', padding: '12px 20px', marginBottom: '12px' }}>
                      <p style={{ fontSize: '10px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', color: dm.textFaint, marginBottom: '8px' }}>Bloom Color Palette</p>
                      <div className="flex" style={{ height: '24px', borderRadius: '4px', overflow: 'hidden', border: '1px solid ' + dm.border }}>
                        {gardenSpecies.map((sd, i) => {
                          const duration = sd.tl.bloomEnd - sd.tl.bloomStart;
                          const pct = (duration / totalDays) * 100;
                          return (
                            <div key={i} title={`${sd.species}: ${formatDoy(sd.tl.bloomStart)} â€“ ${formatDoy(sd.tl.bloomEnd)}`}
                              style={{ width: pct + '%', backgroundColor: sd.bloomColor || '#ec4899', minWidth: '2px' }} />
                          );
                        })}
                      </div>
                      <div className="flex flex-wrap gap-x-3 gap-y-0.5 mt-2" style={{ fontSize: '10px', color: dm.textMuted }}>
                        {gardenSpecies.map((sd, i) => (
                          <span key={i} className="flex items-center gap-1">
                            <span style={{ width: '8px', height: '8px', borderRadius: '2px', backgroundColor: sd.bloomColor || '#ec4899', display: 'inline-block' }} />
                            {sd.species}
                          </span>
                        ))}
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}

            {/* This Week action card */}
            {(() => {
              const actions = [];
              const window = 7; // this week only
              speciesData.forEach(sd => {
                const tl = sd.tl;
                if (tl.indoorStart && todayDoy >= tl.indoorStart && todayDoy <= tl.indoorStart + window) {
                  actions.push({ phase: 'indoor', action: 'Start indoors', species: sd.species, date: formatDoy(tl.indoorStart), varieties: sd.varieties.length });
                }
                if (tl.transplant && todayDoy >= tl.transplant - 3 && todayDoy <= tl.transplant + 3) {
                  actions.push({ phase: 'transplant', action: 'Transplant outdoors', species: sd.species, date: formatDoy(tl.transplant), varieties: sd.varieties.length });
                }
                if (tl.sowStart && todayDoy >= tl.sowStart && todayDoy <= tl.sowStart + window) {
                  actions.push({ phase: 'sow', action: 'Direct sow', species: sd.species, date: formatDoy(tl.sowStart), varieties: sd.varieties.length });
                }
              });
              if (actions.length === 0) return null;
              return (
                <div style={{ backgroundColor: '#fff', border: '2px solid #6366f1', borderRadius: '8px', padding: '16px 20px', marginBottom: '12px' }}>
                  <div className="flex items-center gap-2 mb-3">
                    <span style={{ fontSize: '12px', fontWeight: 700, color: '#fff', backgroundColor: '#6366f1', padding: '2px 8px', borderRadius: '4px', textTransform: 'uppercase', letterSpacing: '1px' }}>This Week</span>
                    <span style={{ fontSize: '11px', color: '#94a3b8' }}>{formatDoy(todayDoy)} â€“ {formatDoy(todayDoy + 7)}</span>
                  </div>
                  <div className="space-y-2">
                    {actions.map((a, i) => (
                      <div key={i} className="flex items-center gap-3" style={{ fontSize: '13px' }}>
                        <span style={{ width: '10px', height: '10px', borderRadius: '2px', backgroundColor: PHASE_COLORS[a.phase].bg, flexShrink: 0 }} />
                        <span style={{ fontWeight: 700, color: PHASE_COLORS[a.phase].bg, minWidth: '120px' }}>{a.action}</span>
                        <button onClick={() => { setSearchTerm(a.species); window.scrollTo(0, 0); }}
                          style={{ fontWeight: 700, color: '#1e293b', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline', textDecorationStyle: 'dotted', padding: 0 }}>
                          {a.species}
                        </button>
                        <span style={{ color: '#94a3b8', fontSize: '11px' }}>({a.varieties} var) Â· {a.date}</span>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })()}

            {compareMode && compareSpecies.length === 2 && (() => {
              const [a, b] = compareSpecies.map(name => speciesData.find(s => s.species === name)).filter(Boolean);
              if (!a || !b) return null;
              const rows = [
                { label: 'Type', a: a.type, b: b.type },
                { label: 'Height', a: HEIGHT_LABELS[a.height] || '?', b: HEIGHT_LABELS[b.height] || '?' },
                { label: 'Frost Hardy', a: a.frostHardy ? 'Yes' : 'No', b: b.frostHardy ? 'Yes' : 'No' },
                { label: 'Sow Method', a: a.sowMethod.join(', '), b: b.sowMethod.join(', ') },
                { label: 'Bloom Start', a: formatDoy(a.tl.bloomStart), b: formatDoy(b.tl.bloomStart) },
                { label: 'Bloom End', a: formatDoy(a.tl.bloomEnd), b: formatDoy(b.tl.bloomEnd) },
                { label: 'Bloom Duration', a: (a.bloomDuration || 60) + 'd', b: (b.bloomDuration || 60) + 'd' },
                { label: 'Varieties', a: String(a.varieties.length), b: String(b.varieties.length) },
                { label: 'Deer Resistant', a: a.deerResistant ? 'ðŸ›¡ï¸ Yes' : 'No', b: b.deerResistant ? 'ðŸ›¡ï¸ Yes' : 'No' },
                { label: 'Companions', a: a.companions.join(', ') || 'None', b: b.companions.join(', ') || 'None' },
              ];
              const isCompanion = a.companions.includes(b.species) || b.companions.includes(a.species);
              const bloomOverlap = Math.max(0, Math.min(a.tl.bloomEnd, b.tl.bloomEnd) - Math.max(a.tl.bloomStart, b.tl.bloomStart));
              const HEIGHT_LABELS = {
                ground: '0â€“6" groundcover',
                short: '6â€“18"',
                medium: '18â€“36"',
                tall: '36â€“60"',
                vine: 'Climbing/Trailing'
              };
              return (
                <div style={{ backgroundColor: dm.cardBg, border: '2px solid #6366f1', borderRadius: '8px', padding: '16px 20px', marginBottom: '12px' }}>
                  <div className="flex items-center justify-between mb-3">
                    <span style={{ fontSize: '12px', fontWeight: 700, color: '#6366f1', textTransform: 'uppercase', letterSpacing: '1px' }}>Comparison</span>
                    <button onClick={() => setCompareSpecies([])} style={{ fontSize: '11px', color: dm.textMuted, background: 'none', border: 'none', cursor: 'pointer' }}>Clear</button>
                  </div>
                  <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                    <thead>
                      <tr>
                        <th style={{ textAlign: 'left', padding: '4px 8px', color: dm.textMuted, fontWeight: 400, fontSize: '10px', textTransform: 'uppercase', borderBottom: '1px solid ' + dm.border }}></th>
                        <th style={{ textAlign: 'left', padding: '4px 8px', fontWeight: 700, color: dm.text, textTransform: 'uppercase', letterSpacing: '1px', fontSize: '11px', borderBottom: '1px solid ' + dm.border }}>{a.species}</th>
                        <th style={{ textAlign: 'left', padding: '4px 8px', fontWeight: 700, color: dm.text, textTransform: 'uppercase', letterSpacing: '1px', fontSize: '11px', borderBottom: '1px solid ' + dm.border }}>{b.species}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {rows.map((r, i) => (
                        <tr key={i} style={{ backgroundColor: i % 2 === 0 ? 'transparent' : dm.altRow }}>
                          <td style={{ padding: '4px 8px', color: dm.textMuted, fontWeight: 400, fontSize: '10px', textTransform: 'uppercase' }}>{r.label}</td>
                          <td style={{ padding: '4px 8px', color: darkMode ? '#cbd5e1' : '#475569', fontWeight: 600 }}>{r.a}</td>
                          <td style={{ padding: '4px 8px', color: darkMode ? '#cbd5e1' : '#475569', fontWeight: 600 }}>{r.b}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {bloomOverlap > 0 && <p style={{ fontSize: '11px', color: '#16a34a', marginTop: '8px' }}>Bloom overlap: {bloomOverlap} days</p>}
                  {isCompanion && <p style={{ fontSize: '11px', color: '#6366f1', marginTop: '4px' }}>These species are companions âœ“</p>}
                </div>
              );
            })()}

            {/* Progressive filter hint */}
            {!filterHintDismissed && sortedFiltered.length > 20 && !hasActiveFilters && !searchTerm && (() => {
              const hasPlantable = speciesData.some(sd => {
                const tl = sd.tl;
                return (tl.indoorStart && todayDoy >= tl.indoorStart - 7 && todayDoy <= tl.indoorStart + 14) ||
                       (tl.sowStart && todayDoy >= tl.sowStart - 7 && todayDoy <= tl.sowStart + 14);
              });
              const hasBlooming = speciesData.some(sd => todayDoy >= sd.tl.bloomStart && todayDoy <= sd.tl.bloomEnd);
              const tip = hasPlantable
                ? { text: 'Try "Plant Now" to see species you can start this week.', action: () => setFilterPlantNow(true) }
                : hasBlooming
                ? { text: 'Try "Blooming" to see what\'s flowering right now.', action: () => setFilterBloomNow(true) }
                : { text: 'Try sorting by "Next action" to see your most urgent tasks.', action: () => setSortBy('nextAction') };
              return (
                <div style={{ borderLeft: '3px solid #6366f1', backgroundColor: darkMode ? '#1e1b4b' : '#eef2ff', padding: '8px 14px', borderRadius: '0 6px 6px 0', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '10px', fontSize: '12px' }}>
                  <span style={{ color: '#6366f1', fontWeight: 700, fontSize: '11px' }}>TIP</span>
                  <button onClick={tip.action} style={{ background: 'none', border: 'none', cursor: 'pointer', color: darkMode ? '#a5b4fc' : '#4338ca', fontWeight: 500, padding: 0, textAlign: 'left', flex: 1 }}>{tip.text}</button>
                  <button onClick={() => { setFilterHintDismissed(true); localStorage.setItem('filterHintDismissed', '1'); }}
                    style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#94a3b8', fontSize: '14px', padding: '2px 6px' }}>&times;</button>
                </div>
              );
            })()}

            {sortedFiltered.map((sd, cardIdx) => (
            <LazyCard key={sd.species}>
            <div role="article" aria-label={sd.species + ' planting card'} data-species={sd.species}
              draggable={filterMyGarden}
              onDragStart={filterMyGarden ? (e) => { setDraggedSpecies(sd.species); e.dataTransfer.effectAllowed = 'move'; } : undefined}
              onDragOver={filterMyGarden ? (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; } : undefined}
              onDrop={filterMyGarden ? (e) => {
                e.preventDefault();
                if (!draggedSpecies || draggedSpecies === sd.species) return;
                const currentOrder = gardenOrder.length > 0 ? [...gardenOrder] : sortedFiltered.map(s => s.species);
                const fromIdx = currentOrder.indexOf(draggedSpecies);
                const toIdx = currentOrder.indexOf(sd.species);
                if (fromIdx === -1 || toIdx === -1) return;
                currentOrder.splice(fromIdx, 1);
                currentOrder.splice(toIdx, 0, draggedSpecies);
                setGardenOrder(currentOrder);
                setDraggedSpecies(null);
              } : undefined}
              onDragEnd={() => setDraggedSpecies(null)}
              className={'species-card overflow-hidden ' + (expandedSpecies[sd.species] ? 'species-card-expanded' : 'species-card-collapsed')}
              style={{ border: '1px solid ' + dm.border, borderLeft: '4px solid ' + (sd.bloomColor || '#94a3b8'), backgroundColor: dm.cardBg, borderRadius: '8px', opacity: draggedSpecies === sd.species ? 0.5 : 1, cursor: filterMyGarden ? 'grab' : 'default', outline: focusedCardIndex === cardIdx ? '2px solid #6366f1' : 'none', outlineOffset: '2px' }}>
              <div className="flex gap-4 px-5 py-4 flex-col sm:flex-row">
                {/* Species thumbnail */}
                {(() => {
                  const withImg = sd.varieties.filter(v => v.img);
                  const pick = withImg.length > 1 ? withImg[1] : withImg[0];
                  return pick ? (
                    <div className="img-skeleton shrink-0 hidden sm:block" style={{ width: '80px', height: '80px' }}>
                      <img src={pick.img} alt={sd.species}
                        style={{ width: '80px', height: '80px', objectFit: 'cover', border: '1px solid #e2e8f0', position: 'relative', zIndex: 1 }}
                        loading="lazy"
                        onLoad={(e) => { e.target.parentElement.classList.remove('img-skeleton'); }}
                        onError={(e) => { e.target.style.display='none'; e.target.parentElement.classList.remove('img-skeleton'); }} />
                    </div>
                  ) : (
                    <div className="shrink-0 hidden sm:flex items-center justify-center" style={{ width: '80px', height: '80px', backgroundColor: '#f1f5f9', border: '1px solid #e2e8f0' }}>
                      <span style={{ fontSize: '24px', color: '#cbd5e1' }}>&#10047;</span>
                    </div>
                  );
                })()}
                {/* Info column */}
                <div className="flex-1 min-w-0 flex flex-col">
                  {/* Name row - THIS is the clickable part */}
                  <button onClick={() => toggleSpecies(sd.species)} className="species-name-btn flex items-center gap-2 mb-1.5 text-left w-full" style={{ background: 'none', border: 'none', padding: 0, cursor: 'pointer' }}>
                    {compareMode && (
                      <input type="checkbox"
                        checked={compareSpecies.includes(sd.species)}
                        onChange={() => {
                          setCompareSpecies(prev => {
                            if (prev.includes(sd.species)) return prev.filter(s => s !== sd.species);
                            if (prev.length >= 2) return [prev[1], sd.species];
                            return [...prev, sd.species];
                          });
                        }}
                        style={{ marginRight: '6px', accentColor: '#6366f1' }}
                      />
                    )}
                    {filterMyGarden && <span style={{ color: '#94a3b8', fontSize: '14px', cursor: 'grab', userSelect: 'none' }} title="Drag to reorder">â ¿</span>}
                    <span className="shrink-0 flex items-center justify-center" style={{ width: '22px', height: '22px', borderRadius: '4px', backgroundColor: expandedSpecies[sd.species] ? '#6366f1' : '#f1f5f9', transition: 'all 0.15s ease' }}>
                      {expandedSpecies[sd.species]
                        ? <ChevronUp size={13} style={{ color: '#fff' }} />
                        : <ChevronDown size={13} style={{ color: '#94a3b8' }} />}
                    </span>
                    <span className="font-bold truncate" style={{ fontSize: '17px', letterSpacing: '2px', textTransform: 'uppercase', color: dm.text }}>{sd.species}</span>
                    <span className="text-xs tabular-nums" style={{ color: '#94a3b8' }}>
                      {(() => {
                        const selCount = sd.varieties.filter(v => myGarden[sd.species + '||' + v.name]).length;
                        return <span>{selCount > 0 ? `${selCount}/` : ''}{searchTerm ? (() => {
  const matchCount = sd.varieties.filter(v => v.name.toLowerCase().includes(searchTerm.toLowerCase())).length;
  return matchCount < sd.varieties.length ? <span><span style={{color: '#16a34a', fontWeight: 700}}>{matchCount}</span> of {sd.varieties.length} var</span> : <span>{sd.varieties.length} var</span>;
})() : <span>{sd.varieties.length} var</span>}</span>;
                      })()}
                    </span>
                    <PhaseBadge tl={sd.tl} bloomColor={sd.bloomColor} />
                    {(() => {
                      const cd = getCountdown(sd.tl, todayDoy);
                      if (!cd) return null;
                      return <span style={{ fontSize: '10px', color: '#f59e0b', fontWeight: 600 }}>{cd.label} in {cd.days}d</span>;
                    })()}
                  </button>
                  {/* Timeline bar - not inside button */}
                  <div className="mb-2">
                    <YearBar tl={sd.tl} height={20} bloomColor={sd.bloomColor} />
                  </div>
                  {/* Compact summary line - visible when collapsed */}
                  {!expandedSpecies[sd.species] && (
                    <div className="flex items-center gap-3 flex-wrap" style={{ fontSize: '10px', color: '#94a3b8', paddingBottom: '2px' }}>
                      <span className="capitalize" style={{ color: '#64748b', fontWeight: 600 }}>{sd.type}</span>
                      {sd.frostHardy && <span style={{ color: '#64748b' }}>Frost hardy</span>}
                      <span>{sd.sowMethod.map(m => m === 'startIndoors' ? 'Indoor' : 'Direct sow').join(' + ')}</span>
                      <span>Bloom {formatDoy(sd.tl.bloomStart)}</span>
                      {sd.deerResistant && <span>ðŸ›¡ï¸</span>}
                    </div>
                  )}
                  {/* Detail rows - visible when expanded */}
                  {expandedSpecies[sd.species] && <div className="card-expand-enter" style={{ fontSize: '11px', lineHeight: '20px', color: '#64748b' }}>
                      <div className="flex gap-2">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Type</span>
                        <span className="capitalize font-bold" style={{ color: '#475569' }}>{sd.type}</span>
                        {sd.frostHardy && <span className="px-1.5 py-0 font-bold" style={{ backgroundColor: '#f1f5f9', color: '#64748b', fontSize: '10px', lineHeight: '18px', border: '1px solid #e2e8f0' }}>Frost hardy</span>}
                      </div>
                      <div className="flex gap-2 items-center">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Sow</span>
                        <span className="flex items-center gap-1.5">
                          {sd.sowMethod.map((m, mi) => (
                            <span key={mi} className="font-bold" style={{
                              color: '#fff',
                              backgroundColor: m === 'startIndoors' ? PHASE_COLORS.indoor.bg : PHASE_COLORS.sow.bg,
                              fontSize: '9px',
                              padding: '2px 6px',
                              borderRadius: '3px',
                              letterSpacing: '0.3px',
                              textTransform: 'uppercase'
                            }}>
                              {m === 'startIndoors' ? 'Indoor' : 'Direct'}
                            </span>
                          ))}
                          {sd.sowMethod.length > 1 && (
                            <span style={{ fontSize: '9px', color: '#f59e0b', fontWeight: 700 }}>BOTH</span>
                          )}
                        </span>
                      </div>
                      <div className="flex gap-2">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Germination</span>
                        <span className="font-bold tabular-nums" style={{ color: '#475569' }}>{sd.germination ? `${sd.germination[0]}â€“${sd.germination[1]} days` : '?'}</span>
                      </div>
                      <div className="flex gap-2">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Bloom</span>
                        <span className="font-bold tabular-nums" style={{ color: '#475569' }}>{sd.bloomDays ? `${sd.bloomDays[0]}â€“${sd.bloomDays[1]} days` : '?'}</span>
                      </div>
                      <div className="flex gap-2">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Sun</span>
                        <span className="font-bold tabular-nums" style={{ color: '#475569' }}>{sd.sun ? `${sd.sun[0]}â€“${sd.sun[1]} hr` : '?'}</span>
                      </div>
                      <div className="flex gap-2">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Height</span>
                        <span className="font-bold" style={{ color: '#475569' }}>{HEIGHT_LABELS[sd.height] || '?'}</span>
                      </div>
                      {sd.height && SPACING_DATA[sd.height] && (
                        <div className="flex gap-2 items-center">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Spacing</span>
                          <span className="flex items-center gap-2">
                            <svg width="80" height="20" viewBox="0 0 80 20">
                              {/* Ground line */}
                              <line x1="0" y1="18" x2="80" y2="18" stroke="#e2e8f0" strokeWidth="1" />
                              {/* Plants */}
                              {(() => {
                                const sp = SPACING_DATA[sd.height];
                                const count = Math.min(Math.floor(72 / (sp.spacing * 72 / 36)) + 1, 5);
                                const gap = 72 / Math.max(count - 1, 1);
                                return Array.from({ length: count }, (_, i) => {
                                  const cx = 4 + i * gap;
                                  return (
                                    <g key={i}>
                                      <line x1={cx} y1="18" x2={cx} y2="8" stroke="#16a34a" strokeWidth="1.5" />
                                      <circle cx={cx} cy="6" r="3" fill="#16a34a" opacity="0.6" />
                                    </g>
                                  );
                                });
                              })()}
                              {/* Spacing arrow */}
                              {(() => {
                                const sp = SPACING_DATA[sd.height];
                                const count = Math.min(Math.floor(72 / (sp.spacing * 72 / 36)) + 1, 5);
                                if (count < 2) return null;
                                const gap = 72 / Math.max(count - 1, 1);
                                return (
                                  <>
                                    <line x1="4" y1="2" x2={4 + gap} y2="2" stroke="#94a3b8" strokeWidth="0.5" />
                                    <line x1="4" y1="0" x2="4" y2="4" stroke="#94a3b8" strokeWidth="0.5" />
                                    <line x1={4 + gap} y1="0" x2={4 + gap} y2="4" stroke="#94a3b8" strokeWidth="0.5" />
                                  </>
                                );
                              })()}
                            </svg>
                            <span className="font-bold" style={{ color: '#475569', fontSize: '11px' }}>{SPACING_DATA[sd.height].label}</span>
                          </span>
                        </div>
                      )}
                      {sd.type === 'perennial' && sd.firstYearBloom === false && (
                        <div className="flex gap-2 items-center">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Note</span>
                          <span style={{ color: '#f59e0b', fontSize: '10px', fontWeight: 600 }}>May not bloom first year from seed</span>
                        </div>
                      )}
                      {sd.type === 'annual' && sd.sowMethod.includes('directSow') && sd.bloomDuration && sd.bloomDuration <= 45 && (
                        <div className="flex gap-2 items-start">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Succession</span>
                          <div style={{ fontSize: '10px', color: '#16a34a', fontWeight: 600 }}>
                            <span>Sow every 2â€“3 weeks for continuous bloom:</span>
                            <div className="flex flex-wrap gap-1 mt-1">
                              {(() => {
                                const dates = [];
                                const interval = 14;
                                const start = sd.tl.sowStart;
                                const end = sd.tl.sowEnd || (sd.tl.sowStart + 42);
                                for (let d = start; d <= end; d += interval) {
                                  dates.push(d);
                                }
                                return dates.map((d, i) => (
                                  <span key={i} style={{ backgroundColor: '#f0fdf4', border: '1px solid #bbf7d0', padding: '1px 6px', borderRadius: '3px', fontSize: '10px' }}>
                                    {formatDoy(d)}
                                  </span>
                                ));
                              })()}
                            </div>
                          </div>
                        </div>
                      )}
                      <div className="flex gap-2">
                        <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Key dates</span>
                        <span className="font-bold" style={{ color: '#475569' }}>
                          {sd.tl.indoorStart ? `Indoor ${formatDoy(sd.tl.indoorStart)}` : ''}
                          {sd.tl.indoorStart && sd.tl.sowStart ? ' Â· ' : ''}
                          {sd.tl.sowStart ? `Sow ${formatDoy(sd.tl.sowStart)}` : ''}
                          {(sd.tl.indoorStart || sd.tl.sowStart) ? ' Â· ' : ''}
                          Bloom {formatDoy(sd.tl.bloomStart)}
                        </span>
                      </div>
                      {sd.companions && sd.companions.length > 0 && (
                        <div className="flex gap-2">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Companions</span>
                          <span className="font-bold" style={{ color: '#475569' }}>
                            {sd.companions.map((comp, i) => (
                              <React.Fragment key={i}>
                                {i > 0 && ', '}
                                <button
                                  onClick={() => { setSearchTerm(comp); window.scrollTo(0, 0); }}
                                  style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#6366f1', fontWeight: 700, textDecoration: 'underline', padding: 0 }}>
                                  {comp}
                                </button>
                              </React.Fragment>
                            ))}
                          </span>
                        </div>
                      )}
                      {sd.deerResistant && (
                        <div className="flex gap-2">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Deer</span>
                          <span className="font-bold" style={{ color: '#16a34a', fontSize: '11px' }}>ðŸ›¡ï¸ Resistant</span>
                        </div>
                      )}
                      {sd.soil && sd.soil !== 'any' && (
                        <div className="flex gap-2">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Soil</span>
                          <span className="capitalize font-bold" style={{ color: '#475569' }}>{sd.soil} pH</span>
                        </div>
                      )}
                      {sd.moisture && sd.moisture !== 'any' && (
                        <div className="flex gap-2">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Moisture</span>
                          <span className="capitalize font-bold" style={{ color: '#475569' }}>{sd.moisture}</span>
                        </div>
                      )}
                      {sd.pollinators && sd.pollinators.length > 0 && (
                        <div className="flex gap-2">
                          <span style={{ width: '90px', color: '#94a3b8', flexShrink: 0 }}>Pollinators</span>
                          <span style={{ fontSize: '12px' }}>
                            {sd.pollinators.includes('bee') && 'ðŸ '}
                            {sd.pollinators.includes('butterfly') && 'ðŸ¦‹ '}
                            {sd.pollinators.includes('hummingbird') && 'ðŸª¶ '}
                          </span>
                        </div>
                      )}
                  </div>}
                </div>
              </div>

              {/* Expanded: variety card grid */}
              {expandedSpecies[sd.species] && (
                <div style={{ borderTop: '1px solid ' + dm.border, backgroundColor: dm.altRow }} className="px-5 py-4">
                  <div className="grid gap-2" style={{ gridTemplateColumns: 'repeat(auto-fill, minmax(130px, 1fr))' }}>
                    {(filterMyGarden ? sd.varieties.filter(v => myGarden[sd.species + '||' + v.name]) : sd.varieties).map((v, i) => {
                      const inGarden = myGarden[sd.species + '||' + v.name];
                      return (
                      <div key={i}
                        onClick={() => setSelectedVariety({ ...v, species: sd.species, type: sd.type, germination: sd.germination, bloomDays: sd.bloomDays || [60,90], frostHardy: sd.frostHardy, sowMethod: sd.sowMethod, sowTiming: sd.sowTiming, sun: sd.sun, bloomColor: sd.bloomColor, height: sd.height, flag: sd.flag, zoneRange: sd.zoneRange, companions: sd.companions, bloomDuration: sd.bloomDuration, firstYearBloom: sd.firstYearBloom, tl: sd.tl })}
                        onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setSelectedVariety({ ...v, species: sd.species, type: sd.type, germination: sd.germination, bloomDays: sd.bloomDays || [60,90], frostHardy: sd.frostHardy, sowMethod: sd.sowMethod, sowTiming: sd.sowTiming, sun: sd.sun, bloomColor: sd.bloomColor, height: sd.height, flag: sd.flag, zoneRange: sd.zoneRange, companions: sd.companions, bloomDuration: sd.bloomDuration, firstYearBloom: sd.firstYearBloom, tl: sd.tl }); }}}
                        tabIndex={0}
                        role="button"
                        className="variety-chip cursor-pointer overflow-hidden relative"
                        style={{ border: inGarden ? '2px solid #6366f1' : '1px solid ' + dm.border, backgroundColor: dm.cardBg }}>
                        <button onClick={(e) => toggleGarden(sd.species, v.name, e)}
                          aria-label={inGarden ? 'Remove from garden' : 'Add to garden'}
                          title={inGarden ? 'Remove from My Garden plan' : 'Click to add to My Garden plan'}
                          className="absolute z-10 flex items-center justify-center"
                          style={{ top: '4px', right: '4px', width: '22px', height: '22px', backgroundColor: darkMode ? 'rgba(30,41,59,0.9)' : 'rgba(255,255,255,0.9)', border: '1px solid ' + dm.border, fontSize: '11px', cursor: 'pointer', lineHeight: 1 }}>
                          {inGarden ? 'â˜…' : 'â˜†'}
                        </button>
                        {gardenNotes[sd.species + '||' + v.name] && (
                          <span className="absolute z-10" style={{ top: '4px', left: '4px', fontSize: '10px' }} title="Has notes">ðŸ“</span>
                        )}
                        {v.img ? (
                          <div className="img-skeleton" style={{ width: '100%', height: '100px', position: 'relative' }}>
                            <img src={v.img} alt={v.name}
                              style={{ width: '100%', height: '100px', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }}
                              loading="lazy"
                              onLoad={(e) => { e.target.parentElement.classList.remove('img-skeleton'); }}
                              onError={(e) => { e.target.style.display='none'; e.target.parentElement.classList.remove('img-skeleton'); }} />
                          </div>
                        ) : (
                          <div className="flex items-center justify-center" style={{ width: '100%', height: '100px', backgroundColor: dm.altRow }}>
                            <span style={{ fontSize: '28px', color: '#cbd5e1' }}>&#10047;</span>
                          </div>
                        )}
                        <div style={{ padding: '6px 8px 7px' }}>
                          <a href={`https://www.rareseeds.com/catalogsearch/result/?q=${encodeURIComponent(v.name)}`} target="_blank" rel="noopener noreferrer" onClick={e => e.stopPropagation()} className="font-bold truncate block" style={{ fontSize: '10px', color: dm.text, textTransform: 'uppercase', letterSpacing: '0.3px', textDecoration: 'none' }} title={`View ${v.name} on Rareseeds.com`}>{v.name}</a>
                        </div>
                      </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
            </LazyCard>
            ))}
          </div>
        )}

        {filtered.length === 0 && (
          <div className="p-12 text-center" style={{ border: '1px solid ' + dm.border, backgroundColor: dm.cardBg, color: '#94a3b8' }}>
            {filterMyGarden && Object.keys(myGarden).length === 0 ? (
              <>
                <p style={{ fontSize: '32px', marginBottom: '8px' }}>&#9734;</p>
                <p className="text-lg font-medium mb-2" style={{ color: dm.text }}>Your garden is empty</p>
                <p className="text-sm mb-4" style={{ color: dm.textMuted }}>Star varieties to build your garden plan, or start with a preset:</p>
                <div className="flex flex-wrap gap-2 justify-center mb-4">
                  {[
                    { name: 'Pollinator Garden', species: ['Agastache', 'Bee Balm', 'Echinacea', 'Cosmos', 'Zinnia', 'Calendula'], icon: 'ðŸ' },
                    { name: 'Cut Flower Garden', species: ['Zinnia', 'Cosmos', 'Snapdragon', 'Stock', 'Bachelor\'s Button'], icon: 'ðŸ’' },
                    { name: 'Deer-Proof Garden', species: ['Lavender', 'Agastache', 'Yarrow', 'Foxglove', 'Salvia'], icon: 'ðŸ›¡' },
                  ].map(preset => (
                    <button key={preset.name} onClick={() => {
                      const newGarden = { ...myGarden };
                      preset.species.forEach(sp => {
                        const sd = speciesData.find(s => s.species === sp);
                        if (sd && sd.varieties.length > 0) newGarden[sp + '||' + sd.varieties[0].name] = true;
                      });
                      setMyGarden(newGarden);
                      setToastMsg(`Added ${preset.species.length} varieties from ${preset.name}`);
                      setTimeout(() => setToastMsg(null), 3000);
                    }}
                      style={{ fontSize: '12px', padding: '8px 16px', backgroundColor: dm.altRow, border: '1px solid ' + dm.border, borderRadius: '8px', cursor: 'pointer', color: dm.text, fontWeight: 600 }}>
                      <span style={{ marginRight: '4px' }}>{preset.icon}</span> {preset.name}
                    </button>
                  ))}
                </div>
                <button onClick={() => setFilterMyGarden(false)}
                  style={{ fontSize: '12px', color: '#6366f1', background: 'none', border: '1px solid #c7d2fe', padding: '6px 16px', borderRadius: '6px', cursor: 'pointer', fontWeight: 600 }}>
                  Browse all species
                </button>
              </>
            ) : (
              <>
                <p style={{ fontSize: '32px', marginBottom: '8px' }}>&#128270;</p>
                <p className="text-lg font-medium mb-1" style={{ color: dm.text }}>No matches</p>
                <p className="text-sm mb-3" style={{ color: dm.textMuted }}>Try adjusting your search or filters.</p>
                {searchTerm && (() => {
                  const term = searchTerm.toLowerCase();
                  const suggestions = speciesData
                    .map(sd => ({ name: sd.species, score: sd.species.toLowerCase().includes(term.slice(0, 3)) ? 1 : 0 }))
                    .filter(s => s.score > 0)
                    .slice(0, 3);
                  const varSuggestions = suggestions.length === 0
                    ? speciesData.flatMap(sd => sd.varieties.map(v => ({ name: v.name, species: sd.species })))
                        .filter(v => v.name.toLowerCase().includes(term.slice(0, 3)))
                        .slice(0, 3)
                    : [];
                  const allSugs = suggestions.length > 0
                    ? suggestions.map(s => ({ label: s.name, action: () => { setSearchTerm(s.name); } }))
                    : varSuggestions.map(v => ({ label: `${v.name} (${v.species})`, action: () => { setSearchTerm(v.species); } }));
                  return allSugs.length > 0 ? (
                    <div style={{ marginBottom: '12px' }}>
                      <p style={{ fontSize: '11px', color: dm.textFaint, marginBottom: '6px' }}>Did you mean:</p>
                      <div className="flex flex-wrap gap-2 justify-center">
                        {allSugs.map((s, i) => (
                          <button key={i} onClick={s.action}
                            style={{ fontSize: '12px', padding: '4px 12px', backgroundColor: darkMode ? '#312e81' : '#eef2ff', color: '#6366f1', border: '1px solid #c7d2fe', borderRadius: '6px', cursor: 'pointer', fontWeight: 600 }}>
                            {s.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  ) : null;
                })()}
                {hasActiveFilters && (
                  <button onClick={clearAllFilters}
                    style={{ fontSize: '12px', color: '#ef4444', background: 'none', border: '1px solid #fecaca', padding: '6px 16px', borderRadius: '6px', cursor: 'pointer', fontWeight: 600 }}>
                    Clear all filters
                  </button>
                )}
              </>
            )}
          </div>
        )}
      </main>

      {/* Detail Modal */}
      {selectedVariety && (
        <div className="fixed inset-0 flex items-center justify-center p-4 z-50 backdrop-enter" style={{ backgroundColor: 'rgba(0,0,0,0.3)' }} onClick={() => setSelectedVariety(null)}>
          <div className="max-w-lg w-full max-h-[90vh] overflow-y-auto modal-enter" style={{ backgroundColor: dm.cardBg, border: '1px solid ' + dm.border, boxShadow: '0 20px 60px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)', borderRadius: '12px', position: 'relative' }} onClick={e => e.stopPropagation()}>
            {/* Navigation arrows */}
            {(() => {
              const sd = speciesData.find(s => s.species === selectedVariety.species);
              if (!sd || sd.varieties.length <= 1) return null;
              const idx = sd.varieties.findIndex(v => v.name === selectedVariety.name);
              return (
                <>
                  <button onClick={(e) => {
                      e.stopPropagation();
                      const ni = (idx - 1 + sd.varieties.length) % sd.varieties.length;
                      const v = sd.varieties[ni];
                      setSelectedVariety({ ...v, species: sd.species, type: sd.type, germination: sd.germination, bloomDays: sd.bloomDays || [60,90], frostHardy: sd.frostHardy, sowMethod: sd.sowMethod, sowTiming: sd.sowTiming, sun: sd.sun, bloomColor: sd.bloomColor, height: sd.height, companions: sd.companions, flag: sd.flag, zoneRange: sd.zoneRange, bloomDuration: sd.bloomDuration, firstYearBloom: sd.firstYearBloom, tl: sd.tl });
                    }}
                    className="absolute top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center"
                    style={{ left: '-40px', backgroundColor: darkMode ? 'rgba(30,41,59,0.9)' : 'rgba(255,255,255,0.9)', border: '1px solid ' + dm.border, borderRadius: '50%', cursor: 'pointer', fontSize: '16px', color: '#64748b', zIndex: 51 }}>
                    â€¹
                  </button>
                  <button onClick={(e) => {
                      e.stopPropagation();
                      const ni = (idx + 1) % sd.varieties.length;
                      const v = sd.varieties[ni];
                      setSelectedVariety({ ...v, species: sd.species, type: sd.type, germination: sd.germination, bloomDays: sd.bloomDays || [60,90], frostHardy: sd.frostHardy, sowMethod: sd.sowMethod, sowTiming: sd.sowTiming, sun: sd.sun, bloomColor: sd.bloomColor, height: sd.height, companions: sd.companions, flag: sd.flag, zoneRange: sd.zoneRange, bloomDuration: sd.bloomDuration, firstYearBloom: sd.firstYearBloom, tl: sd.tl });
                    }}
                    className="absolute top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center"
                    style={{ right: '-40px', backgroundColor: darkMode ? 'rgba(30,41,59,0.9)' : 'rgba(255,255,255,0.9)', border: '1px solid ' + dm.border, borderRadius: '50%', cursor: 'pointer', fontSize: '16px', color: '#64748b', zIndex: 51 }}>
                    â€º
                  </button>
                </>
              );
            })()}
            {/* Modal header with image */}
            <div className="relative">
              {selectedVariety.img ? (
                <div>
                  <div className="img-skeleton" style={{ width: '100%', height: '160px' }}>
                    <img src={selectedVariety.img} alt={selectedVariety.name}
                      style={{ width: '100%', height: '160px', objectFit: 'cover', position: 'relative', zIndex: 1 }}
                      loading="lazy"
                      onLoad={(e) => { e.target.parentElement.classList.remove('img-skeleton'); }}
                      onError={(e) => { e.target.parentElement.style.display='none'; }} />
                  </div>
                  <div className="absolute inset-0" style={{ background: 'linear-gradient(to top, ' + (darkMode ? 'rgba(30,41,59,0.95)' : 'rgba(255,255,255,0.95)') + ' 0%, rgba(255,255,255,0.3) 50%, transparent 100%)' }} />
                </div>
              ) : (
                <div style={{ height: '64px', backgroundColor: dm.altRow, borderBottom: '1px solid ' + dm.border }} />
              )}
              <div className="absolute bottom-0 left-0 right-0 p-5">
                <h2 className="font-bold" style={{ fontSize: '18px', letterSpacing: '2px', textTransform: 'uppercase', color: dm.text }}>{selectedVariety.name}</h2>
          <button onClick={(e) => toggleGarden(selectedVariety.species, selectedVariety.name, e)}
            style={{ fontSize: '20px', cursor: 'pointer', background: 'none', border: 'none', color: dm.text }}>
            {myGarden[selectedVariety.species + '||' + selectedVariety.name] ? 'â˜…' : 'â˜†'}
          </button>
                <p className="text-sm" style={{ color: '#94a3b8' }}>{selectedVariety.species}</p>
              </div>
              <button onClick={() => setSelectedVariety(null)}
                aria-label="Close"
                className="absolute top-3 right-3 w-9 h-9 flex items-center justify-center text-lg font-bold"
                style={{ backgroundColor: dm.cardBg, color: dm.text, border: '1px solid ' + dm.border, borderRadius: '8px', transition: 'background 0.15s' }}
                onMouseEnter={(e) => e.target.style.backgroundColor=dm.altRow}
                onMouseLeave={(e) => e.target.style.backgroundColor=dm.cardBg}>&times;</button>
            </div>

            {/* Tab bar */}
            <div className="segment-group flex" style={{ margin: '0 20px', marginTop: '12px', border: '1px solid ' + dm.border }}>
              {['details', 'timeline', 'companions'].map(tab => (
                <button key={tab} onClick={() => setModalTab(tab)}
                  style={{ flex: 1, padding: '8px 0', fontSize: '11px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', cursor: 'pointer',
                    backgroundColor: modalTab === tab ? '#6366f1' : dm.chipBg,
                    color: modalTab === tab ? '#fff' : dm.textMuted,
                    border: 'none' }}>
                  {tab === 'details' ? 'Details' : tab === 'timeline' ? 'Timeline' : 'Companions'}
                </button>
              ))}
            </div>

            <div className="p-5 space-y-4">
              {/* Navigation hint */}
              {(() => {
                const sd = speciesData.find(s => s.species === selectedVariety.species);
                if (!sd || sd.varieties.length <= 1) return null;
                const idx = sd.varieties.findIndex(v => v.name === selectedVariety.name);
                return (
                  <div style={{ textAlign: 'center', paddingBottom: '4px' }}>
                    <span style={{ fontSize: '11px', color: '#94a3b8' }}>{idx + 1} of {sd.varieties.length} varieties</span>
                    <span style={{ fontSize: '10px', color: darkMode ? '#818cf8' : '#c7d2fe', marginLeft: '8px', backgroundColor: darkMode ? '#312e81' : '#eef2ff', padding: '2px 8px', borderRadius: '4px' }}>keys to browse</span>
                  </div>
                );
              })()}

              {/* DETAILS TAB */}
              {modalTab === 'details' && (
                <>
                  <div className="grid grid-cols-3 gap-2">
                    {[
                      { label: 'Type', value: selectedVariety.type, capitalize: true },
                      { label: 'Frost Hardy', value: selectedVariety.frostHardy ? 'Yes' : 'No' },
                      { label: 'Sun', value: selectedVariety.sun ? `${selectedVariety.sun[0]}â€“${selectedVariety.sun[1]}hr` : 'Full' },
                      { label: 'Height', value: HEIGHT_LABELS[selectedVariety.height] || '?' },
                      { label: 'Spacing', value: SPACING_DATA[selectedVariety.height]?.label || '?' },
                      { label: 'Germination', value: `${selectedVariety.germination[0]}â€“${selectedVariety.germination[1]}d` },
                      { label: 'Days to Bloom', value: `${selectedVariety.bloomDays[0]}â€“${selectedVariety.bloomDays[1]}d` },
                      { label: 'Sowing', value: selectedVariety.sowMethod.map(m => m === 'startIndoors' ? 'Indoor' : 'Direct').join(' / ') }
                    ].map((item, idx) => (
                      <div key={idx} className="text-center" style={{ backgroundColor: dm.altRow, border: '1px solid ' + dm.border, padding: '12px 8px', borderRadius: '6px' }}>
                        <p style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 400, letterSpacing: '0.1em', marginBottom: '2px', textTransform: 'uppercase' }}>{item.label}</p>
                        <p className={`font-bold tabular-nums ${item.capitalize ? 'capitalize' : ''}`} style={{ fontSize: '12px', color: dm.text }}>{item.value}</p>
                      </div>
                    ))}
                  </div>

                  <div style={{ backgroundColor: dm.altRow, padding: '12px 14px', border: '1px solid ' + dm.border, borderRadius: '6px' }}>
                    <p style={{ fontSize: '12px', color: dm.textMuted, lineHeight: 1.5 }}>{selectedVariety.sowTiming}</p>
                  </div>

                  {selectedVariety.type === 'perennial' && selectedVariety.firstYearBloom === false && (
                    <div style={{ backgroundColor: '#fffbeb', border: '1px solid #fde68a', borderRadius: '6px', padding: '8px 12px', fontSize: '12px', color: '#92400e' }}>
                      Perennial may not bloom first year from seed. Plan for establishment.
                    </div>
                  )}

                  {selectedVariety.type === 'annual' && selectedVariety.sowMethod.includes('directSow') && selectedVariety.bloomDuration && selectedVariety.bloomDuration <= 45 && (
                    <div style={{ backgroundColor: '#f0fdf4', border: '1px solid #bbf7d0', borderRadius: '6px', padding: '8px 12px', fontSize: '12px', color: '#15803d', fontWeight: 600 }}>
                      <span>Succession sow every 2-3 weeks:</span>
                      <div className="flex flex-wrap gap-1 mt-1">
                        {(() => {
                          const dates = [];
                          const start = selectedVariety.tl.sowStart;
                          const end = selectedVariety.tl.sowEnd || (start + 42);
                          for (let d = start; d <= end; d += 14) dates.push(d);
                          return dates.map((d, i) => (
                            <span key={i} style={{ backgroundColor: '#f0fdf4', border: '1px solid #86efac', padding: '1px 6px', borderRadius: '3px', fontSize: '10px' }}>{formatDoy(d)}</span>
                          ));
                        })()}
                      </div>
                    </div>
                  )}

                  {selectedVariety.flag && (
                    <div style={{ backgroundColor: dm.altRow, padding: '12px 14px', border: '1px solid ' + dm.border, borderRadius: '6px' }}>
                      <p style={{ fontSize: '12px', color: dm.textMuted }}>&#9888; {selectedVariety.flag}</p>
                    </div>
                  )}

                  {myGarden[selectedVariety.species + '||' + selectedVariety.name] && (
                    <div>
                      <p style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '4px' }}>Notes</p>
                      <textarea
                        value={gardenNotes[selectedVariety.species + '||' + selectedVariety.name] || ''}
                        onChange={(e) => setGardenNotes(prev => ({ ...prev, [selectedVariety.species + '||' + selectedVariety.name]: e.target.value }))}
                        placeholder="Add planting notes, location, quantity..."
                        rows={3}
                        style={{ width: '100%', fontSize: '12px', padding: '8px 10px', border: '1px solid ' + dm.border, borderRadius: '6px', resize: 'vertical', fontFamily: 'Inter, sans-serif', color: dm.text, backgroundColor: dm.altRow }}
                      />
                    </div>
                  )}
                </>
              )}

              {/* TIMELINE TAB */}
              {modalTab === 'timeline' && (
                <>
                  <div>
                    <p className="font-bold mb-2.5" style={{ fontSize: '12px', color: dm.text, letterSpacing: '2px', textTransform: 'uppercase' }}>Timeline</p>
                    <div className="space-y-2">
                      {[
                        selectedVariety.tl.indoorStart && { phase: 'indoor', label: 'Start indoors', date: formatDoy(selectedVariety.tl.indoorStart) },
                        selectedVariety.tl.hardenStart && { phase: 'harden', label: 'Harden off', date: formatDoy(selectedVariety.tl.hardenStart) },
                        selectedVariety.tl.transplant && { phase: 'transplant', label: 'Transplant', date: formatDoy(selectedVariety.tl.transplant) },
                        selectedVariety.tl.sowStart && { phase: 'sow', label: 'Direct sow', date: `${formatDoy(selectedVariety.tl.sowStart)} â€“ ${formatDoy(selectedVariety.tl.sowEnd)}` },
                        { phase: 'germination', label: 'Germination', date: formatDoy(selectedVariety.tl.germEnd) },
                        { phase: 'bloom', label: 'First bloom', date: formatDoy(selectedVariety.tl.bloomStart) },
                        { phase: 'decline', label: selectedVariety.type === 'annual' ? 'Frost kill' : 'Dormancy', date: formatDoy(selectedVariety.tl.seasonEnd) }
                      ].filter(Boolean).map((item, idx) => (
                        <div key={idx} className="flex items-center gap-2.5" style={{ fontSize: '13px' }}>
                          <span className="inline-block w-2 h-2 shrink-0" style={{ backgroundColor: PHASE_COLORS[item.phase].bg }} />
                          <span style={{ color: '#94a3b8', width: '110px' }}>{item.label}</span>
                          <span className="font-bold tabular-nums" style={{ color: dm.text }}>{item.date}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div>
                    <p style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 400, marginBottom: '6px', letterSpacing: '0.1em', textTransform: 'uppercase' }}>Full year</p>
                    <YearBar tl={selectedVariety.tl} height={16} showGridlines={false} bloomColor={selectedVariety.bloomColor} />
                    <div className="flex justify-between mt-1" style={{ fontSize: '10px', color: '#94a3b8' }}>
                      {MONTHS.map(m => <span key={m}>{m[0]}</span>)}
                    </div>
                  </div>
                </>
              )}

              {/* COMPANIONS TAB */}
              {modalTab === 'companions' && (
                <>
                  {selectedVariety.companions && selectedVariety.companions.length > 0 ? (
                    <div>
                      <p style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '8px' }}>Companion Plants</p>
                      <div className="flex flex-wrap gap-2">
                        {selectedVariety.companions.map((comp, i) => {
                          const compSd = speciesData.find(s => s.species === comp);
                          return (
                            <button key={i} onClick={() => { setSelectedVariety(null); setSearchTerm(comp); window.scrollTo(0, 0); }}
                              style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 14px', backgroundColor: dm.altRow, border: '1px solid ' + dm.border, borderRadius: '8px', cursor: 'pointer', fontSize: '12px', fontWeight: 700, color: '#6366f1' }}>
                              {compSd && compSd.bloomColor && <span style={{ width: 10, height: 10, borderRadius: '50%', backgroundColor: compSd.bloomColor, border: '1px solid rgba(0,0,0,0.1)' }} />}
                              {comp}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  ) : (
                    <p style={{ fontSize: '13px', color: dm.textMuted, textAlign: 'center', padding: '20px 0' }}>No companion data available for this species.</p>
                  )}
                  {/* Related species with similar bloom times */}
                  <div>
                    <p style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '8px', marginTop: '8px' }}>Blooms at the Same Time</p>
                    <div className="flex flex-wrap gap-2">
                      {speciesData
                        .filter(sd => sd.species !== selectedVariety.species && Math.abs(sd.tl.bloomStart - selectedVariety.tl.bloomStart) < 21)
                        .slice(0, 5)
                        .map(sd => (
                          <button key={sd.species} onClick={() => { setSelectedVariety(null); setSearchTerm(sd.species); window.scrollTo(0, 0); }}
                            style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', backgroundColor: dm.altRow, border: '1px solid ' + dm.border, borderRadius: '6px', cursor: 'pointer', fontSize: '11px', fontWeight: 600, color: dm.text }}>
                            {sd.bloomColor && <span style={{ width: 8, height: 8, borderRadius: '50%', backgroundColor: sd.bloomColor }} />}
                            {sd.species}
                            <span style={{ fontSize: '10px', color: '#94a3b8' }}>Bloom {formatDoy(sd.tl.bloomStart)}</span>
                          </button>
                        ))}
                    </div>
                  </div>
                </>
              )}

              <a href={selectedVariety.url} target="_blank" rel="noopener noreferrer"
                className="flex items-center justify-center gap-2 font-bold w-full uppercase"
                style={{ backgroundColor: '#1e293b', color: '#fff', padding: '12px', fontSize: '12px', transition: 'all 0.15s', textDecoration: 'none', letterSpacing: '2px', border: '2px solid #1e293b' }}
                onMouseEnter={(e) => { e.target.style.backgroundColor='#334155'; }}
                onMouseLeave={(e) => { e.target.style.backgroundColor='#1e293b'; }}>
                Buy on rareseeds.com <ExternalLink size={14} />
              </a>
            </div>
          </div>
        </div>
      )}

      {viewMode === 'list' && sortedFiltered.length > 5 && (
        <div className="fixed z-30" style={{ bottom: Object.keys(myGarden).length > 0 && !footerDismissed && !filterMyGarden ? '60px' : '20px', right: '20px', transition: 'bottom 0.2s ease' }}>
          <select
            onChange={(e) => {
              if (!e.target.value) return;
              setExpandedSpecies(prev => ({ ...prev, [e.target.value]: true }));
              const el = document.querySelector(`[data-species="${e.target.value}"]`);
              if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
              e.target.value = '';
            }}
            style={{ backgroundColor: '#1e293b', color: '#fff', border: 'none', padding: '10px 14px', borderRadius: '8px', fontSize: '12px', fontWeight: 700, cursor: 'pointer', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', letterSpacing: '0.5px' }}>
            <option value="">Jump to...</option>
            {sortedFiltered.map(sd => (
              <option key={sd.species} value={sd.species}>{sd.species}</option>
            ))}
          </select>
        </div>
      )}

      <button onClick={() => setShowShortcuts(!showShortcuts)}
        style={{ position: 'fixed', bottom: Object.keys(myGarden).length > 0 && !footerDismissed && viewMode === 'list' && !filterMyGarden ? '60px' : '20px', left: '20px', zIndex: 30, width: '32px', height: '32px', borderRadius: '50%', backgroundColor: dm.text, color: dm.cardBg, border: 'none', fontSize: '14px', fontWeight: 700, cursor: 'pointer', boxShadow: '0 2px 8px rgba(0,0,0,0.15)', transition: 'bottom 0.2s ease' }}>
        ?
      </button>

      {showShortcuts && (
        <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0,0,0,0.3)' }} onClick={() => setShowShortcuts(false)}>
          <div style={{ backgroundColor: dm.cardBg, borderRadius: '12px', padding: '24px', maxWidth: '360px', boxShadow: '0 20px 60px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
            <h3 style={{ fontSize: '14px', fontWeight: 700, marginBottom: '16px', color: dm.text, textTransform: 'uppercase', letterSpacing: '2px' }}>Keyboard Shortcuts</h3>
            <div style={{ fontSize: '13px', lineHeight: 2, color: dm.textMuted }}>
              {[
                ['j / â†“', 'Next species card'],
                ['k / â†‘', 'Previous species card'],
                ['Enter', 'Expand/collapse focused card'],
                ['?', 'Toggle this help'],
                ['â† â†’', 'Browse varieties in modal'],
                ['Esc', 'Close modal or overlay'],
              ].map(([key, desc], i) => (
                <div key={i} className="flex gap-3">
                  <kbd style={{ fontFamily: 'monospace', backgroundColor: dm.altRow, padding: '2px 8px', borderRadius: '4px', border: '1px solid ' + dm.border, fontSize: '12px', fontWeight: 700, minWidth: '40px', textAlign: 'center', color: dm.text }}>{key}</kbd>
                  <span>{desc}</span>
                </div>
              ))}
            </div>
            <button onClick={() => setShowShortcuts(false)} style={{ marginTop: '16px', fontSize: '12px', color: dm.textFaint, background: 'none', border: 'none', cursor: 'pointer' }}>Close</button>
          </div>
        </div>
      )}

      {/* Sticky Garden Summary Footer Bar */}
      {Object.keys(myGarden).length > 0 && !footerDismissed && viewMode === 'list' && !filterMyGarden && (
        <div className="fixed bottom-0 left-0 right-0 z-20" style={{ backgroundColor: dm.headerBg, borderTop: '2px solid #6366f1', padding: '8px 20px', display: 'flex', alignItems: 'center', gap: '12px', fontSize: '12px', boxShadow: '0 -4px 12px rgba(0,0,0,0.1)' }}>
          <span style={{ fontWeight: 700, color: '#6366f1' }}>{Object.keys(myGarden).length} saved</span>
          {(() => {
            const gardenSpecies = [...new Set(Object.keys(myGarden).map(k => k.split('||')[0]))];
            const nextAction = gardenSpecies.map(sp => {
              const sd = speciesData.find(s => s.species === sp);
              if (!sd) return null;
              const cd = getCountdown(sd.tl, todayDoy);
              return cd ? { species: sp, ...cd } : null;
            }).filter(Boolean).sort((a, b) => a.days - b.days)[0];
            return nextAction ? (
              <span style={{ color: dm.textMuted }}>Next: <strong style={{ color: '#f59e0b' }}>{nextAction.label}</strong> {nextAction.species} in {nextAction.days}d</span>
            ) : null;
          })()}
          <span style={{ flex: 1 }} />
          <button onClick={() => { setFilterMyGarden(true); window.scrollTo(0, 0); }}
            style={{ fontSize: '11px', fontWeight: 700, color: '#fff', backgroundColor: '#6366f1', border: 'none', borderRadius: '6px', padding: '6px 14px', cursor: 'pointer' }}>
            View Garden
          </button>
          <button onClick={() => setFooterDismissed(true)}
            style={{ background: 'none', border: 'none', color: dm.textFaint, cursor: 'pointer', fontSize: '14px', padding: '4px' }}>&times;</button>
        </div>
      )}

      {/* Garden Presets Popover */}
      {showPresets && (
        <div className="fixed inset-0 z-50" style={{ backgroundColor: 'rgba(0,0,0,0.3)' }} onClick={() => setShowPresets(false)}>
          <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: '340px', backgroundColor: dm.cardBg, borderRadius: '12px', padding: '20px', boxShadow: '0 20px 60px rgba(0,0,0,0.2)', border: '1px solid ' + dm.border }} onClick={e => e.stopPropagation()}>
            <h3 style={{ fontSize: '14px', fontWeight: 700, color: dm.text, textTransform: 'uppercase', letterSpacing: '2px', marginBottom: '16px' }}>Garden Ideas</h3>
            <div className="space-y-3">
              {[
                { name: 'Pollinator Paradise', icon: 'ðŸ', species: ['Agastache', 'Bee Balm', 'Echinacea', 'Cosmos', 'Zinnia', 'Calendula'] },
                { name: 'Cut Flower Bouquets', icon: 'ðŸ’', species: ['Zinnia', 'Cosmos', 'Snapdragon', 'Stock', 'Bachelor\'s Button'] },
                { name: 'Shade Tolerant', icon: 'ðŸŒ¿', species: ['Foxglove', 'Columbine', 'Bleeding Heart', 'Forget-Me-Not'] },
                { name: 'Continuous Bloom', icon: 'ðŸŒ¸', species: ['Calendula', 'Cosmos', 'Zinnia', 'Marigold', 'Snapdragon', 'Aster'] },
              ].map(preset => (
                <div key={preset.name} style={{ padding: '12px', backgroundColor: dm.altRow, borderRadius: '8px', border: '1px solid ' + dm.border }}>
                  <div className="flex items-center justify-between mb-2">
                    <span style={{ fontWeight: 700, fontSize: '13px', color: dm.text }}><span style={{ marginRight: '6px' }}>{preset.icon}</span>{preset.name}</span>
                    <button onClick={() => {
                      const newGarden = { ...myGarden };
                      let added = 0;
                      preset.species.forEach(sp => {
                        const sd = speciesData.find(s => s.species === sp);
                        if (sd && sd.varieties.length > 0 && !newGarden[sp + '||' + sd.varieties[0].name]) {
                          newGarden[sp + '||' + sd.varieties[0].name] = true;
                          added++;
                        }
                      });
                      setMyGarden(newGarden);
                      setShowPresets(false);
                      setToastMsg(`Added ${added} varieties from ${preset.name}`);
                      setTimeout(() => setToastMsg(null), 3000);
                    }}
                      style={{ fontSize: '11px', fontWeight: 700, color: '#fff', backgroundColor: '#6366f1', border: 'none', borderRadius: '6px', padding: '5px 12px', cursor: 'pointer' }}>
                      Add all
                    </button>
                  </div>
                  <p style={{ fontSize: '11px', color: dm.textMuted }}>{preset.species.join(', ')}</p>
                </div>
              ))}
            </div>
            <button onClick={() => setShowPresets(false)} style={{ marginTop: '12px', fontSize: '12px', color: dm.textFaint, background: 'none', border: 'none', cursor: 'pointer', width: '100%', textAlign: 'center' }}>Close</button>
          </div>
        </div>
      )}

      {/* Toast notification */}
      {toastMsg && (
        <div className="fixed z-50" style={{ bottom: '80px', left: '50%', transform: 'translateX(-50%)', backgroundColor: '#1e293b', color: '#fff', padding: '10px 20px', borderRadius: '8px', fontSize: '13px', fontWeight: 600, boxShadow: '0 8px 24px rgba(0,0,0,0.2)', animation: 'modalIn 0.2s ease-out' }}>
          {toastMsg}
        </div>
      )}

      {/* Footer */}
      <footer style={{ backgroundColor: '#1e293b', color: '#94a3b8', padding: '24px 20px', marginTop: '40px', textAlign: 'center', fontSize: '12px', lineHeight: '1.8', marginBottom: Object.keys(myGarden).length > 0 && !footerDismissed && viewMode === 'list' && !filterMyGarden ? '44px' : 0 }}>
        <p style={{ fontWeight: 600, color: '#e2e8f0', marginBottom: '4px' }}>Verdant Atlas</p>
        <p>USDA Zone 5b Â· Last frost ~May 15 Â· First frost ~Oct 1</p>
        <p style={{ marginTop: '8px' }}>Seed data sourced from <a href="https://www.rareseeds.com" target="_blank" rel="noopener noreferrer" style={{ color: '#818cf8', textDecoration: 'underline' }}>Baker Creek Heirloom Seeds</a>. Dates are estimates for Midcoast Maine (Zone 5b).</p>
      </footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<PlantingCalendar />);
    </script>

<script>
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE_NAME = 'garden-planner-v1';
    const ASSETS = ['/verdant-atlas/'];
    self.addEventListener('install', e => {
      e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS)));
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request).then(resp => {
          if (resp.ok && e.request.url.includes('cloudinary')) {
            const clone = resp.clone();
            caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
          }
          return resp;
        }).catch(() => caches.match('/verdant-atlas/')))
      );
    });
  `;
  const blob = new Blob([swCode], { type: 'application/javascript' });
  navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
}
</script>
</body>
</html>
